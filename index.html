<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Corrections</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        /* ===== RTL SUPPORT COMPLET ET OPTIMIS√â ===== */
        .rtl-layout {
            direction: rtl;
            text-align: right;
        }

        /* ===== FLEX & LAYOUT G√âN√âRAUX ===== */
        .rtl-layout .flex {
            flex-direction: row-reverse;
        }

        .rtl-layout .justify-between {
            justify-content: space-between;
        }

        .rtl-layout .flex-wrap {
            flex-direction: row-reverse;
        }

        /* ===== MARGINS INVERS√âS ===== */
        .rtl-layout .ml-auto {
            margin-left: 0 !important;
            margin-right: auto !important;
        }

        .rtl-layout .ml-2 {
            margin-left: 0 !important;
            margin-right: 0.5rem !important;
        }

        .rtl-layout .ml-3 {
            margin-left: 0 !important;
            margin-right: 0.75rem !important;
        }

        .rtl-layout .ml-4 {
            margin-left: 0 !important;
            margin-right: 1rem !important;
        }

        .rtl-layout .mr-2 {
            margin-right: 0 !important;
            margin-left: 0.5rem !important;
        }

        .rtl-layout .mr-3 {
            margin-right: 0 !important;
            margin-left: 0.75rem !important;
        }

        .rtl-layout .mr-auto {
            margin-right: auto !important;
            margin-left: 0 !important;
        }

        /* ===== TEXT ALIGNMENT ===== */
        .rtl-layout .text-left {
            text-align: right !important;
        }

        .rtl-layout .text-right {
            text-align: left !important;
        }

        /* ===== BORDERS & PADDING ===== */
        .rtl-layout .border-l {
            border-left: none !important;
            border-right: 1px solid !important;
        }

        .rtl-layout .border-l-4 {
            border-left: none !important;
            border-right: 4px solid !important;
        }

        .rtl-layout .pl-2 {
            padding-left: 0 !important;
            padding-right: 0.5rem !important;
        }

        /* ===== √âL√àVES - LISTE PRINCIPALE ===== */
        .rtl-layout #students-list>div {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .rtl-layout #students-list .flex {
            flex-direction: row-reverse !important;
        }

        .rtl-layout #students-list button {
            order: 1 !important;
        }

        .rtl-layout #students-list .font-medium {
            order: 2 !important;
        }

        .rtl-layout #students-list .text-gray-400 {
            order: 3 !important;
            margin-right: 0.75rem !important;
        }

        /* ===== EN-T√äTE √âL√àVES ===== */
        .rtl-layout #content-students .flex.justify-between {
            flex-direction: row-reverse !important;
        }

        .rtl-layout #content-students .flex.justify-between>div:first-child {
            order: 2 !important;
        }

        .rtl-layout #content-students .flex.justify-between>div:last-child {
            order: 1 !important;
        }

        /* ===== CLASSES - FIX COMPLET ===== */
        .rtl-layout #class-list {
            display: flex !important;
            flex-wrap: wrap !important;
            flex-direction: row-reverse !important;
            justify-content: flex-end !important;
            gap: 0.5rem !important;
        }

        .rtl-layout #class-list>* {
            order: unset !important;
        }

        /* Annule les r√®gles g√©n√©rales .flex qui interf√®rent */
        .rtl-layout .flex.flex-wrap.gap-2:has(#class-list) {
            flex-direction: row-reverse !important;
            justify-content: flex-end !important;
        }

        /* Force sur les conteneurs directs */
        #class-list.flex {
            display: flex !important;
        }

        /* En LTR (fran√ßais/anglais), laisse la flexbox normale */
        .ltr-layout #class-list {
            flex-direction: row;
            justify-content: flex-start;
        }


        /* ===== EXERCICES DES DEVOIRS - COMPL√àT ===== */
        .rtl-layout [id*="exercise"],
        .rtl-layout [id*="exercises"],
        .rtl-layout .exercise,
        .rtl-layout .exercice,
        .rtl-layout .exercise-item,
        .rtl-layout .hw-exercise {
            direction: rtl !important;
        }

        /* Tous les conteneurs exercices */
        .rtl-layout .exercises-list,
        .rtl-layout #exercises-list,
        .rtl-layout #homework-exercises,
        .rtl-layout #exercises-container,
        .rtl-layout #homework-exercises-list {
            flex-direction: row-reverse !important;
        }

        /* ACTIONS/IC√îNES TOUJOURS √Ä GAUCHE */
        .rtl-layout .exercise-actions,
        .rtl-layout .exercise-item button,
        .rtl-layout .delete-exercise-btn,
        .rtl-layout .edit-exercise-btn,
        .rtl-layout .btn-delete-exercise,
        .rtl-layout .btn-edit-exercise {
            order: 1 !important;
            margin-right: 0 !important;
            margin-left: 0.75rem !important;
        }

        /* CONTENU EXERCICE √Ä DROITE */
        .rtl-layout .exercise-info,
        .rtl-layout .exercise-content,
        .rtl-layout .exercise-details,
        .rtl-layout .exercise-name {
            order: 2 !important;
            text-align: right !important;
        }

        /* MODALES EXERCICES SP√âCIFIQUES */
        .rtl-layout #exercises-container .flex,
        .rtl-layout #homework-exercises-list .flex,
        .rtl-layout .exercise-item .flex {
            flex-direction: row-reverse !important;
            justify-content: space-between !important;
        }

        /* ===== TABLEAUX ===== */
        .rtl-layout table th,
        .rtl-layout table td {
            text-align: right !important;
        }

        .rtl-layout table .sticky.left-0 {
            left: auto !important;
            right: 0 !important;
        }

        /* ===== MODALES & UI ===== */
        .modal {
            display: none;
        }

        .modal.active {
            display: flex !important;
        }

        /* ===== ACCORD√âON ===== */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.open {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .rotate-icon {
            transition: transform 0.3s ease;
        }

        .rotate-icon.open {
            transform: rotate(180deg);
        }

        /* ===== NOTES - GRILLE ===== */
        .grade-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }

        .grade-question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
        }

        .grade-question-card {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 130px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .question-title {
            font-weight: 700;
            color: #166534;
            font-size: 1rem;
        }

        .question-score {
            font-size: 0.9rem;
            font-weight: 600;
            color: #15803d;
            background: #ffffff;
            border-radius: 9999px;
            padding: 0.15rem 0.75rem;
            border: 1px solid #bbf7d0;
        }

        .question-direct-entry {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-direct-entry .grade-input {
            flex: 1;
            min-width: 0;
        }

        .question-max {
            font-size: 0.85rem;
            color: #4b5563;
            font-weight: 500;
        }

        .subquestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 0.6rem;
        }

        .subquestion-chip {
            background: #ffffff;
            border: 1px solid #fecdd3;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .subquestion-chip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 0.85rem;
            color: #c2410c;
        }

        .subquestion-chip .grade-input {
            width: 100%;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .rtl-layout #students-list .flex {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 1rem !important;
            }

            .rtl-layout #students-list button {
                align-self: flex-start !important;
                order: 1 !important;
            }

            .rtl-layout .flex-wrap {
                flex-direction: row-reverse !important;
            }
        }

        /* ===== R√âAJUSTEMENTS RTL SP√âCIFIQUES ===== */
        /* 1. Titre principal et header √† droite en RTL */
        .rtl-layout header .flex>div:first-child {
            order: 2 !important;
            /* Pousse le titre √† droite */
            text-align: right !important;
            margin-left: auto !important;
            margin-right: 0 !important;
        }

        .rtl-layout header .flex>div:last-child {
            order: 1 !important;
            /* Boutons langues √† gauche */
        }

        .rtl-layout header h1,
        .rtl-layout header p {
            text-align: right !important;
        }

        /* 2. Boutons tabs : Ordre √âl√®ves (droite) ‚Üí Devoirs ‚Üí Notes ‚Üí R√©cap (gauche) */
        .rtl-layout .flex.flex-wrap.gap-2.mb-6 {
            /* Cible pr√©cis le conteneur des tabs */
            justify-content: flex-end !important;
            /* Bloc pouss√© √† droite */
            flex-direction: row !important;
            /* Flux naturel RTL : droite-gauche, garde ordre HTML */
            gap: 0.5rem !important;
            /* Espace uniforme */
        }

        /* 3. Ic√¥nes actions dans cartes Devoirs √† gauche en RTL */
        .rtl-layout .flex.items-center.justify-between[onclick*="toggleAccordion"] {
            flex-direction: row-reverse !important;
            /* Inverse pour RTL */
        }

        .rtl-layout .flex.items-center.justify-between[onclick*="toggleAccordion"]>div:first-child {
            order: 2 !important;
            /* Contenu (ic√¥ne + titre) √† droite */
            text-align: right !important;
        }

        .rtl-layout .flex.items-center.justify-between[onclick*="toggleAccordion"]>div:last-child {
            order: 1 !important;
            /* Actions (boutons) √† gauche */
            margin-left: 0.75rem !important;
            /* Espace √† droite du contenu */
        }

        /* Extension pour tous les titres (h1-h6) en RTL */
        .rtl-layout h1,
        .rtl-layout h2,
        .rtl-layout h3,
        .rtl-layout h4,
        .rtl-layout h5,
        .rtl-layout h6 {
            text-align: right !important;
            margin-left: auto !important;
            margin-right: 0 !important;
        }

        /* Ajustement g√©n√©ral flex en RTL (√©vite double-inversion) */
        .rtl-layout .flex {
            flex-direction: row !important;
            /* Naturel en RTL */
        }

        /* Pour headers de sections (ex. dans devoirs, notes) : Inverser ordre */
        .rtl-layout .flex.justify-between {
            flex-direction: row-reverse !important;
            justify-content: space-between !important;
        }

        .rtl-layout .flex.justify-between>*:first-child {
            order: 2 !important;
            /* Titre √† droite */
        }

        .rtl-layout .flex.justify-between>*:last-child {
            order: 1 !important;
            /* Boutons/ajouts √† gauche */
        }

        .rtl-layout .flex.flex-wrap.gap-2.mb-6 {
            /* Cible le conteneur des tabs */
            justify-content: flex-start !important;
            /* D√©but du flux RTL : √† droite */
            flex-direction: row !important;
            /* Flux naturel RTL : droite-gauche, garde ordre HTML */
            text-align: start !important;
            /* Renforce alignement RTL */
            gap: 0.5rem !important;
            /* Espace uniforme */
            margin-left: auto !important;
            /* Pousse tout le bloc √† droite si besoin */
            margin-right: 0 !important;
        }

        /* Liste d'√©l√®ves compacte en grille */
        #students-list.student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 0.75rem;
        }

        #students-list.student-grid .student-item {
            position: relative;
            display: flex !important;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.9rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            transition: transform 0.08s ease, box-shadow 0.12s ease;
        }

        #students-list.student-grid .student-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
        }

        .student-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Badge niveau (remplace l‚Äôavatar) */
        .student-level {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            color: #fff;
            font-weight: 800;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        /* Variantes gar√ßon/fille */
        .student-level.boy {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
        }

        .student-level.girl {
            background: linear-gradient(135deg, #ec4899, #d946ef);
        }

        .student-level.neutral {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .student-info {
            flex: 1;
            min-width: 0;
        }

        .student-name {
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        .student-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 12px;
        }

        .student-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            background: #e0f2fe;
            color: #075985;
            border: 1px solid #bfdbfe;
            white-space: nowrap;
        }

        .student-chip.gray {
            background: #f3f4f6;
            color: #374151;
            border-color: #e5e7eb;
        }

        .student-chip.birth {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }

        .student-index {
            font-size: 12px;
            color: #6b7280;
        }

        .student-actions {
            opacity: 0;
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 0.25rem;
        }

        .student-item:hover .student-actions {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .rtl-layout .student-actions {
            right: auto;
            left: 8px;
        }

        .student-actions button {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: #fee2e2;
            color: #b91c1c;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.12s ease, transform 0.08s ease;
        }

        .student-actions button:hover {
            background: #fecdd3;
            transform: translateY(-1px);
        }

        /* RTL ajustements */
        .rtl-layout #students-list.student-grid .student-item {
            flex-direction: row-reverse !important;
        }

        .rtl-layout #students-list.student-grid .student-meta {
            justify-content: flex-end;
        }

        /* SEULE LA VERSION QUI MARCHE */
        .rtl-layout #class-list {
            display: flex !important;
            flex-direction: row-reverse !important;
            flex-wrap: wrap !important;
            justify-content: flex-end !important;
            gap: 0.5rem !important;
        }


        /* Annule les styles qui posaient probl√®me */
        .rtl-layout #class-list .inline-flex {
            display: inline-flex !important;
            flex-direction: row-reverse !important;
        }

        .rtl-layout #class-list>* {
            order: unset !important;
            margin-left: 0 !important;
            margin-right: auto !important;
        }

        /* ===== NUCLEAR OPTION - CLASSES RTL ===== */
        html[dir="rtl"] #class-list,
        html[dir="rtl"] .rtl-layout #class-list,
        .rtl-layout #class-list {
            display: flex !important;
            flex-wrap: wrap !important;
            flex-direction: row-reverse !important;
            justify-content: flex-end !important;
            align-items: flex-start !important;
            gap: 0.5rem !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        html[dir="rtl"] #class-list>div,
        .rtl-layout #class-list>div {
            flex-basis: auto !important;
            order: unset !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Annule TOUS les autres flex qui pourraient interferer */
        html[dir="rtl"] #class-list.flex,
        .rtl-layout #class-list.flex {
            flex-direction: row-reverse !important;
            justify-content: flex-end !important;
        }

        .summary-grade-input {
            width: 64px;
            padding: 4px 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #ffffff;
            -moz-appearance: textfield;
        }

        .summary-grade-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #bfdbfe;
            border-color: #60a5fa;
        }

        .summary-grade-input::-webkit-outer-spin-button,
        .summary-grade-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .assignment-tag {
            padding: 0.25rem 0.6rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-size: 12px;
            background: #f3f4f6;
            color: #374151;
        }

        .assignment-tag.selected {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 rounded-xl shadow-lg mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">üìù Gestion des Corrections</h1>
                    <p class="text-blue-100 mt-2">G√©rez vos √©l√®ves, devoirs et notes en toute simplicit√©</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="changeLanguage('fr')"
                        class="lang-btn px-3 py-1 rounded-lg font-semibold transition-all bg-white text-blue-600">
                        FR
                    </button>
                    <button onclick="changeLanguage('en')"
                        class="lang-btn px-3 py-1 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                        EN
                    </button>
                    <button onclick="changeLanguage('ar')"
                        class="lang-btn px-3 py-1 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                        AR
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="showTab('students')" id="tab-students"
                class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-white text-blue-600 shadow">
                üë• √âl√®ves
            </button>
            <button onclick="showTab('assignments')" id="tab-assignments"
                class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                üìã Devoirs
            </button>
            <button onclick="showTab('grades')" id="tab-grades"
                class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                üéØ Notes
            </button>
            <button onclick="showTab('summary')" id="tab-summary"
                class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                üìä R√©capitulatif
            </button>
            <button onclick="showTab('export')" id="tab-export"
                class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-600 hover:bg-gray-300">
                üßæ Pr√©paration Export
            </button>
        </div>

        <!-- Students Tab -->
        <div id="content-students" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">Liste des √âl√®ves</h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <label
                            class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-lg border cursor-pointer text-sm">
                            <span class="text-gray-700" data-translate="importExcel">Importer (.xlsx)</span>
                            <input type="file" id="student-import" accept=".xlsx,.xls" class="hidden"
                                onchange="handleStudentImport(event)">
                        </label>

                        <label
                            class="flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-lg border cursor-pointer text-sm">
                            <span class="text-gray-700" data-translate="importJson">Importer (.json)</span>
                            <input type="file" id="json-import" accept=".json" class="hidden"
                                onchange="handleJsonImportData(event)">
                        </label>

                        <button id="btn-export-json" onclick="handleJsonExportData()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition"
                            data-translate="exportJson">Exporter JSON</button>

                        <button onclick="openStudentModal()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                            + Ajouter un √©l√®ve
                        </button>
                        <input type="text" id="student-search" placeholder="Rechercher (nom, pr√©nom, classe)"
                            oninput="renderStudents()" class="flex-1 min-w-48 p-3 border rounded-lg">
                    </div>
                </div>

                <!-- Class Management -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-2">Gestion des Classes</h3>
                    <div class="flex flex-wrap gap-2" id="class-list"></div>
                </div>

                <div id="students-list" class="space-y-2"></div>
            </div>
        </div>

        <!-- Assignments Tab -->
        <div id="content-assignments" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Gestion des Devoirs</h2>
                    <button onclick="openAssignmentModal()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                        + Cr√©er un devoir
                    </button>
                </div>

                <!-- Filters -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg flex gap-4 flex-wrap">
                    <div class="flex-1 min-w-48">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrer par classe</label>
                        <select id="filter-class-assignments" onchange="renderAssignments()"
                            class="w-full p-3 border rounded-lg">
                            <option value="">-- Toutes les classes --</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-48">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrer par nom de devoir</label>
                        <input type="text" id="filter-name-assignments" placeholder="Rechercher un devoir..."
                            onkeyup="renderAssignments()" class="w-full p-3 border rounded-lg">
                    </div>
                </div>

                <div id="assignments-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Grades Tab -->
        <div id="content-grades" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Saisie des Notes</h2>
                <div class="flex gap-4 mb-6 flex-wrap">
                    <select id="select-class-grades" onchange="loadGradeSelectors()"
                        class="flex-1 min-w-48 p-3 border rounded-lg">
                        <option value="">-- S√©lectionner une classe --</option>
                    </select>
                    <select id="select-assignment" onchange="loadGradeEntry()"
                        class="flex-1 min-w-48 p-3 border rounded-lg">
                        <option value="">-- S√©lectionner un devoir --</option>
                    </select>
                    <select id="select-student" onchange="loadGradeEntry()"
                        class="flex-1 min-w-48 p-3 border rounded-lg">
                        <option value="">-- S√©lectionner un √©l√®ve --</option>
                    </select>
                </div>
                <div id="grade-entry" class="space-y-4"></div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="content-summary" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">R√©capitulatif des Notes</h2>
                    <div class="flex items-center gap-2 mb-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="summaryMode" value="default" checked
                                onchange="setSummaryMode('default')">
                            <span>Vue par d√©faut</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="summaryMode" value="view1" onchange="setSummaryMode('view1')">
                            <span>Vue 1</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="summaryMode" value="grouped" onchange="setSummaryMode('grouped')">
                            <span>Vue 2</span>
                        </label>
                    </div>


                    <div class="flex items-center gap-4 flex-wrap">
                        <input type="text" id="summary-search" placeholder="Rechercher (nom, pr√©nom, classe)"
                            oninput="renderSummary()" class="p-3 border rounded-lg min-w-60">
                        <select id="select-class-summary" onchange="renderSummary()" class="p-3 border rounded-lg">
                            <option value="">-- S√©lectionner une classe --</option>
                        </select>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="show-details" onchange="renderSummary()" class="w-5 h-5">
                            <span>Afficher les d√©tails (exercices)</span>
                        </label>
                        <div id="summary-assignment-tags" class="flex flex-wrap gap-2"></div>
                        <button id="btn-export-excel" onclick="exportSummaryToExcel()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">Exporter
                            Excel</button>
                    </div>
                </div>
                <div id="summary-table"></div>
            </div>
        </div>
    </div>
    <!-- Export Prep Tab -->
    <div id="content-export" class="tab-content hidden">
        <!-- Ajout du wrapper "container" identique aux autres onglets -->
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800" data-translate="exportPrepTitle">Pr√©paration des notes
                        (CC/Devoir/Composition)</h2>
                    <div class="flex items-center gap-2">
                        <button onclick="resetExportConfig()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition"
                            data-translate="reset">R√©initialiser</button>
                        <button onclick="openRemarksModal()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition"
                            data-translate="editRemarks">Messages</button>
                    </div>
                </div>

                <!-- Choix classe -->
                <div id="export-class-card" class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="selectClass">
                        -- S√©lectionner une classe --
                    </label>
                    <select id="select-class-export" onchange="onExportClassChange(); updateExportClassCardColor();"
                        class="w-full md:w-80 p-3 border rounded-lg">
                        <option value="">-- S√©lectionner une classe --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2" data-translate="exportPrepHint">
                        Choisissez la classe, puis associez les devoirs existants aux trois notes √† exporter.
                    </p>
                </div>

                <!-- Config -->
                <div id="export-config" class="space-y-4"></div>

                <!-- Aper√ßu table -->
                <div class="mt-6">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                        <h3 class="text-lg font-bold text-gray-800" data-translate="exportPreview">
                            Aper√ßu (pr√™t pour export)
                        </h3>

                        <!-- BOUTONS -->
                        <div class="flex items-center gap-3">
                            <button onclick="printExportTable()"
                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold shadow-sm transition"
                                data-translate="print">Imprimer</button>

                            <button onclick="exportExportTableXLSX()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold shadow-sm transition"
                                data-translate="exportXlsx">Exporter XLSX</button>

                            <button onclick="doRakamna()"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow-sm transition"
                                data-translate="rakamna">Rakamna</button>
                        </div>

                        <div class="text-sm text-gray-500" id="export-preview-meta"></div>
                    </div>

                    <div id="export-preview-table" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
        <!-- Student Modal -->
        <div id="student-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4">Ajouter un √©l√®ve</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <input type="text" id="student-lastname" placeholder="Nom" class="w-full p-3 border rounded-lg">
                    <input type="text" id="student-firstname" placeholder="Pr√©nom" class="w-full p-3 border rounded-lg">
                    <input type="text" id="student-class" placeholder="Classe" class="w-full p-3 border rounded-lg">
                    <input type="text" id="student-nin" placeholder="NIN (optionnel)"
                        class="w-full p-3 border rounded-lg">
                </div>
                <div class="flex gap-3 justify-end">
                    <button onclick="closeStudentModal()"
                        class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Annuler</button>
                    <button onclick="addStudent()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ajouter</button>
                </div>
            </div>
        </div>

        <!-- Assignment Modal will be injected dynamically -->



        <script src="./translations.js"></script>
        <script type="module">
            import { computeExportRemarks } from "./remarks.engine.js";
            import { REMARKS } from "./remarks.messages.js";

            window.computeExportRemarks = computeExportRemarks;

            // 1) Ton nom "underscore" (si tu l'utilises ailleurs)
            window.REMARKS_MESSAGES = REMARKS;

            // 2) Alias pour index.html (getObsCandidatesForRow / getConsCandidatesForRow / preview)
            window.REMARKSMESSAGES = REMARKS;
        </script>




        <script>
            // Language Management
            let currentLanguage = 'fr';
            let isRTL = false;

            function initLanguage() {
                // R√©cup√©rer la langue sauvegard√©e ou d√©tecter celle du navigateur
                const savedLang = localStorage.getItem('corrections-language');
                if (savedLang) {
                    currentLanguage = savedLang;
                } else {
                    // D√©tection automatique
                    const browserLang = navigator.language || navigator.userLanguage;
                    if (browserLang.startsWith('ar')) {
                        currentLanguage = 'ar';
                    } else if (browserLang.startsWith('en')) {
                        currentLanguage = 'en';
                    }
                }
                applyLanguage();
            }

            function changeLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('corrections-language', lang);
                applyLanguage();
            }

            function softResetUI() {
                try { closeRemarksModal(); } catch (e) { }
                try { closeAssignmentModal(); } catch (e) { }
                const rm = document.getElementById('remarks-modal'); if (rm) rm.remove();
                const am = document.getElementById('assignment-modal'); if (am) am.remove();
                const sm = document.getElementById('student-modal'); if (sm) { sm.classList.remove('active'); sm.classList.add('hidden'); }
                document.body.style.pointerEvents = '';
                document.body.style.overflow = '';
                const tabs = Array.from(document.querySelectorAll('.tab-content'));
                const active = tabs.find(t => !t.classList.contains('hidden'));
                if (active) {
                    const id = active.id;
                    if (id === 'content-summary') renderSummary();
                    else if (id === 'content-assignments') renderAssignments();
                    else if (id === 'content-export') renderExportPrep();
                    else if (id === 'content-grades') loadGradeEntry();
                }
                const b = document.getElementById('ui-error-banner'); if (b) b.style.display = 'none';
            }

            function showUiErrorBanner(msg) {
                let b = document.getElementById('ui-error-banner');
                if (!b) {
                    b = document.createElement('div');
                    b.id = 'ui-error-banner';
                    b.className = 'fixed top-2 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded shadow flex items-center gap-2 z-50';
                    b.innerHTML = '<span id="ui-error-text"></span><button onclick="softResetUI()" class="px-2 py-1 bg-white text-red-600 rounded">R√©initialiser</button>';
                    document.body.appendChild(b);
                }
                const s = document.getElementById('ui-error-text');
                if (s) s.textContent = msg || 'Erreur inattendue';
                b.style.display = 'flex';
            }

            function setupGlobalUiGuard() {
                window.addEventListener('error', (e) => {
                    const m = (e.error && e.error.message) || e.message || 'Erreur';
                    showUiErrorBanner(m);
                });
                window.addEventListener('unhandledrejection', (e) => {
                    const m = (e && e.reason && (e.reason.message || e.reason)) || 'Erreur asynchrone';
                    showUiErrorBanner(m);
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        try { closeRemarksModal(); } catch (_) { }
                        try { closeAssignmentModal(); } catch (_) { }
                        const rm = document.getElementById('remarks-modal'); if (rm) rm.remove();
                        const am = document.getElementById('assignment-modal'); if (am) am.remove();
                    }
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'r') {
                        softResetUI();
                    }
                });
            }
            setupGlobalUiGuard();

            function applyLanguage() {
                isRTL = currentLanguage === 'ar';

                // Appliquer la direction
                document.body.dir = isRTL ? 'rtl' : 'ltr';
                document.body.className = isRTL ? 'rtl-layout' : 'ltr-layout';

                // Traduire tous les √©l√©ments
                translatePage();

                // Re-rendre les composants dynamiques
                if (typeof renderStudents === 'function') renderStudents();
                if (typeof renderAssignments === 'function') renderAssignments();
                if (typeof renderSummary === 'function') renderSummary();
                if (typeof loadGradeSelectors === 'function') loadGradeSelectors();
                if (typeof renderExportPrep === 'function') renderExportPrep();
                if (typeof loadClassSelectorsForExport === 'function') loadClassSelectorsForExport();
            }

            function translatePage() {
                const t = translations[currentLanguage];

                // Traduire les √©l√©ments avec data-translate
                document.querySelectorAll('[data-translate]').forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (t[key]) {
                        if (element.tagName === 'OPTION') {
                            element.textContent = t[key];
                        } else {
                            element.textContent = t[key];
                        }
                    }
                });
                // Mettre √† jour le placeholder du champ de recherche avec la m√™me traduction
                const searchInput = document.getElementById('student-search');
                if (searchInput) {
                    searchInput.placeholder = t.search; // Utilise la m√™me cl√© que dans R√©capitulatif
                }
                // Titre et sous-titre
                setTextContent('h1', t.appTitle);
                setTextContent('header p', t.appSubtitle);

                // Navigation
                setTextContent('#tab-students', t.studentsTab);
                setTextContent('#tab-assignments', t.assignmentsTab);
                setTextContent('#tab-grades', t.gradesTab);
                setTextContent('#tab-summary', t.summaryTab);

                // Onglet √âtudiants
                setTextContent('#content-students h2', t.studentsList);
                setTextContent('#student-import + span', t.importExcel);
                setTextContent('button[onclick="openStudentModal()"]', t.addStudent);
                setTextContent('#content-students h3', t.classManagement);

                // Modal √©tudiant
                setTextContent('#student-modal h3', t.addStudentTitle);
                setAttribute('#student-lastname', 'placeholder', t.lastName);
                setAttribute('#student-firstname', 'placeholder', t.firstName);
                setAttribute('#student-class', 'placeholder', t.className);
                setAttribute('#student-nin', 'placeholder', t.nin);
                setTextContent('.modal button:first-child', t.cancel);
                setTextContent('.modal button:last-child', t.add);

                // Onglet Devoirs
                setTextContent('#content-assignments h2', t.assignmentsManagement);
                setTextContent('button[onclick="openAssignmentModal()"]', t.createAssignment);
                setTextContent('#filter-class-assignments + label', t.filterByClass);
                setTextContent('#filter-class-assignments option:first-child', t.allClasses);
                const filterClassLabel = document.querySelector('#filter-class-assignments').previousElementSibling;
                const filterNameLabel = document.querySelector('#filter-name-assignments').previousElementSibling;
                if (filterClassLabel) filterClassLabel.textContent = t.filterByClass;
                if (filterNameLabel) filterNameLabel.textContent = t.filterByName;
                setTextContent('#filter-class-assignments option:first-child', t.allClasses);
                setAttribute('#filter-name-assignments', 'placeholder', t.searchAssignment);

                setTextContent('#filter-name-assignments + label', t.filterByName);
                setAttribute('#filter-name-assignments', 'placeholder', t.searchAssignment);

                // Modal devoir
                setTextContent('#assignment-modal-title', editingAssignmentId ? t.editAssignment : t.createAssignmentTitle);
                setAttribute('#assignment-name', 'placeholder', t.assignmentName);
                setTextContent('#assignment-class option:first-child', t.selectClass);
                setTextContent('button[onclick="addExercise()"]', t.addExercise);
                setTextContent('.modal button:first-child', t.cancel);
                setTextContent('.modal button:last-child', t.save);

                // Onglet Notes
                setTextContent('#content-grades h2', t.gradesEntry);
                setTextContent('#select-class-grades option:first-child', t.selectClass);
                setTextContent('#select-assignment option:first-child', t.selectAssignment);
                setTextContent('#select-student option:first-child', t.selectStudent);

                // Onglet R√©capitulatif
                setTextContent('#content-summary h2', t.summaryTitle);
                setAttribute('#summary-search', 'placeholder', t.search);
                setTextContent('#show-details + span', t.showDetails);
                setTextContent('th[onclick="toggleSummarySort(\'name\')"]', t.student);

                // Mettre √† jour les tooltips et autres textes
                updateDynamicTexts();
            }

            function setTextContent(selector, text) {
                const element = document.querySelector(selector);
                if (element) element.textContent = text;
            }

            function setAttribute(selector, attr, value) {
                const element = document.querySelector(selector);
                if (element) element.setAttribute(attr, value);
            }

            function updateDynamicTexts() {
                const t = translations[currentLanguage];

                // Mettre √† jour les tooltips
                const editButtons = document.querySelectorAll('button[onclick*="openAssignmentModal"]');
                editButtons.forEach(btn => {
                    btn.title = t.edit;
                });

                const deleteButtons = document.querySelectorAll('button[onclick*="deleteAssignment"]');
                deleteButtons.forEach(btn => {
                    btn.title = t.delete;
                });

                const duplicateButtons = document.querySelectorAll('button[onclick*="duplicateAssignment"]');
                duplicateButtons.forEach(btn => {
                    btn.title = t.duplicate;
                });

                const exportBtn = document.querySelector('#btn-export-json');
                if (exportBtn) exportBtn.textContent = t.exportJson;

                const exportExcelBtn = document.querySelector('#btn-export-excel');
                if (exportExcelBtn) exportExcelBtn.textContent = t.exportExcel;
            }

            // Data Store
            let data = {
                students: [], // { id, name, className, nin, firstName, sex, birthDate, regNumber }
                assignments: [], // { id, name, className, exercises }
                grades: {}
            };

            // Tri du r√©capitulatif
            let summarySort = { key: 'name', direction: 'asc' };
            let summaryAssignmentFilter = new Set();

            // Current editing state
            let editingAssignmentId = null;
            let tempExercises = [];
            // AJOUT : mode devoir global (note unique)
            let isGlobalAssignment = false;
            let globalMaxPoints = 20;


            // Load from localStorage
            function loadData() {
                const saved = localStorage.getItem('corrections-data');
                if (saved) {
                    data = JSON.parse(saved);
                }
            }

            // Save to localStorage
            function saveData() {
                localStorage.setItem('corrections-data', JSON.stringify(data));
            }

            // Generate unique ID
            function genId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Tab Navigation
            function showTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(el => {
                    el.classList.remove('bg-white', 'text-blue-600', 'shadow');
                    el.classList.add('bg-gray-200', 'text-gray-600');
                });

                document.getElementById('content-' + tab).classList.remove('hidden');
                const btn = document.getElementById('tab-' + tab);
                btn.classList.remove('bg-gray-200', 'text-gray-600');
                btn.classList.add('bg-white', 'text-blue-600', 'shadow');

                if (tab === 'grades') {
                    loadClassSelectors();
                    loadGradeSelectors();
                }
                if (tab === 'summary') {
                    loadClassSelectors();
                    renderSummary();
                }
                if (tab === 'assignments') {
                    loadClassSelectorsForAssignments();
                    renderAssignments();
                }
                if (tab === 'export') {
                    loadClassSelectorsForExport();
                    renderExportPrep();
                }
                translatePage();
            }

            // ===== CLASSES =====
            function getClasses() {
                const classes = new Set();
                data.students.forEach(s => {
                    if (s.className) classes.add(s.className);
                });
                return Array.from(classes).sort();
            }

            function loadClassSelectors() {
                const classes = getClasses();
                const t = translations[currentLanguage];

                // For grades tab
                const gradesSelect = document.getElementById('select-class-grades');
                if (gradesSelect) {
                    const currentValue = gradesSelect.value;
                    gradesSelect.innerHTML = '<option value="">-- S√©lectionner une classe --</option>' +
                        classes.map(c => `<option value="${c}" ${c === currentValue ? 'selected' : ''}>${c}</option>`).join('');
                }

                // For summary tab
                const summarySelect = document.getElementById('select-class-summary');
                if (summarySelect) {
                    const currentValue = summarySelect.value;
                    summarySelect.innerHTML = '<option value="">-- S√©lectionner une classe --</option>' +
                        classes.map(c => `<option value="${c}" ${c === currentValue ? 'selected' : ''}>${c}</option>`).join('');
                }

                // For assignment modal
                const assignmentSelect = document.getElementById('assignment-class');
                if (assignmentSelect) {
                    const currentValue = assignmentSelect.value;
                    assignmentSelect.innerHTML = `<option value="">${t.selectClass}</option>` +
                        classes.map(c => `<option value="${c}" ${c === currentValue ? 'selected' : ''}>${c}</option>`).join('');
                }
            }

            function loadClassSelectorsForAssignments() {
                const classes = getClasses();

                // For assignments filter
                const filterSelect = document.getElementById('filter-class-assignments');
                if (filterSelect) {
                    const currentValue = filterSelect.value;
                    filterSelect.innerHTML = '<option value="">-- Toutes les classes --</option>' +
                        classes.map(c => `<option value="${c}" ${c === currentValue ? 'selected' : ''}>${c}</option>`).join('');
                }
            }

            function renderClassList() {
                const t = translations[currentLanguage];
                const container = document.getElementById('class-list');
                const classes = getClasses();

                if (classes.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-sm">${t.noClassesAutoCreated}</p>`;
                    return;
                }

                container.innerHTML = classes.map(c => {
                    const count = data.students.filter(s => s.className === c).length;
                    return `
            <div class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 transition-all">
                <button onclick="deleteClass('${c}')" class="text-red-600 hover:text-red-800 text-lg font-bold p-1 rounded hover:bg-red-100 transition-all">‚úï</button>
                <span class="font-medium">${c}</span>
                <span class="text-xs bg-blue-200 px-2 py-1 rounded font-medium">${count} ${t.students}</span>
            </div>
        `;
                }).join('');
            }

            function deleteClass(className) {
                const t = translations[currentLanguage];
                const count = data.students.filter(s => s.className === className).length;
                if (!confirm(`${t.deleteClassConfirm} "${className}" ${t.andStudents} ${count} ${t.students}`)) return;

                // Remove students from this class
                const studentIds = data.students.filter(s => s.className === className).map(s => s.id);
                data.students = data.students.filter(s => s.className !== className);

                // Remove their grades
                studentIds.forEach(id => {
                    delete data.grades[id];
                });

                saveData();
                renderStudents();
                renderClassList();
                loadClassSelectors();
                loadClassSelectorsForAssignments();
                renderSummary();
                renderAssignments();
            }

            // ===== STUDENTS =====
            function openStudentModal() {
                document.getElementById('student-modal').classList.add('active');
                document.getElementById('student-lastname').value = '';
                document.getElementById('student-firstname').value = '';
                document.getElementById('student-class').value = '';
                document.getElementById('student-nin').value = '';
                document.getElementById('student-lastname').focus();
            }

            function closeStudentModal() {
                document.getElementById('student-modal').classList.remove('active');
            }

            function addStudent() {
                const t = translations[currentLanguage];
                const lastName = document.getElementById('student-lastname').value.trim();
                const firstName = document.getElementById('student-firstname').value.trim();
                const className = document.getElementById('student-class').value.trim();
                const nin = document.getElementById('student-nin').value.trim();
                if (!lastName && !firstName) return alert(t.enterName);
                const name = (lastName + ' ' + firstName).trim();

                data.students.push({ id: genId(), name, className, nin, firstName, lastName });
                saveData();
                renderStudents();
                closeStudentModal();
            }

            function deleteStudent(id) {
                const t = translations[currentLanguage];
                if (!confirm(t.deleteStudent)) return;
                data.students = data.students.filter(s => s.id !== id);
                delete data.grades[id];
                saveData();
                renderStudents();
            }

            function renderStudents() {
                const t = translations[currentLanguage];
                const container = document.getElementById('students-list');
                const searchTerm = document.getElementById('student-search')?.value.trim().toLowerCase() || '';

                let filteredStudents = data.students.slice();
                if (searchTerm) {
                    filteredStudents = filteredStudents.filter(s => {
                        const haystack = `${s.name || ''} ${s.firstName || ''} ${s.lastName || ''} ${s.className || ''}`.toLowerCase();
                        return haystack.includes(searchTerm);
                    });
                }

                if (data.students.length === 0) {
                    container.className = '';
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${t.noStudentsAddFirst}</p>`;
                    return;
                }

                container.className = 'student-grid';

                const levelFromClass = (className = '') => {
                    const first = className.trim().split(/\s+/)[0] || '';
                    const map = {
                        'ÿ£ŸàŸÑŸâ': 1, 'ÿßŸàŸÑŸâ': 1, '1ere': 1, '1√®re': 1, '1': 1,
                        'ÿ´ÿßŸÜŸäÿ©': 2, '2nde': 2, '2': 2,
                        'ÿ´ÿßŸÑÿ´ÿ©': 3, '3eme': 3, '3√®me': 3, '3': 3,
                        'ÿ±ÿßÿ®ÿπÿ©': 4, '4eme': 4, '4√®me': 4, '4': 4,
                        'ÿÆÿßŸÖÿ≥ÿ©': 5, '5eme': 5, '5√®me': 5, '5': 5,
                        'ÿ≥ÿßÿØÿ≥ÿ©': 6, '6eme': 6, '6√®me': 6, '6': 6
                    };
                    const key = first.toLowerCase();
                    return map[key] || '?';
                };

                const items = filteredStudents.map((s, i) => {
                    const first = (s.firstName || '').trim();
                    const last = (s.lastName || '').trim();
                    const displayName = (s.name || `${last} ${first}`).trim();
                    const level = levelFromClass(s.className || '');
                    const sex = (s.sex || '').toLowerCase();
                    const levelClass = sex.startsWith('f') || sex.includes('ÿ£ŸÜÿ´') || sex.includes('fille') ? 'girl'
                        : sex.startsWith('m') || sex.includes('ÿ∞ŸÉÿ±') || sex.includes('gar√ßon') ? 'boy'
                            : 'neutral';
                    const birth = formatDate(parseDateMaybeExcel(s.birthDate || ''));

                    return `
            <div class="student-item">
                <div class="student-level ${levelClass}" title="Niveau">${level}</div>
                <div class="student-info">
                    <div class="student-name">${displayName}</div>
                    <div class="student-meta">
                        <span class="student-chip gray">#${i + 1}</span>
                        ${s.className ? `<span class="student-chip">${s.className}</span>` : ''}
                        ${s.nin ? `<span class="student-chip gray">NIN ${s.nin}</span>` : ''}
                        ${birth ? `<span class="student-chip birth">üéÇ ${birth}</span>` : ''}
                    </div>
                </div>
                <div class="student-actions">
                    <button onclick="deleteStudent('${s.id}')" title="${t.delete}">üóëÔ∏è</button>
                </div>
            </div>`;
                }).join('');

                container.innerHTML = items;

                renderClassList();
                translatePage();
            }
            // ===== ASSIGNMENTS =====
            function openAssignmentModal(assignmentId = null) {
                const t = translations[currentLanguage];
                editingAssignmentId = assignmentId;
                const overlay = document.createElement('div');
                overlay.id = 'assignment-modal';
                overlay.className = 'modal fixed inset-0 items-center justify-center z-50 overflow-y-auto py-8';
                overlay.style.display = 'flex';
                overlay.style.background = 'rgba(0,0,0,.5)';
                overlay.innerHTML = `
                  <div class="bg-white rounded-xl p-6 w-full max-w-5xl mx-4 my-auto">
                    <h3 id="assignment-modal-title" class="text-xl font-bold mb-4">${t.createAssignment || 'Cr√©er un Devoir'}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <input type="text" id="assignment-name" placeholder="Nom du devoir ex: Devoir 1" class="w-full p-3 border rounded-lg">
                      <select id="assignment-class" class="w-full p-3 border rounded-lg">
                        <option value="" data-translate="selectClass">${t.selectClass || '-- S√©lectionner une classe --'}</option>
                      </select>
                    </div>
                    <div class="mb-4 flex items-center gap-2">
                      <input type="checkbox" id="assignment-global-only" class="w-4 h-4" onchange="toggleGlobalAssignmentMode(this.checked)">
                      <label for="assignment-global-only" class="text-sm text-gray-700">${t.globalOnlyLabel || 'Note globale uniquement (sans exercices d√©taill√©s)'}</label>
                    </div>
                    <div id="global-maxpoints-container" class="mb-4 hidden">
                      <label class="block text-sm font-medium text-gray-700 mb-1">${t.globalMaxLabel || 'Note maximale du devoir'}</label>
                      <input type="number" id="assignment-global-maxpoints" class="w-32 p-2 border rounded" min="0" step="0.25" value="20">
                    </div>
                    <div id="exercises-builder" class="space-y-4 mb-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    <button id="add-exercise-btn" onclick="addExercise()" class="w-full p-3 border-2 border-dashed border-blue-400 text-blue-600 rounded-lg hover:bg-blue-50 mb-4" data-translate="addExercise">${t.addExercise || 'Ajouter un exercice'}</button>
                    <div class="flex gap-3 justify-end">
                      <button onclick="closeAssignmentModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400" data-translate="cancel">${t.cancel || 'Annuler'}</button>
                      <button onclick="saveAssignment()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-translate="save">${t.save || 'Enregistrer'}</button>
                    </div>
                  </div>`;
                document.body.appendChild(overlay);
                try {
                    loadClassSelectors();
                    const globalCheckbox = document.getElementById('assignment-global-only');
                    const globalMaxInput = document.getElementById('assignment-global-maxpoints');
                    if (assignmentId) {
                        const assignment = data.assignments.find(a => a.id === assignmentId);
                        if (!assignment) return;
                        document.getElementById('assignment-modal-title').textContent = t.editAssignment || 'Modifier le devoir';
                        document.getElementById('assignment-name').value = assignment.name;
                        document.getElementById('assignment-class').value = assignment.className;
                        const exs = assignment.exercises || [];
                        if (exs.length === 1 && (!exs[0].questions || exs[0].questions.length === 0) && (!exs[0].parts || exs[0].parts.length === 0)) {
                            isGlobalAssignment = true;
                            if (globalCheckbox) globalCheckbox.checked = true;
                            globalMaxPoints = exs[0].maxPoints || 20;
                            if (globalMaxInput) globalMaxInput.value = globalMaxPoints;
                            tempExercises = [];
                        } else {
                            isGlobalAssignment = false;
                            if (globalCheckbox) globalCheckbox.checked = false;
                            tempExercises = JSON.parse(JSON.stringify(exs));
                        }
                    } else {
                        tempExercises = [];
                        isGlobalAssignment = false;
                        if (globalCheckbox) globalCheckbox.checked = false;
                        globalMaxPoints = 20;
                        if (globalMaxInput) globalMaxInput.value = 20;
                    }
                    toggleGlobalAssignmentMode(isGlobalAssignment);
                } catch (e) { }
                renderExercisesBuilder();
            }

            function closeAssignmentModal() {
                const am = document.getElementById('assignment-modal');
                if (am) am.remove();
                editingAssignmentId = null;
            }
            // AJOUT : activer/d√©sactiver le mode "note globale"
            function toggleGlobalAssignmentMode(isGlobal) {
                isGlobalAssignment = isGlobal;

                const globalContainer = document.getElementById('global-maxpoints-container');
                const exercisesBuilder = document.getElementById('exercises-builder');
                const addExerciseBtn = document.getElementById('add-exercise-btn');

                if (isGlobalAssignment) {
                    if (globalContainer) globalContainer.classList.remove('hidden');
                    if (exercisesBuilder) exercisesBuilder.classList.add('hidden');
                    if (addExerciseBtn) addExerciseBtn.classList.add('hidden');
                } else {
                    if (globalContainer) globalContainer.classList.add('hidden');
                    if (exercisesBuilder) exercisesBuilder.classList.remove('hidden');
                    if (addExerciseBtn) addExerciseBtn.classList.remove('hidden');
                }
            }

            function addExercise() {
                const exId = genId();
                tempExercises.push({ id: exId, name: '', maxPoints: 0, parts: [], questions: [] });
                renderExercisesBuilder();
            }

            function removeExercise(exId) {
                const t = translations[currentLanguage];
                if (!confirm(t.deleteExercise)) return;
                tempExercises = tempExercises.filter(e => e.id !== exId);
                renderExercisesBuilder();
            }

            function addPart(exId) {
                const t = translations[currentLanguage];
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    if (!ex.parts) ex.parts = [];
                    const partNum = ex.parts.length + 1;
                    ex.parts.push({ id: genId(), name: `${t.part} ${partNum}`, questions: [] });
                    renderExercisesBuilder();
                }
            }

            function removePart(exId, partId) {
                const t = translations[currentLanguage];
                if (!confirm(t.deletePart)) return;
                const ex = tempExercises.find(e => e.id === exId);
                if (ex && ex.parts) {
                    ex.parts = ex.parts.filter(p => p.id !== partId);
                    renderExercisesBuilder();
                }
            }

            function addQuestion(exId, partId = null) {
                const t = translations[currentLanguage];
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    const newQuestion = { id: genId(), name: '', maxPoints: 0, subQuestions: [] };

                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) {
                            const qNum = part.questions.length + 1;
                            newQuestion.name = `${t.questionPrefix}${qNum}`;
                            part.questions.push(newQuestion);
                        }
                    } else {
                        const qNum = ex.questions.length + 1;
                        newQuestion.name = `${t.questionPrefix}${qNum}`;
                        ex.questions.push(newQuestion);
                    }
                    renderExercisesBuilder();
                }
            }

            function removeQuestion(exId, qId, partId = null) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) {
                            part.questions = part.questions.filter(q => q.id !== qId);
                        }
                    } else {
                        ex.questions = ex.questions.filter(q => q.id !== qId);
                    }
                    renderExercisesBuilder();
                }
            }

            function addSubQuestion(exId, qId, partId = null) {
                const t = translations[currentLanguage];
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    let q;
                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) q = part.questions.find(x => x.id === qId);
                    } else {
                        q = ex.questions.find(x => x.id === qId);
                    }

                    if (q) {
                        const letters = t.subQuestionLetters;
                        const letter = letters[q.subQuestions.length] || '?';
                        q.subQuestions.push({ id: genId(), name: letter, maxPoints: 0 });

                        // Effacer les points directs de la question quand on ajoute des sous-questions
                        if (q.subQuestions.length === 1) {
                            q.maxPoints = 0;
                        }

                        renderExercisesBuilder();
                    }
                }
            }
            function removeSubQuestion(exId, qId, sqId, partId = null) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    let q;
                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) q = part.questions.find(x => x.id === qId);
                    } else {
                        q = ex.questions.find(x => x.id === qId);
                    }

                    if (q) {
                        q.subQuestions = q.subQuestions.filter(sq => sq.id !== sqId);

                        // Si plus de sous-questions, r√©initialiser les points
                        if (q.subQuestions.length === 0) {
                            q.maxPoints = q.maxPoints || 0;
                        }

                        renderExercisesBuilder();
                    }
                }
            }

            function updateExerciseField(exId, field, value) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    if (field === 'maxPoints') {
                        ex[field] = parseFloat(value) || 0;
                    } else {
                        ex[field] = value;
                    }
                }
            }

            function updatePartField(exId, partId, field, value) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex && ex.parts) {
                    const part = ex.parts.find(p => p.id === partId);
                    if (part) part[field] = value;
                }
            }

            function updateQuestionField(exId, qId, partId, field, value) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    let q;
                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) q = part.questions.find(x => x.id === qId);
                    } else {
                        q = ex.questions.find(x => x.id === qId);
                    }

                    if (q) {
                        if (field === 'maxPoints') {
                            q[field] = parseFloat(value) || 0;
                        } else {
                            q[field] = value;
                        }
                    }
                }
            }

            function updateSubQuestionField(exId, qId, sqId, partId, field, value) {
                const ex = tempExercises.find(e => e.id === exId);
                if (ex) {
                    let q;
                    if (partId) {
                        const part = ex.parts.find(p => p.id === partId);
                        if (part) q = part.questions.find(x => x.id === qId);
                    } else {
                        q = ex.questions.find(x => x.id === qId);
                    }

                    if (q) {
                        const sq = q.subQuestions.find(s => s.id === sqId);
                        if (sq) {
                            if (field === 'maxPoints') {
                                sq[field] = parseFloat(value) || 0;
                            } else {
                                sq[field] = value;
                            }
                        }
                    }
                }
            }

            function renderQuestionBuilder(q, exId, partId = null) {
                const t = translations[currentLanguage];
                const partParam = partId ? `'${partId}'` : 'null';
                const hasSubQuestions = q.subQuestions && q.subQuestions.length > 0;

                return `
                <div class="border border-green-200 rounded p-3 bg-green-50">
                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                        <input type="text" placeholder="${t.questionPrefix}1, ${t.questionPrefix}2..." value="${q.name}"
                            onchange="updateQuestionField('${exId}','${q.id}',${partParam},'name',this.value)"
                            class="w-20 p-1 border rounded text-sm font-semibold text-green-700 bg-white">
                        ${!hasSubQuestions ? `
                            <input type="number" placeholder="${t.points}" value="${q.maxPoints || ''}" min="0" step="0.25"
                                onchange="updateQuestionField('${exId}','${q.id}',${partParam},'maxPoints',this.value)"
                                class="w-16 p-1 border rounded text-sm" title="${t.questionPoints}">
                        ` : `
                            <span class="text-xs text-gray-500 px-2">${t.totalPoints}: ${getQuestionMaxPoints(q)} ${t.points}</span>
                        `}
                        <button onclick="addSubQuestion('${exId}','${q.id}',${partParam})" class="text-blue-500 hover:text-blue-700 text-sm px-2 py-1 bg-blue-50 rounded">+a,b,c</button>
                        <button onclick="removeQuestion('${exId}','${q.id}',${partParam})" class="text-red-500 hover:text-red-700 ml-auto">‚úï</button>
                    </div>
                    
                    ${hasSubQuestions ? `
                        <div class="flex flex-wrap gap-2 ml-4">
                            ${q.subQuestions.map(sq => `
                                <div class="flex items-center gap-1 bg-white px-2 py-1 rounded border">
                                    <input type="text" value="${sq.name}" 
                                        onchange="updateSubQuestionField('${exId}','${q.id}','${sq.id}',${partParam},'name',this.value)"
                                        class="w-8 p-0 border-0 text-orange-600 font-medium text-center text-sm">
                                    <span class="text-orange-400">)</span>
                                    <input type="number" placeholder="Pts" value="${sq.maxPoints || ''}" min="0" step="0.25"
                                        onchange="updateSubQuestionField('${exId}','${q.id}','${sq.id}',${partParam},'maxPoints',this.value)"
                                        class="w-14 p-1 border rounded text-sm">
                                    <button onclick="removeSubQuestion('${exId}','${q.id}','${sq.id}',${partParam})" class="text-red-400 hover:text-red-600 text-xs">‚úï</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-xs text-gray-500 mt-2 ml-4">
                            ${t.autoTotalPoints}: ${getQuestionMaxPoints(q)} ${t.points} (${t.sumSubQuestions})
                        </div>
                    ` : ''}
                </div>
            `;
            }

            function renderExercisesBuilder() {
                const t = translations[currentLanguage];
                const container = document.getElementById('exercises-builder');

                if (tempExercises.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">${t.noExercises}. ${t.clickAddExercise}.</p>`;
                    return;
                }

                container.innerHTML = tempExercises.map((ex, exIndex) => {
                    // Ensure parts array exists
                    if (!ex.parts) ex.parts = [];
                    if (!ex.questions) ex.questions = [];

                    const exerciseTotal = getExerciseMaxPoints(ex);

                    return `
                <div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                    <div class="flex items-center gap-2 mb-3 flex-wrap">
                        <span class="font-bold text-blue-700 text-lg">${t.exercise} ${exIndex + 1}</span>
                        <input type="text" placeholder="${t.exerciseName}" value="${ex.name}" 
                            onchange="updateExerciseField('${ex.id}','name',this.value)"
                            class="flex-1 min-w-32 p-2 border rounded text-sm">
                        <span class="text-sm font-semibold text-blue-600 px-2">${t.totalPoints}: ${exerciseTotal} ${t.points}</span>
                        <button onclick="removeExercise('${ex.id}')" class="text-red-500 hover:text-red-700 text-lg">‚úï</button>
                    </div>
                    
                    <div class="text-xs text-gray-500 mb-3">
                        ${ex.questions.length === 0 && ex.parts.length === 0 ?
                            `${t.noQuestions} - ${t.directPointsOnly}` :
                            `${t.autoTotalPoints}: ${exerciseTotal} ${t.points} (${t.sumQuestions})`}
                    </div>
                    
                    <!-- Direct Questions (without parts) -->
                    ${ex.questions.length > 0 || (ex.parts.length === 0) ? `
                        <div class="space-y-2 ml-4 mb-3">
                            ${ex.questions.map(q => renderQuestionBuilder(q, ex.id, null)).join('')}
                        </div>
                        <button onclick="addQuestion('${ex.id}', null)" class="ml-4 text-sm text-green-600 hover:text-green-800 px-3 py-1 bg-green-100 rounded">
                             ${t.addQuestion}
                        </button>
                    ` : ''}
                    
                    <!-- Parts -->
                    ${ex.parts.length > 0 ? `
                        <div class="space-y-3 mt-4">
                            ${ex.parts.map((part, partIndex) => `
                                <div class="border-2 border-purple-200 rounded-lg p-3 bg-purple-50 ml-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="text" value="${part.name}" 
                                            onchange="updatePartField('${ex.id}','${part.id}','name',this.value)"
                                            class="font-semibold text-purple-700 p-1 border rounded bg-white">
                                        <button onclick="removePart('${ex.id}','${part.id}')" class="text-red-500 hover:text-red-700 ml-auto">‚úï</button>
                                    </div>
                                    
                                    <div class="space-y-2 ml-4">
                                        ${part.questions.map(q => renderQuestionBuilder(q, ex.id, part.id)).join('')}
                                    </div>
                                    
                                    <button onclick="addQuestion('${ex.id}', '${part.id}')" class="mt-2 ml-4 text-sm text-green-600 hover:text-green-800 px-3 py-1 bg-green-100 rounded">
                                         ${t.addQuestion}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Add Part Button -->
                    <button onclick="addPart('${ex.id}')" class="mt-3 ml-4 text-sm text-purple-600 hover:text-purple-800 px-3 py-1 bg-purple-100 rounded">
                        + ${t.addPart}
                    </button>
                </div>
            `}).join('');
            }

            function saveAssignment() {
                const t = translations[currentLanguage];
                const name = document.getElementById('assignment-name').value.trim();
                const className = document.getElementById('assignment-class').value.trim();
                const globalCheckbox = document.getElementById('assignment-global-only');
                const globalMaxInput = document.getElementById('assignment-global-maxpoints');

                if (!name) return alert(t.enterAssignmentName);
                if (!className) return alert(t.selectAssignmentClass);

                // Mettre √† jour l‚Äô√©tat global
                isGlobalAssignment = globalCheckbox && globalCheckbox.checked;

                if (isGlobalAssignment) {
                    globalMaxPoints = parseFloat(globalMaxInput.value) || 0;
                    if (globalMaxPoints <= 0) {
                        alert('Note maximale invalide');
                        return;
                    }
                } else {
                    if (tempExercises.length === 0) {
                        return alert(t.addExerciseFirst);
                    }
                }

                let exercisesToSave;

                if (isGlobalAssignment) {
                    // On cr√©e un seul exercice "virtuel" sans questions
                    exercisesToSave = [{
                        id: genId(),
                        name: '',          // tu peux mettre 'Global' si tu veux l‚Äôafficher
                        maxPoints: globalMaxPoints,
                        questions: [],
                        parts: []
                    }];
                } else {
                    exercisesToSave = JSON.parse(JSON.stringify(tempExercises));
                }

                if (editingAssignmentId) {
                    // Mise √† jour
                    const assignment = data.assignments.find(a => a.id === editingAssignmentId);
                    if (assignment) {
                        assignment.name = name;
                        assignment.className = className;
                        assignment.exercises = exercisesToSave;
                    }
                } else {
                    // Cr√©ation
                    data.assignments.push({
                        id: genId(),
                        name,
                        className,
                        exercises: exercisesToSave
                    });
                }

                saveData();
                renderAssignments();
                closeAssignmentModal();
            }

            function deleteAssignment(id) {
                const t = translations[currentLanguage];
                if (!confirm(t.deleteAssignment)) return;
                data.assignments = data.assignments.filter(a => a.id !== id);
                // Clean grades
                for (let studentId in data.grades) {
                    delete data.grades[studentId][id];
                }
                saveData();
                renderAssignments();
            }

            function duplicateAssignment(id) {
                const original = data.assignments.find(a => a.id === id);
                if (!original) return;

                const newAssignment = {
                    id: genId(),
                    name: original.name + ' (copie)',
                    className: original.className,
                    exercises: JSON.parse(JSON.stringify(original.exercises))
                };

                data.assignments.push(newAssignment);
                saveData();
                renderAssignments();
            }

            function getAssignmentMaxPoints(assignment) {
                let total = 0;
                for (const ex of assignment.exercises) {
                    total += getExerciseMaxPoints(ex);
                }
                return total;
            }

            function getExerciseMaxPoints(ex) {
                const directQuestions = ex.questions || [];
                const parts = ex.parts || [];

                if (directQuestions.length === 0 && parts.length === 0) {
                    return ex.maxPoints || 0;
                }

                let total = 0;

                // Direct questions
                for (const q of directQuestions) {
                    total += getQuestionMaxPoints(q);
                }

                // Parts
                for (const part of parts) {
                    for (const q of (part.questions || [])) {
                        total += getQuestionMaxPoints(q);
                    }
                }

                return total;
            }

            function getQuestionMaxPoints(q) {
                // Si la question a des sous-questions, le total est la somme des sous-questions
                if (q.subQuestions && q.subQuestions.length > 0) {
                    return q.subQuestions.reduce((sum, sq) => sum + (sq.maxPoints || 0), 0);
                }
                // Sinon, utiliser les points directs de la question
                return q.maxPoints || 0;
            }

            function toggleAccordion(id) {
                const content = document.getElementById('accordion-' + id);
                const icon = document.getElementById('icon-' + id);
                content.classList.toggle('open');
                icon.classList.toggle('open');
            }

            function renderAssignments() {
                const t = translations[currentLanguage];
                const container = document.getElementById('assignments-list');
                const filterClass = document.getElementById('filter-class-assignments')?.value || '';
                const filterName = document.getElementById('filter-name-assignments')?.value.toLowerCase() || '';

                let filteredAssignments = data.assignments.filter(a => {
                    const matchClass = !filterClass || a.className === filterClass;
                    const matchName = !filterName || a.name.toLowerCase().includes(filterName);
                    return matchClass && matchName;
                });

                if (data.assignments.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${t.noAssignments}</p>`;
                    return;
                }

                if (filteredAssignments.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${t.noFilteredAssignments}</p>`;
                    return;
                }
                const groups = new Map();
                filteredAssignments.forEach(a => {
                    const key = a.className && a.className.trim() ? a.className : '(Sans classe)';
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push(a);
                });

                const groupHtml = Array.from(groups.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([className, list]) => {
                        const cards = list.map(a => `
                        <div class="border rounded-lg bg-white overflow-hidden shadow-sm">
                            <div class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer hover:bg-gray-100" onclick="toggleAccordion('${a.id}')">
                                <div class="flex items-center gap-3">
                                    <span id="icon-${a.id}" class="rotate-icon text-gray-400">‚ñº</span>
                                    <div>
                                        <h3 class="font-bold">${a.name}</h3>
                                        <span class="text-xs text-gray-500">
                                            ${getAssignmentMaxPoints(a)} ${t.points} ‚Ä¢ ${a.exercises.length} ${t.exerciseAbbr}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-2" onclick="event.stopPropagation()">
                                    <button onclick="openAssignmentModal('${a.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded" title="${t.edit}">‚úèÔ∏è</button>
                                    <button onclick="duplicateAssignment('${a.id}')" class="p-2 text-green-500 hover:bg-green-50 rounded" title="${t.duplicate}">‚éò</button>
                                    <button onclick="deleteAssignment('${a.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded" title="${t.delete}">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div id="accordion-${a.id}" class="accordion-content">
                                <div class="p-4 border-t space-y-3 bg-white text-sm">
                                    ${a.exercises.map((ex, i) => {
                            const parts = ex.parts || [];
                            const directQuestions = ex.questions || [];
                            let exContent = '';
                            if (directQuestions.length > 0) {
                                exContent += `<div class=\"ml-4 text-gray-600 mt-1\">${directQuestions.map(q => `<span class=\"inline-block mr-2\">${q.name || 'Q?'}: ${getQuestionMaxPoints(q)} ${t.points}</span>`).join(' ‚Ä¢ ')}</div>`;
                            }
                            if (parts.length > 0) {
                                exContent += parts.map(part => `
                                                <div class=\"ml-4 mt-1 border-l pl-2\">
                                                    <span class=\"text-purple-600 font-medium\">${part.name}:</span>
                                                    <span class=\"text-gray-500 italic\">(${(part.questions || []).map(q => q.name || 'Q?').join(', ')})</span>
                                                </div>
                                            `).join('');
                            }
                            return `
                                            <div class=\"bg-gray-50 p-2 rounded border-l-4 border-blue-400\">
                                                <strong>${t.exercise} ${i + 1}${ex.name ? ' - ' + ex.name : ''}</strong> (${getExerciseMaxPoints(ex)} ${t.points})
                                                ${exContent}
                                            </div>
                                        `;
                        }).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('');

                        return `
                        <div class="mb-6">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-semibold uppercase">${className}</span>
                                <span class="text-xs text-gray-500">${list.length} devoir(s)</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                ${cards}
                            </div>
                        </div>
                    `;
                    }).join('');

                container.innerHTML = groupHtml;
                translatePage();
            }
            // ===== GRADES =====
            function loadGradeSelectors() {
                const t = translations[currentLanguage];
                const assignmentSelect = document.getElementById('select-assignment');
                const studentSelect = document.getElementById('select-student');
                const classSelect = document.getElementById('select-class-grades');
                const selectedClass = classSelect.value;

                // Si aucune classe n'est s√©lectionn√©e, vider les listes
                if (!selectedClass) {
                    assignmentSelect.innerHTML = `<option value="">-- ${t.selectClassFirst} --</option>`;
                    studentSelect.innerHTML = `<option value="">-- ${t.selectClassFirst} --</option>`;
                    document.getElementById('grade-entry').innerHTML = `<p class="text-gray-500 text-center py-8">${t.selectClassToStart}</p>`;
                    return;
                }

                // Filtrer les devoirs par classe s√©lectionn√©e
                const filteredAssignments = data.assignments.filter(a => a.className === selectedClass);

                assignmentSelect.innerHTML = `<option value="">-- ${t.selectAssignment} --</option>` +
                    filteredAssignments.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

                // Filtrer les √©l√®ves par classe s√©lectionn√©e
                const filteredStudents = data.students.filter(s => s.className === selectedClass);

                studentSelect.innerHTML = `<option value="">-- ${t.selectStudent} --</option>` +
                    filteredStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                // Vider la zone de saisie de notes
                document.getElementById('grade-entry').innerHTML = `<p class="text-gray-500 text-center py-8">${t.selectAssignmentAndStudentToGrade}</p>`;
            }

            function renderGradeQuestion(q, studentId, assignmentId, exId, partId = null) {
                const studentGrades = data.grades[studentId]?.[assignmentId]?.[exId] || {};
                const partKey = partId || 'direct';
                if (!studentGrades[partKey]) studentGrades[partKey] = {};
                const qGrades = studentGrades[partKey][q.id] || {};
                const mode = studentGrades.mode || ((studentGrades['final']?.['final']?.['final'] || '') !== '' ? 'global' : 'detail');

                let qHtml = `<div class="grade-question-card">
                <div class="question-header">
                    <span class="question-title">${getQuestionDisplayName(assignmentId, exId, q.id, partId)}</span>
                    <span class="question-score" id="q-total-${q.id}">0 / ${getQuestionMaxPoints(q)}</span>
                </div>`;

                if (!q.subQuestions || q.subQuestions.length === 0) {
                    const val = qGrades['direct'] || '';
                    qHtml += `<div class="question-direct-entry ${mode === 'global' ? 'opacity-50 pointer-events-none' : ''}">
                    <input type="number" min="0" max="${q.maxPoints}" step="0.25" value="${val}"
                        ${mode === 'global' ? 'disabled' : ''}
                        onchange="updateGrade('${studentId}','${assignmentId}','${exId}','${partKey}','${q.id}','direct',this.value)"
                        class="grade-input p-2 border rounded text-center font-semibold" title="La note globale d√©sactive la saisie d√©taill√©e">
                    <span class="question-max">/ ${q.maxPoints}</span>
                </div>`;
                } else {
                    qHtml += `<div class="subquestion-grid">`;
                    qHtml += q.subQuestions.map(sq => {
                        const val = qGrades[sq.id] || '';
                        return `<div class="subquestion-chip ${mode === 'global' ? 'opacity-50 pointer-events-none' : ''}">
                        <div class="subquestion-chip-header">
                            <span>${getSubQuestionLetter(q, sq.id)})</span>
                            <span class="text-xs text-gray-500">/${sq.maxPoints}</span>
                        </div>
                        <input type="number" min="0" max="${sq.maxPoints}" step="0.25" value="${val}"
                            ${mode === 'global' ? 'disabled' : ''}
                            onchange="updateGrade('${studentId}','${assignmentId}','${exId}','${partKey}','${q.id}','${sq.id}',this.value)"
                            class="grade-input p-2 border rounded text-center font-semibold" title="La note globale d√©sactive la saisie d√©taill√©e">
                    </div>`;
                    }).join('');
                    qHtml += `</div>`;
                }

                qHtml += `</div>`;
                return qHtml;
            }

            function getQuestionDisplayName(assignmentId, exId, qId, partId) {
                const t = translations[currentLanguage];
                const assignment = data.assignments.find(a => a.id === assignmentId);
                if (!assignment) return `${t.questionPrefix}?`;
                const ex = assignment.exercises.find(e => e.id === exId);
                if (!ex) return `${t.questionPrefix}?`;
                let list = [];
                if (partId) {
                    const part = (ex.parts || []).find(p => p.id === partId);
                    list = part ? (part.questions || []) : [];
                } else {
                    list = ex.questions || [];
                }
                const idx = Math.max(0, list.findIndex(x => x.id === qId));
                return `${t.questionPrefix}${idx + 1}`;
            }

            function getSubQuestionLetter(q, sqId) {
                const t = translations[currentLanguage];
                const letters = (t.subQuestionLetters || '').split('');
                const idx = Math.max(0, (q.subQuestions || []).findIndex(s => s.id === sqId));
                return letters[idx] || letters[0] || '?';
            }

            function loadGradeEntry() {
                const t = translations[currentLanguage];
                const assignmentId = document.getElementById('select-assignment').value;
                const studentId = document.getElementById('select-student').value;
                const container = document.getElementById('grade-entry');

                if (!assignmentId || !studentId) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${t.selectAssignmentAndStudentToGrade}</p>`;
                    return;
                }

                const assignment = data.assignments.find(a => a.id === assignmentId);
                const student = data.students.find(s => s.id === studentId);

                if (!data.grades[studentId]) data.grades[studentId] = {};
                if (!data.grades[studentId][assignmentId]) data.grades[studentId][assignmentId] = {};

                let html = `<div class="bg-blue-50 p-4 rounded-lg mb-4">
        <h3 class="font-bold text-xl">${student.name} - ${assignment.name}</h3>
        <p class="text-2xl font-bold text-blue-600 mt-2">${t.total}: <span id="grade-total">0</span> / ${getAssignmentMaxPoints(assignment)}</p>
    </div>`;

                html += assignment.exercises.map((ex, exIndex) => {
                    if (!data.grades[studentId][assignmentId][ex.id]) {
                        data.grades[studentId][assignmentId][ex.id] = {};
                    }

                    const directQuestions = ex.questions || [];
                    const parts = ex.parts || [];
                    const hasQuestions = directQuestions.length > 0 || parts.length > 0;

                    const exGradesCur = data.grades[studentId][assignmentId][ex.id] || {};
                    const finalGradeCur = exGradesCur['final']?.['final']?.['final'] || '';
                    const modeCur = exGradesCur.mode || (finalGradeCur !== '' ? 'global' : 'detail');

                    const accordionId = `grade-ex-${ex.id}`;

                    let exHtml = `
        <div class="border rounded-lg overflow-hidden bg-white mb-3">
            <div class="bg-gray-100 p-4 flex justify-between items-center cursor-pointer hover:bg-gray-200 transition-colors" 
                 onclick="toggleAccordion('${accordionId}')">
                <div class="flex items-center gap-3">
                    <span id="icon-${accordionId}" class="rotate-icon text-gray-400">‚ñº</span>
                    <span class="font-bold">${t.exercise} ${exIndex + 1}${ex.name ? ' - ' + ex.name : ''}</span>
                </div>
                <span class="text-blue-700 font-bold bg-white px-3 py-1 rounded-full shadow-sm text-sm" id="ex-total-${ex.id}">0 / ${getExerciseMaxPoints(ex)}</span>
            </div>
            
            <div id="accordion-${accordionId}" class="accordion-content">
                <div class="p-4 space-y-4 border-t">
                    <div class="flex items-center gap-3">
                        <div class="inline-flex border rounded overflow-hidden text-sm">
                            <button type="button" class="px-3 py-1 ${modeCur === 'detail' ? 'bg-blue-600 text-white' : 'bg-white'}" onclick="setExerciseMode('${studentId}','${assignmentId}','${ex.id}','detail')">Œ£ ${translations[currentLanguage].detailMode}</button>
                            <button type="button" class="px-3 py-1 ${modeCur === 'global' ? 'bg-yellow-500 text-white' : 'bg-white'}" onclick="setExerciseMode('${studentId}','${assignmentId}','${ex.id}','global')">‚òÖ ${translations[currentLanguage].globalMode}</button>
                        </div>
                    </div>`;

                    // Note finale optionnelle
                    if (hasQuestions) {
                        const finalGrade = data.grades[studentId][assignmentId][ex.id]?.['final']?.['final']?.['final'] || '';
                        exHtml += `
                <div class="flex items-center gap-3 mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                    <span class="text-sm font-semibold text-yellow-800">${t.globalGrade}</span>
                    <input type="number" min="0" max="${getExerciseMaxPoints(ex)}" step="0.25" value="${finalGrade}"
                        ${modeCur === 'detail' ? 'disabled' : ''}
                        title="La note globale d√©sactive la saisie d√©taill√©e"
                        onchange="updateGrade('${studentId}','${assignmentId}','${ex.id}','final','final','final',this.value)"
                        class="grade-input w-20 p-2 border rounded text-center font-bold bg-white ${modeCur === 'detail' ? 'opacity-50' : ''}" onclick="event.stopPropagation()">
                    <span class="text-xs text-yellow-600 italic">${t.ignoresDetails}</span>
                </div>`;
                    }

                    if (directQuestions.length === 0 && parts.length === 0) {
                        // Pas de questions : note directe
                        const val = data.grades[studentId][assignmentId][ex.id]?.['direct']?.['direct']?.['direct'] || '';
                        exHtml += `
                <div class="flex items-center gap-4 bg-blue-50 p-4 rounded-lg">
                    <span class="font-semibold">${t.grade}</span>
                    <input type="number" min="0" max="${ex.maxPoints}" step="0.25" value="${val}"
                        onchange="updateGrade('${studentId}','${assignmentId}','${ex.id}','direct','direct','direct',this.value)"
                        class="grade-input w-24 p-2 border rounded text-center font-bold text-lg" onclick="event.stopPropagation()">
                    <span class="text-gray-500 text-lg">/ ${ex.maxPoints}</span>
                </div>`;
                    } else {
                        // Questions directes
                        if (directQuestions.length > 0) {
                            exHtml += `<div class="grade-question-grid">` + directQuestions.map(q => renderGradeQuestion(q, studentId, assignmentId, ex.id, null)).join('') + `</div>`;
                        }

                        // Parties
                        if (parts.length > 0) {
                            exHtml += parts.map(part => {
                                return `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-bold text-purple-700 mb-3 flex items-center gap-2">
                            <span class="w-2 h-2 bg-purple-400 rounded-full"></span> ${part.name}
                        </h4>
                        <div class="grade-question-grid">
                            ${(part.questions || []).map(q => renderGradeQuestion(q, studentId, assignmentId, ex.id, part.id)).join('')}
                        </div>
                    </div>`;
                            }).join('');
                        }
                    }

                    exHtml += `</div></div></div>`;
                    return exHtml;
                }).join('');

                container.innerHTML = html;
                saveData();
                recalculateTotals(assignmentId, studentId);
                translatePage();
            }
            function updateGrade(studentId, assignmentId, exId, partKey, qId, sqId, value) {
                if (!data.grades[studentId]) data.grades[studentId] = {};
                if (!data.grades[studentId][assignmentId]) data.grades[studentId][assignmentId] = {};
                if (!data.grades[studentId][assignmentId][exId]) data.grades[studentId][assignmentId][exId] = {};
                if (!data.grades[studentId][assignmentId][exId][partKey]) data.grades[studentId][assignmentId][exId][partKey] = {};
                if (!data.grades[studentId][assignmentId][exId][partKey][qId]) data.grades[studentId][assignmentId][exId][partKey][qId] = {};

                data.grades[studentId][assignmentId][exId][partKey][qId][sqId] = parseFloat(value) || 0;
                if (!(partKey === 'final' && qId === 'final' && sqId === 'final')) {
                    const exGrades = data.grades[studentId][assignmentId][exId];
                    exGrades.mode = 'detail';
                    if (exGrades && exGrades.final && exGrades.final.final && typeof exGrades.final.final.final !== 'undefined') {
                        exGrades.final.final.final = '';
                    }
                }

                saveData();
                recalculateTotals(assignmentId, studentId);
            }

            function setExerciseMode(studentId, assignmentId, exId, mode) {
                if (!data.grades[studentId]) data.grades[studentId] = {};
                if (!data.grades[studentId][assignmentId]) data.grades[studentId][assignmentId] = {};
                if (!data.grades[studentId][assignmentId][exId]) data.grades[studentId][assignmentId][exId] = {};
                const exGrades = data.grades[studentId][assignmentId][exId];
                exGrades.mode = mode;
                if (mode === 'detail') {
                    if (!exGrades.final) exGrades.final = {};
                    if (!exGrades.final.final) exGrades.final.final = {};
                    exGrades.final.final.final = '';
                }
                saveData();
                recalculateTotals(assignmentId, studentId);
                loadGradeEntry();
            }

            function recalculateTotals(assignmentId, studentId) {
                const assignment = data.assignments.find(a => a.id === assignmentId);
                const studentGrades = data.grades[studentId]?.[assignmentId] || {};

                let grandTotal = 0;

                for (const ex of assignment.exercises) {
                    let exTotal = 0;
                    const exGrades = studentGrades[ex.id] || {};
                    const directQuestions = ex.questions || [];
                    const parts = ex.parts || [];
                    const hasQuestions = directQuestions.length > 0 || parts.length > 0;

                    // V√©rifier si une note finale a √©t√© saisie
                    const finalGrade = exGrades['final']?.['final']?.['final'];

                    if (finalGrade !== undefined && finalGrade !== '') {
                        // Utiliser la note finale si elle est d√©finie
                        exTotal = parseFloat(finalGrade) || 0;
                    } else if (directQuestions.length === 0 && parts.length === 0) {
                        // Exercice sans questions
                        exTotal = exGrades['direct']?.['direct']?.['direct'] || 0;
                    } else {
                        // Calculer √† partir des questions d√©taill√©es
                        // Direct questions
                        for (const q of directQuestions) {
                            let qTotal = 0;
                            const qGrades = exGrades['direct']?.[q.id] || {};

                            if (!q.subQuestions || q.subQuestions.length === 0) {
                                qTotal = qGrades['direct'] || 0;
                            } else {
                                for (const sq of q.subQuestions) {
                                    qTotal += qGrades[sq.id] || 0;
                                }
                            }

                            const qEl = document.getElementById('q-total-' + q.id);
                            if (qEl) qEl.textContent = qTotal + ' / ' + getQuestionMaxPoints(q);
                            exTotal += qTotal;
                        }

                        // Parts
                        for (const part of parts) {
                            for (const q of (part.questions || [])) {
                                let qTotal = 0;
                                const qGrades = exGrades[part.id]?.[q.id] || {};

                                if (!q.subQuestions || q.subQuestions.length === 0) {
                                    qTotal = qGrades['direct'] || 0;
                                } else {
                                    for (const sq of q.subQuestions) {
                                        qTotal += qGrades[sq.id] || 0;
                                    }
                                }

                                const qEl = document.getElementById('q-total-' + q.id);
                                if (qEl) qEl.textContent = qTotal + ' / ' + getQuestionMaxPoints(q);
                                exTotal += qTotal;
                            }
                        }
                    }

                    const exEl = document.getElementById('ex-total-' + ex.id);
                    if (exEl) {
                        exEl.textContent = exTotal + ' / ' + getExerciseMaxPoints(ex);
                        const isGlobal = finalGrade !== undefined && finalGrade !== '';
                        exEl.className = `text-blue-700 font-bold ${isGlobal ? 'bg-yellow-100' : 'bg-white'} px-3 py-1 rounded-full shadow-sm text-sm`;
                    }
                    grandTotal += exTotal;
                }

                const totalEl = document.getElementById('grade-total');
                if (totalEl) totalEl.textContent = grandTotal;
            }

            function getStudentAssignmentTotal(studentId, assignmentId) {
                const assignment = data.assignments.find(a => a.id === assignmentId);
                if (!assignment) return 0;
                const studentGrades = data.grades[studentId]?.[assignmentId] || {};

                if (studentGrades.global !== undefined && studentGrades.global !== '') {
                    return parseFloat(studentGrades.global) || 0;
                }

                let total = 0;
                for (const ex of assignment.exercises) {
                    total += getStudentExerciseTotal(studentGrades, ex);
                }
                return total;
            }

            function getStudentExerciseTotal(studentGrades, ex) {
                const exGrades = studentGrades[ex.id] || {};
                const directQuestions = ex.questions || [];
                const parts = ex.parts || [];

                // V√©rifier si une note finale a √©t√© saisie
                const finalGrade = exGrades['final']?.['final']?.['final'];
                if (finalGrade !== undefined && finalGrade !== '') {
                    return parseFloat(finalGrade) || 0;
                }

                if (directQuestions.length === 0 && parts.length === 0) {
                    return exGrades['direct']?.['direct']?.['direct'] || 0;
                }

                let total = 0;

                // Direct questions
                for (const q of directQuestions) {
                    const qGrades = exGrades['direct']?.[q.id] || {};
                    if (!q.subQuestions || q.subQuestions.length === 0) {
                        total += qGrades['direct'] || 0;
                    } else {
                        for (const sq of q.subQuestions) {
                            total += qGrades[sq.id] || 0;
                        }
                    }
                }

                // Parts
                for (const part of parts) {
                    for (const q of (part.questions || [])) {
                        const qGrades = exGrades[part.id]?.[q.id] || {};
                        if (!q.subQuestions || q.subQuestions.length === 0) {
                            total += qGrades['direct'] || 0;
                        } else {
                            for (const sq of q.subQuestions) {
                                total += qGrades[sq.id] || 0;
                            }
                        }
                    }
                }

                return total;
            }

            // ===== SUMMARY =====
            let currentSummaryMode = 'default'; // Mode par d√©faut

            function setSummaryMode(mode) {
                currentSummaryMode = mode;
                renderSummary(); // Rafra√Æchit l'affichage avec le nouveau mode
            }


            function renderSummary() {
                switch (currentSummaryMode) {
                    case 'grouped':
                        renderSummary2();
                        break;
                    case 'view1':
                        renderSummary1();
                        break;
                    default: // 'default' ou toute autre valeur
                        renderSummary0();
                }
            }

            function renderSummary0() {
                const t = translations[currentLanguage];
                const container = document.getElementById('summary-table');
                const detailsCheckbox = document.getElementById('show-details');
                let showDetails = detailsCheckbox ? detailsCheckbox.checked : false;
                const classSelect = document.getElementById('select-class-summary');
                const searchInput = document.getElementById('summary-search');
                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

                let selectedClass = classSelect ? classSelect.value : '';
                let searchMatches = data.students.slice();

                if (searchTerm) {
                    searchMatches = searchMatches.filter(s => {
                        const haystack = `${s.name || ''} ${s.firstName || ''} ${s.lastName || ''} ${s.className || ''}`.toLowerCase();
                        return haystack.includes(searchTerm);
                    });
                }

                const matchingClasses = Array.from(new Set(
                    searchMatches
                        .map(s => (s.className || '').trim())
                        .filter(c => c.length > 0)
                )).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

                if (classSelect) {
                    const previousValue = selectedClass;
                    classSelect.innerHTML = `<option value="">-- ${t.selectClass} --</option>` +
                        matchingClasses.map(c => `<option value="${c}" ${c === previousValue ? 'selected' : ''}>${c}</option>`).join('');

                    let autoSelectedClass = '';
                    if (searchMatches.length === 1 && searchMatches[0].className) {
                        autoSelectedClass = searchMatches[0].className;
                    } else if (matchingClasses.length === 1) {
                        autoSelectedClass = matchingClasses[0];
                    }

                    if (autoSelectedClass) {
                        classSelect.value = autoSelectedClass;
                    } else if (matchingClasses.includes(previousValue)) {
                        classSelect.value = previousValue;
                    } else {
                        classSelect.value = '';
                    }

                    selectedClass = classSelect.value;
                }

                let filteredStudents = searchMatches;
                if (selectedClass) {
                    filteredStudents = filteredStudents.filter(s => s.className === selectedClass);
                }

                let filteredAssignments = data.assignments.slice();
                if (selectedClass) {
                    filteredAssignments = filteredAssignments.filter(a => a.className === selectedClass);
                } else {
                    const classFilterSet = new Set(matchingClasses);
                    filteredAssignments = filteredAssignments.filter(a => classFilterSet.has(a.className));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) {
                    filteredAssignments = filteredAssignments.filter(a => summaryAssignmentFilter.has(a.id));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0 && !selectedClass) {
                    const allowedClasses = new Set(filteredAssignments.map(a => (a.className || '').trim()).filter(c => c.length > 0));
                    filteredStudents = filteredStudents.filter(s => allowedClasses.has((s.className || '').trim()));
                }

                if (!window.summaryAssignmentOrder) {
                    try {
                        window.summaryAssignmentOrder = JSON.parse(localStorage.getItem('summary-assignment-order') || '[]');
                    } catch (e) { window.summaryAssignmentOrder = []; }
                }
                const ensureOrderIds = () => {
                    const ids = filteredAssignments.map(a => a.id);
                    const set = new Set(window.summaryAssignmentOrder);
                    ids.forEach(id => { if (!set.has(id)) window.summaryAssignmentOrder.push(id); });
                };
                ensureOrderIds();
                filteredAssignments.sort((a, b) => {
                    const oa = window.summaryAssignmentOrder.indexOf(a.id);
                    const ob = window.summaryAssignmentOrder.indexOf(b.id);
                    if (oa === -1 && ob === -1) return 0;
                    if (oa === -1) return 1;
                    if (ob === -1) return -1;
                    return oa - ob;
                });

                const isAllStudents = !selectedClass && !searchTerm && filteredStudents.length === data.students.length;
                const assignmentsFiltered = (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) || filteredAssignments.length < data.assignments.length;
                if (detailsCheckbox) {
                    const shouldDisableDetails = isAllStudents && !assignmentsFiltered;
                    if (shouldDisableDetails) {
                        detailsCheckbox.checked = false;
                        detailsCheckbox.disabled = true;
                    } else {
                        detailsCheckbox.disabled = false;
                    }
                    showDetails = detailsCheckbox.checked;
                }

                if (filteredStudents.length === 0 || filteredAssignments.length === 0) {
                    let emptyMessage = '';
                    if (selectedClass) {
                        emptyMessage = `${t.noStudentOrAssignmentForClass} "${selectedClass}".`;
                    } else if (searchTerm) {
                        emptyMessage = t.noResultForSearch;
                    } else {
                        emptyMessage = t.addStudentsAndAssignmentsToSeeSummary;
                    }
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessage}</p>`;
                    return;
                }

                // TRI PAR CLASSE PUIS PAR NOM/NOTE
                filteredStudents.sort((a, b) => {
                    // 1. Tri par classe d'abord
                    const classA = (a.className || '').toLowerCase();
                    const classB = (b.className || '').toLowerCase();

                    if (classA !== classB) {
                        return classA.localeCompare(classB, 'fr', { sensitivity: 'base' });
                    }

                    // 2. Ensuite tri selon la colonne choisie
                    if (summarySort.key === 'name') {
                        const na = (a.name || '').toLowerCase();
                        const nb = (b.name || '').toLowerCase();
                        if (na < nb) return summarySort.direction === 'asc' ? -1 : 1;
                        if (na > nb) return summarySort.direction === 'asc' ? 1 : -1;
                        return 0;
                    } else if (summarySort.key.startsWith('assignment-')) {
                        const assignmentId = summarySort.key.split('assignment-')[1];
                        const ta = getStudentAssignmentTotal(a.id, assignmentId);
                        const tb = getStudentAssignmentTotal(b.id, assignmentId);
                        if (ta < tb) return summarySort.direction === 'asc' ? -1 : 1;
                        if (ta > tb) return summarySort.direction === 'asc' ? 1 : -1;
                        return 0;
                    }

                    return 0;
                });

                let headers = `<th class="p-3 text-left bg-gray-100 sticky left-0 z-10 cursor-pointer select-none" onclick="toggleSummarySort('name')">${t.student}</th>`;

                const tagContainer = document.getElementById('summary-assignment-tags');
                if (tagContainer) {
                    const tagHtml = filteredAssignments.map(a => {
                        const selected = summaryAssignmentFilter.has(a.id);
                        return `<div class="flex items-center gap-1">
                <button class="assignment-tag ${selected ? 'selected' : ''}" onclick="toggleSummaryAssignmentTag('${a.id}')">${a.name}</button>
                <button class="px-2 py-1 text-xs bg-gray-100 rounded" onclick="moveSummaryAssignmentLeft('${a.id}')">‚óÄ</button>
                <button class="px-2 py-1 text-xs bg-gray-100 rounded" onclick="moveSummaryAssignmentRight('${a.id}')">‚ñ∂</button>
            </div>`;
                    }).join('');
                    tagContainer.innerHTML = tagHtml;
                }

                for (const a of filteredAssignments) {
                    if (showDetails) {
                        for (const ex of a.exercises) {
                            const exIndex = a.exercises.indexOf(ex) + 1;
                            headers += `<th class="p-2 text-center bg-blue-50 text-sm">Ex${exIndex}<br><span class="text-xs text-gray-500">/${getExerciseMaxPoints(ex)}</span></th>`;
                        }
                    }
                    headers += `<th class="p-3 text-center bg-blue-100 font-bold cursor-pointer select-none" onclick="toggleSummarySort('assignment-${a.id}')">${a.name}<br><span class="text-xs">/${getAssignmentMaxPoints(a)}</span></th>`;
                }

                // GROUPEMENT PAR CLASSE DANS L'AFFICHAGE
                let currentClass = '';
                let rows = filteredStudents.map(s => {
                    let classHeader = '';

                    // Ajouter une ligne de s√©paration pour chaque nouvelle classe
                    if (s.className !== currentClass) {
                        currentClass = s.className;
                        const colspan = 1 + (showDetails ? filteredAssignments.reduce((sum, a) => sum + (a.exercises || []).length, 0) : 0) + filteredAssignments.length;
                        classHeader = `<tr class="bg-blue-600 text-white font-bold">
                <td colspan="${colspan}" class="p-2 text-center text-lg">
                    ${s.className || '(Sans classe)'}
                </td>
            </tr>`;
                    }

                    let row = `<td class="p-3 font-medium bg-gray-50 sticky left-0">${s.name}</td>`;

                    for (const a of filteredAssignments) {
                        const studentGrades = data.grades[s.id]?.[a.id] || {};
                        const isCompatible = ((s.className || '').trim() === (a.className || '').trim());

                        if (showDetails) {
                            for (const ex of a.exercises) {
                                if (isCompatible) {
                                    const exTotal = getStudentExerciseTotal(studentGrades, ex);
                                    const max = getExerciseMaxPoints(ex);
                                    const existingFinal = studentGrades[ex.id]?.['final']?.['final']?.['final'];
                                    const hasEx = hasAnyGradeForExercise(studentGrades, ex);
                                    const val = existingFinal !== undefined && existingFinal !== '' ? existingFinal : (hasEx ? exTotal.toFixed(2) : '');
                                    row += `<td class="px-2 py-1 text-center">
                            <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" value="${val}" oninput="sanitizeAndClamp(this, ${max})" onblur="commitSummaryInput('${s.id}','${a.id}','${ex.id}', ${max}, this.value)" onkeydown="handleSummaryInputKey(event, '${s.id}','${a.id}','${ex.id}', ${max})" onfocus="this.select()" id="sum-input-${s.id}-${a.id}-${ex.id}" name="sum-input-${s.id}-${a.id}-${ex.id}" aria-label="Note Ex${a.exercises.indexOf(ex) + 1} pour ${s.name} - ${a.name}" class="summary-grade-input">
                        </td>`;
                                } else {
                                    row += `<td class="px-2 py-1 text-center text-gray-300 bg-gray-50">-</td>`;
                                }
                            }
                        }

                        if (isCompatible) {
                            const has = hasAnyGradeForAssignment(s.id, a.id);
                            if (has) {
                                const total = getStudentAssignmentTotal(s.id, a.id);
                                const max = getAssignmentMaxPoints(a);
                                const pct = max > 0 ? (total / max * 100) : 0;
                                const bgColor = pct >= 70 ? 'bg-green-100' : pct >= 50 ? 'bg-orange-100' : 'bg-red-100';
                                row += `<td class="p-3 text-center font-bold ${bgColor}" id="sum-total-${s.id}-${a.id}">${total.toFixed(2)}</td>`;
                            } else {
                                row += `<td class="p-3 text-center text-gray-400 bg-gray-50" id="sum-total-${s.id}-${a.id}"></td>`;
                            }
                        } else {
                            row += `<td class="p-3 text-center text-gray-400 bg-gray-50">-</td>`;
                        }
                    }

                    return classHeader + `<tr class="border-b hover:bg-gray-50">${row}</tr>`;
                }).join('');

                const colgroupHtml = (() => {
                    let cols = '<col style="width:220px">';
                    for (const a of filteredAssignments) {
                        if (showDetails) {
                            const exCount = (a.exercises || []).length;
                            for (let i = 0; i < exCount; i++) cols += '<col style="width:70px">';
                        }
                        cols += '<col style="width:84px">';
                    }
                    return `<colgroup>${cols}</colgroup>`;
                })();

                container.innerHTML = `
        <table class="w-full table-fixed border-collapse">
            ${colgroupHtml}
            <thead><tr class="border-b-2">${headers}</tr></thead>
            <tbody>${rows}</tbody>
        </table>
    `;
                translatePage();
            }
            function renderSummary1() {
                const t = translations[currentLanguage];
                const container = document.getElementById('summary-table');
                const detailsCheckbox = document.getElementById('show-details');
                let showDetails = detailsCheckbox ? detailsCheckbox.checked : false;
                const classSelect = document.getElementById('select-class-summary');
                const searchInput = document.getElementById('summary-search');
                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

                let selectedClass = classSelect ? classSelect.value : '';
                let searchMatches = data.students.slice();

                if (searchTerm) {
                    searchMatches = searchMatches.filter(s => {
                        const haystack = `${s.name || ''} ${s.firstName || ''} ${s.lastName || ''} ${s.className || ''}`.toLowerCase();
                        return haystack.includes(searchTerm);
                    });
                }

                const matchingClasses = Array.from(new Set(
                    searchMatches
                        .map(s => (s.className || '').trim())
                        .filter(c => c.length > 0)
                )).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

                if (classSelect) {
                    const previousValue = selectedClass;
                    classSelect.innerHTML = `<option value="">-- ${t.selectClass} --</option>` +
                        matchingClasses.map(c => `<option value="${c}" ${c === previousValue ? 'selected' : ''}>${c}</option>`).join('');

                    let autoSelectedClass = '';
                    if (searchMatches.length === 1 && searchMatches[0].className) {
                        autoSelectedClass = searchMatches[0].className;
                    } else if (matchingClasses.length === 1) {
                        autoSelectedClass = matchingClasses[0];
                    }

                    if (autoSelectedClass) {
                        classSelect.value = autoSelectedClass;
                    } else if (matchingClasses.includes(previousValue)) {
                        classSelect.value = previousValue;
                    } else {
                        classSelect.value = '';
                    }

                    selectedClass = classSelect.value;
                }

                let filteredStudents = searchMatches;
                if (selectedClass) {
                    filteredStudents = filteredStudents.filter(s => s.className === selectedClass);
                }

                let filteredAssignments = data.assignments.slice();
                if (selectedClass) {
                    filteredAssignments = filteredAssignments.filter(a => a.className === selectedClass);
                } else {
                    const classFilterSet = new Set(matchingClasses);
                    filteredAssignments = filteredAssignments.filter(a => classFilterSet.has(a.className));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) {
                    filteredAssignments = filteredAssignments.filter(a => summaryAssignmentFilter.has(a.id));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0 && !selectedClass) {
                    const allowedClasses = new Set(filteredAssignments.map(a => (a.className || '').trim()).filter(c => c.length > 0));
                    filteredStudents = filteredStudents.filter(s => allowedClasses.has((s.className || '').trim()));
                }

                if (!window.summaryAssignmentOrder) {
                    try {
                        window.summaryAssignmentOrder = JSON.parse(localStorage.getItem('summary-assignment-order') || '[]');
                    } catch (e) { window.summaryAssignmentOrder = []; }
                }
                const ensureOrderIds = () => {
                    const ids = filteredAssignments.map(a => a.id);
                    const set = new Set(window.summaryAssignmentOrder);
                    ids.forEach(id => { if (!set.has(id)) window.summaryAssignmentOrder.push(id); });
                };
                ensureOrderIds();

                // NOUVEAU : Grouper les devoirs par classe et trier
                const classesInOrder = Array.from(new Set(
                    filteredStudents.map(s => (s.className || '').trim())
                )).filter(c => c.length > 0).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

                // Cr√©er un map des devoirs par classe
                const assignmentsByClass = {};
                classesInOrder.forEach(className => {
                    assignmentsByClass[className] = filteredAssignments
                        .filter(a => (a.className || '').trim() === className)
                        .sort((a, b) => {
                            const oa = window.summaryAssignmentOrder.indexOf(a.id);
                            const ob = window.summaryAssignmentOrder.indexOf(b.id);
                            if (oa === -1 && ob === -1) return 0;
                            if (oa === -1) return 1;
                            if (ob === -1) return -1;
                            return oa - ob;
                        });
                });

                // Cr√©er la liste ordonn√©e des devoirs (par classe)
                const orderedAssignments = [];
                classesInOrder.forEach(className => {
                    orderedAssignments.push(...(assignmentsByClass[className] || []));
                });

                const isAllStudents = !selectedClass && !searchTerm && filteredStudents.length === data.students.length;
                const assignmentsFiltered = (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) || filteredAssignments.length < data.assignments.length;
                if (detailsCheckbox) {
                    const shouldDisableDetails = isAllStudents && !assignmentsFiltered;
                    if (shouldDisableDetails) {
                        detailsCheckbox.checked = false;
                        detailsCheckbox.disabled = true;
                    } else {
                        detailsCheckbox.disabled = false;
                    }
                    showDetails = detailsCheckbox.checked;
                }

                if (filteredStudents.length === 0 || orderedAssignments.length === 0) {
                    let emptyMessage = '';
                    if (selectedClass) {
                        emptyMessage = `${t.noStudentOrAssignmentForClass} "${selectedClass}".`;
                    } else if (searchTerm) {
                        emptyMessage = t.noResultForSearch;
                    } else {
                        emptyMessage = t.addStudentsAndAssignmentsToSeeSummary;
                    }
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessage}</p>`;
                    return;
                }

                // TRI DES √âL√àVES PAR CLASSE PUIS PAR NOM/NOTE
                filteredStudents.sort((a, b) => {
                    const classA = (a.className || '').toLowerCase();
                    const classB = (b.className || '').toLowerCase();

                    if (classA !== classB) {
                        return classA.localeCompare(classB, 'fr', { sensitivity: 'base' });
                    }

                    if (summarySort.key === 'name') {
                        const na = (a.name || '').toLowerCase();
                        const nb = (b.name || '').toLowerCase();
                        if (na < nb) return summarySort.direction === 'asc' ? -1 : 1;
                        if (na > nb) return summarySort.direction === 'asc' ? 1 : -1;
                        return 0;
                    } else if (summarySort.key.startsWith('assignment-')) {
                        const assignmentId = summarySort.key.split('assignment-')[1];
                        const ta = getStudentAssignmentTotal(a.id, assignmentId);
                        const tb = getStudentAssignmentTotal(b.id, assignmentId);
                        if (ta < tb) return summarySort.direction === 'asc' ? -1 : 1;
                        if (ta > tb) return summarySort.direction === 'asc' ? 1 : -1;
                        return 0;
                    }

                    return 0;
                });

                // NOUVEAU : Construire les en-t√™tes avec groupement par classe
                let classHeaderRow = `<th class="p-3 bg-gray-100 sticky left-0 z-10"></th>`;
                let assignmentHeaderRow = `<th class="p-3 text-left bg-gray-100 sticky left-0 z-10 cursor-pointer select-none" onclick="toggleSummarySort('name')">${t.student}</th>`;

                // Calculer le colspan pour chaque classe
                classesInOrder.forEach(className => {
                    const classAssignments = assignmentsByClass[className] || [];
                    if (classAssignments.length === 0) return;

                    let colspan = 0;
                    classAssignments.forEach(a => {
                        if (showDetails) {
                            colspan += (a.exercises || []).length;
                        }
                        colspan += 1; // Pour le total du devoir
                    });

                    // Couleurs altern√©es pour les classes
                    const classIndex = classesInOrder.indexOf(className);
                    const bgColor = classIndex % 2 === 0 ? 'bg-blue-600' : 'bg-indigo-600';

                    classHeaderRow += `<th colspan="${colspan}" class="p-2 text-center text-white font-bold ${bgColor} border-l-2 border-white">${className}</th>`;
                });

                // Construire les en-t√™tes des devoirs
                classesInOrder.forEach(className => {
                    const classAssignments = assignmentsByClass[className] || [];
                    const classIndex = classesInOrder.indexOf(className);
                    const bgLight = classIndex % 2 === 0 ? 'bg-blue-50' : 'bg-indigo-50';
                    const bgMedium = classIndex % 2 === 0 ? 'bg-blue-100' : 'bg-indigo-100';
                    let isFirstInClass = true;

                    classAssignments.forEach(a => {
                        const borderClass = isFirstInClass ? 'border-l-2 border-gray-300' : '';
                        isFirstInClass = false;

                        if (showDetails) {
                            a.exercises.forEach((ex, exIdx) => {
                                const exBorder = exIdx === 0 ? borderClass : '';
                                assignmentHeaderRow += `<th class="p-2 text-center ${bgLight} text-sm ${exBorder}">Ex${exIdx + 1}<br><span class="text-xs text-gray-500">/${getExerciseMaxPoints(ex)}</span></th>`;
                            });
                        }

                        const totalBorder = showDetails ? '' : borderClass;
                        assignmentHeaderRow += `<th class="p-3 text-center ${bgMedium} font-bold cursor-pointer select-none ${totalBorder}" onclick="toggleSummarySort('assignment-${a.id}')">${a.name}<br><span class="text-xs">/${getAssignmentMaxPoints(a)}</span></th>`;
                    });
                });

                // Tags pour filtrer les devoirs (group√©s par classe)
                const tagContainer = document.getElementById('summary-assignment-tags');
                if (tagContainer) {
                    let tagHtml = '';
                    classesInOrder.forEach(className => {
                        const classAssignments = assignmentsByClass[className] || [];
                        if (classAssignments.length === 0) return;

                        tagHtml += `<div class="flex flex-wrap items-center gap-1 p-2 bg-gray-100 rounded mb-2">
                <span class="font-bold text-sm text-gray-600 mr-2">${className}:</span>`;

                        classAssignments.forEach(a => {
                            const selected = summaryAssignmentFilter.has(a.id);
                            tagHtml += `<div class="flex items-center gap-1">
                    <button class="assignment-tag ${selected ? 'selected' : ''}" onclick="toggleSummaryAssignmentTag('${a.id}')">${a.name}</button>
                    <button class="px-2 py-1 text-xs bg-white rounded hover:bg-gray-200" onclick="moveSummaryAssignmentLeft('${a.id}')">‚óÄ</button>
                    <button class="px-2 py-1 text-xs bg-white rounded hover:bg-gray-200" onclick="moveSummaryAssignmentRight('${a.id}')">‚ñ∂</button>
                </div>`;
                        });

                        tagHtml += `</div>`;
                    });
                    tagContainer.innerHTML = tagHtml;
                }

                // CONSTRUIRE LES LIGNES DES √âL√àVES
                let currentClass = '';
                let rows = filteredStudents.map(s => {
                    let classHeader = '';
                    const studentClassName = (s.className || '').trim();

                    // Ajouter une ligne de s√©paration pour chaque nouvelle classe
                    if (studentClassName !== currentClass) {
                        currentClass = studentClassName;
                        const colspan = 1 + orderedAssignments.reduce((sum, a) => {
                            return sum + (showDetails ? (a.exercises || []).length : 0) + 1;
                        }, 0);
                        classHeader = `<tr class="bg-gray-800 text-white font-bold">
                <td colspan="${colspan}" class="p-2 text-center text-lg">
                    üìö ${studentClassName || '(Sans classe)'}
                </td>
            </tr>`;
                    }

                    let row = `<td class="p-3 font-medium bg-gray-50 sticky left-0 z-5">${s.name}</td>`;

                    // Parcourir les devoirs dans l'ordre des classes
                    let currentAssignmentClass = '';
                    classesInOrder.forEach(className => {
                        const classAssignments = assignmentsByClass[className] || [];
                        const classIndex = classesInOrder.indexOf(className);
                        const isStudentClass = studentClassName === className;
                        let isFirstInClass = true;

                        classAssignments.forEach(a => {
                            const studentGrades = data.grades[s.id]?.[a.id] || {};
                            const borderClass = isFirstInClass ? 'border-l-2 border-gray-200' : '';
                            isFirstInClass = false;

                            // Couleurs de fond altern√©es selon la classe du devoir
                            const bgEmpty = classIndex % 2 === 0 ? 'bg-blue-50/30' : 'bg-indigo-50/30';

                            if (showDetails) {
                                a.exercises.forEach((ex, exIdx) => {
                                    const exBorder = exIdx === 0 ? borderClass : '';
                                    if (isStudentClass) {
                                        const exTotal = getStudentExerciseTotal(studentGrades, ex);
                                        const max = getExerciseMaxPoints(ex);
                                        const existingFinal = studentGrades[ex.id]?.['final']?.['final']?.['final'];
                                        const hasEx = hasAnyGradeForExercise(studentGrades, ex);
                                        const val = existingFinal !== undefined && existingFinal !== '' ? existingFinal : (hasEx ? exTotal.toFixed(2) : '');
                                        row += `<td class="px-2 py-1 text-center ${exBorder}">
                                <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" 
                                    value="${val}" 
                                    oninput="sanitizeAndClamp(this, ${max})" 
                                    onblur="commitSummaryInput('${s.id}','${a.id}','${ex.id}', ${max}, this.value)" 
                                    onkeydown="handleSummaryInputKey(event, '${s.id}','${a.id}','${ex.id}', ${max})" 
                                    onfocus="this.select()" 
                                    id="sum-input-${s.id}-${a.id}-${ex.id}" 
                                    name="sum-input-${s.id}-${a.id}-${ex.id}" 
                                    aria-label="Note Ex${exIdx + 1} pour ${s.name} - ${a.name}" 
                                    class="summary-grade-input">
                            </td>`;
                                    } else {
                                        row += `<td class="px-2 py-1 text-center text-gray-300 ${bgEmpty} ${exBorder}">-</td>`;
                                    }
                                });
                            }

                            const totalBorder = showDetails ? '' : borderClass;
                            if (isStudentClass) {
                                const has = hasAnyGradeForAssignment(s.id, a.id);
                                if (has) {
                                    const total = getStudentAssignmentTotal(s.id, a.id);
                                    const max = getAssignmentMaxPoints(a);
                                    const pct = max > 0 ? (total / max * 100) : 0;
                                    const bgColor = pct >= 70 ? 'bg-green-100' : pct >= 50 ? 'bg-orange-100' : 'bg-red-100';
                                    row += `<td class="p-3 text-center font-bold ${bgColor} ${totalBorder}" id="sum-total-${s.id}-${a.id}">${total.toFixed(2)}</td>`;
                                } else {
                                    row += `<td class="p-3 text-center text-gray-300 ${bgEmpty} ${totalBorder}" id="sum-total-${s.id}-${a.id}"></td>`;
                                }
                            } else {
                                row += `<td class="p-3 text-center text-gray-300 ${bgEmpty} ${totalBorder}">-</td>`;
                            }
                        });
                    });

                    return classHeader + `<tr class="border-b hover:bg-gray-50">${row}</tr>`;
                }).join('');

                // Construire le colgroup pour les largeurs fixes
                const colgroupHtml = (() => {
                    let cols = '<col style="width:220px">';
                    orderedAssignments.forEach(a => {
                        if (showDetails) {
                            const exCount = (a.exercises || []).length;
                            for (let i = 0; i < exCount; i++) cols += '<col style="width:70px">';
                        }
                        cols += '<col style="width:84px">';
                    });
                    return `<colgroup>${cols}</colgroup>`;
                })();

                container.innerHTML = `
        <table class="w-full table-fixed border-collapse">
            ${colgroupHtml}
            <thead>
                <tr class="border-b">${classHeaderRow}</tr>
                <tr class="border-b-2">${assignmentHeaderRow}</tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
                translatePage();
            }
            function renderSummary2() {
                const t = translations[currentLanguage];
                const container = document.getElementById('summary-table');
                const detailsCheckbox = document.getElementById('show-details');
                let showDetails = detailsCheckbox ? detailsCheckbox.checked : false;
                const classSelect = document.getElementById('select-class-summary');
                const searchInput = document.getElementById('summary-search');
                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

                let selectedClass = classSelect ? classSelect.value : '';
                let searchMatches = data.students.slice();

                if (searchTerm) {
                    searchMatches = searchMatches.filter(s => {
                        const haystack = `${s.name || ''} ${s.firstName || ''} ${s.lastName || ''} ${s.className || ''}`.toLowerCase();
                        return haystack.includes(searchTerm);
                    });
                }

                const matchingClasses = Array.from(new Set(
                    searchMatches
                        .map(s => (s.className || '').trim())
                        .filter(c => c.length > 0)
                )).sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

                if (classSelect) {
                    const previousValue = selectedClass;
                    classSelect.innerHTML = `<option value="">-- ${t.selectClass} --</option>` +
                        matchingClasses.map(c => `<option value="${c}" ${c === previousValue ? 'selected' : ''}>${c}</option>`).join('');

                    let autoSelectedClass = '';
                    if (searchMatches.length === 1 && searchMatches[0].className) {
                        autoSelectedClass = searchMatches[0].className;
                    } else if (matchingClasses.length === 1) {
                        autoSelectedClass = matchingClasses[0];
                    }

                    if (autoSelectedClass) {
                        classSelect.value = autoSelectedClass;
                    } else if (matchingClasses.includes(previousValue)) {
                        classSelect.value = previousValue;
                    } else {
                        classSelect.value = '';
                    }

                    selectedClass = classSelect.value;
                }

                let filteredStudents = searchMatches;
                if (selectedClass) {
                    filteredStudents = filteredStudents.filter(s => s.className === selectedClass);
                }

                let filteredAssignments = data.assignments.slice();
                if (selectedClass) {
                    filteredAssignments = filteredAssignments.filter(a => a.className === selectedClass);
                } else {
                    const classFilterSet = new Set(matchingClasses);
                    filteredAssignments = filteredAssignments.filter(a => classFilterSet.has(a.className));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) {
                    filteredAssignments = filteredAssignments.filter(a => summaryAssignmentFilter.has(a.id));
                }

                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0 && !selectedClass) {
                    const allowedClasses = new Set(filteredAssignments.map(a => (a.className || '').trim()).filter(c => c.length > 0));
                    filteredStudents = filteredStudents.filter(s => allowedClasses.has((s.className || '').trim()));
                }

                if (!window.summaryAssignmentOrder) {
                    try {
                        window.summaryAssignmentOrder = JSON.parse(localStorage.getItem('summary-assignment-order') || '[]');
                    } catch (e) { window.summaryAssignmentOrder = []; }
                }
                const ensureOrderIds = () => {
                    const ids = filteredAssignments.map(a => a.id);
                    const set = new Set(window.summaryAssignmentOrder);
                    ids.forEach(id => { if (!set.has(id)) window.summaryAssignmentOrder.push(id); });
                };
                ensureOrderIds();
                filteredAssignments.sort((a, b) => {
                    const oa = window.summaryAssignmentOrder.indexOf(a.id);
                    const ob = window.summaryAssignmentOrder.indexOf(b.id);
                    if (oa === -1 && ob === -1) return 0;
                    if (oa === -1) return 1;
                    if (ob === -1) return -1;
                    return oa - ob;
                });

                const isAllStudents = !selectedClass && !searchTerm && filteredStudents.length === data.students.length;
                const assignmentsFiltered = (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) || filteredAssignments.length < data.assignments.length;
                if (detailsCheckbox) {
                    const shouldDisableDetails = isAllStudents && !assignmentsFiltered;
                    if (shouldDisableDetails) {
                        detailsCheckbox.checked = false;
                        detailsCheckbox.disabled = true;
                    } else {
                        detailsCheckbox.disabled = false;
                    }
                    showDetails = detailsCheckbox.checked;
                }

                if (filteredStudents.length === 0 || filteredAssignments.length === 0) {
                    let emptyMessage = '';
                    if (selectedClass) {
                        emptyMessage = `${t.noStudentOrAssignmentForClass} "${selectedClass}".`;
                    } else if (searchTerm) {
                        emptyMessage = t.noResultForSearch;
                    } else {
                        emptyMessage = t.addStudentsAndAssignmentsToSeeSummary;
                    }
                    container.innerHTML = `<p class="text-gray-500 text-center py-8">${emptyMessage}</p>`;
                    return;
                }

                // =====================================================
                // REGROUPEMENT PAR CLASSE
                // =====================================================

                // Regrouper les √©l√®ves par classe
                const studentsByClass = {};
                for (const student of filteredStudents) {
                    const className = (student.className || '').trim() || '(Sans classe)';
                    if (!studentsByClass[className]) {
                        studentsByClass[className] = [];
                    }
                    studentsByClass[className].push(student);
                }

                // Regrouper les devoirs par classe
                const assignmentsByClass = {};
                for (const assignment of filteredAssignments) {
                    const className = (assignment.className || '').trim() || '(Sans classe)';
                    if (!assignmentsByClass[className]) {
                        assignmentsByClass[className] = [];
                    }
                    assignmentsByClass[className].push(assignment);
                }

                // Liste des classes tri√©es
                const orderedClasses = Object.keys(studentsByClass).sort((a, b) =>
                    a.localeCompare(b, 'fr', { sensitivity: 'base' })
                );

                // Trier les √©l√®ves dans chaque classe
                for (const className of orderedClasses) {
                    studentsByClass[className].sort((a, b) => {
                        if (summarySort.key === 'name') {
                            const na = (a.name || '').toLowerCase();
                            const nb = (b.name || '').toLowerCase();
                            if (na < nb) return summarySort.direction === 'asc' ? -1 : 1;
                            if (na > nb) return summarySort.direction === 'asc' ? 1 : -1;
                            return 0;
                        } else if (summarySort.key.startsWith('assignment-')) {
                            const assignmentId = summarySort.key.split('assignment-')[1];
                            const ta = getStudentAssignmentTotal(a.id, assignmentId);
                            const tb = getStudentAssignmentTotal(b.id, assignmentId);
                            if (ta < tb) return summarySort.direction === 'asc' ? -1 : 1;
                            if (ta > tb) return summarySort.direction === 'asc' ? 1 : -1;
                            return 0;
                        }
                        return 0;
                    });
                }

                // Tags des devoirs (tous les devoirs filtr√©s)
                const tagContainer = document.getElementById('summary-assignment-tags');
                if (tagContainer) {
                    const tagHtml = filteredAssignments.map(a => {
                        const selected = summaryAssignmentFilter.has(a.id);
                        return `<div class="flex items-center gap-1">
                <button class="assignment-tag ${selected ? 'selected' : ''}" onclick="toggleSummaryAssignmentTag('${a.id}')">${a.name} <span class="text-xs opacity-70">(${a.className || '?'})</span></button>
                <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" onclick="moveSummaryAssignmentLeft('${a.id}')">‚óÄ</button>
                <button class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200" onclick="moveSummaryAssignmentRight('${a.id}')">‚ñ∂</button>
            </div>`;
                    }).join('');
                    tagContainer.innerHTML = tagHtml;
                }

                // =====================================================
                // G√âN√âRATION DU HTML - UN TABLEAU PAR CLASSE
                // =====================================================

                let html = '';

                for (const className of orderedClasses) {
                    const classStudents = studentsByClass[className] || [];
                    const classAssignments = assignmentsByClass[className] || [];

                    if (classStudents.length === 0) continue;

                    // Bandeau de la classe
                    html += `<div class="mb-8">`;
                    html += `<div class="bg-blue-600 text-white font-bold p-3 text-lg rounded-t-lg flex items-center justify-between">
                            <span>üìö ${className}</span>
                            <span class="text-sm font-normal opacity-80">${classStudents.length} ${t.students} </span>
                        </div>`;

                    if (classAssignments.length === 0) {
                        html += `<div class="bg-gray-50 border border-t-0 border-gray-200 p-4 text-center text-gray-500 rounded-b-lg">
                Aucun devoir pour cette classe
            </div>`;
                        html += `</div>`;
                        continue;
                    }

                    // Calcul des colonnes
                    const colgroup = (() => {
                        let cols = '<col style="width:200px">';
                        for (const a of classAssignments) {
                            if (showDetails) {
                                const exCount = (a.exercises || []).length;
                                for (let i = 0; i < exCount; i++) cols += '<col style="width:70px">';
                            }
                            cols += '<col style="width:90px">';
                        }
                        return `<colgroup>${cols}</colgroup>`;
                    })();

                    // D√©but du tableau
                    html += `<div class="overflow-x-auto border border-t-0 border-gray-200 rounded-b-lg">`;
                    html += `<table class="w-full table-fixed border-collapse">`;
                    html += colgroup;

                    // Headers
                    html += `<thead><tr class="border-b-2 bg-gray-50">`;
                    html += `<th class="p-3 text-left bg-gray-100 sticky left-0 z-10 cursor-pointer select-none hover:bg-gray-200" onclick="toggleSummarySort('name')">
            ${t.student} ${summarySort.key === 'name' ? (summarySort.direction === 'asc' ? '‚Üë' : '‚Üì') : ''}
        </th>`;

                    for (const a of classAssignments) {
                        if (showDetails) {
                            for (let i = 0; i < a.exercises.length; i++) {
                                const ex = a.exercises[i];
                                html += `<th class="p-2 text-center bg-blue-50 text-sm border-l border-gray-200">
                        Ex${i + 1}<br><span class="text-xs text-gray-500">/${getExerciseMaxPoints(ex)}</span>
                    </th>`;
                            }
                        }
                        const isSorted = summarySort.key === `assignment-${a.id}`;
                        html += `<th class="p-3 text-center bg-blue-100 font-bold cursor-pointer select-none hover:bg-blue-200 border-l border-gray-300" 
                onclick="toggleSummarySort('assignment-${a.id}')">
                ${a.name} ${isSorted ? (summarySort.direction === 'asc' ? '‚Üë' : '‚Üì') : ''}
                <br><span class="text-xs font-normal">/${getAssignmentMaxPoints(a)}</span>
            </th>`;
                    }
                    html += `</tr></thead>`;

                    // Body - lignes des √©l√®ves
                    html += `<tbody>`;
                    for (const s of classStudents) {
                        html += `<tr class="border-b hover:bg-gray-50">`;
                        html += `<td class="p-3 font-medium bg-gray-50 sticky left-0 border-r border-gray-200">${s.name}</td>`;

                        for (const a of classAssignments) {
                            const studentGrades = data.grades[s.id]?.[a.id] || {};

                            if (showDetails) {
                                for (let i = 0; i < a.exercises.length; i++) {
                                    const ex = a.exercises[i];
                                    const exTotal = getStudentExerciseTotal(studentGrades, ex);
                                    const max = getExerciseMaxPoints(ex);
                                    const existingFinal = studentGrades[ex.id]?.['final']?.['final']?.['final'];
                                    const hasEx = hasAnyGradeForExercise(studentGrades, ex);
                                    const val = existingFinal !== undefined && existingFinal !== '' ? existingFinal : (hasEx ? exTotal.toFixed(2) : '');
                                    html += `<td class="px-2 py-1 text-center border-l border-gray-100">
                            <input type="text" 
                                inputmode="decimal" 
                                pattern="[0-9]*[.,]?[0-9]*" 
                                value="${val}" 
                                oninput="sanitizeAndClamp(this, ${max})" 
                                onblur="commitSummaryInput('${s.id}','${a.id}','${ex.id}', ${max}, this.value)" 
                                onkeydown="handleSummaryInputKey(event, '${s.id}','${a.id}','${ex.id}', ${max})" 
                                onfocus="this.select()" 
                                id="sum-input-${s.id}-${a.id}-${ex.id}" 
                                name="sum-input-${s.id}-${a.id}-${ex.id}" 
                                aria-label="Note Ex${i + 1} pour ${s.name} - ${a.name}" 
                                class="summary-grade-input">
                        </td>`;
                                }
                            }

                            const has = hasAnyGradeForAssignment(s.id, a.id);
                            if (has) {
                                const total = getStudentAssignmentTotal(s.id, a.id);
                                const max = getAssignmentMaxPoints(a);
                                const pct = max > 0 ? (total / max * 100) : 0;
                                const bgColor = pct >= 70 ? 'bg-green-100' : pct >= 50 ? 'bg-orange-100' : 'bg-red-100';
                                html += `<td class="p-3 text-center font-bold ${bgColor} border-l border-gray-300" id="sum-total-${s.id}-${a.id}">
                    ${total.toFixed(2)}
                </td>`;
                            } else {
                                html += `<td class="p-3 text-center text-gray-300 border-l border-gray-300" id="sum-total-${s.id}-${a.id}"></td>`;
                            }
                        }

                        html += `</tr>`;
                    }

                    // Ligne de moyenne de classe (optionnel mais utile)
                    html += `<tr class="bg-gray-100 font-semibold border-t-2">`;
                    html += `<td class="p-3 sticky left-0 bg-gray-100">üìä Moyenne</td>`;
                    for (const a of classAssignments) {
                        if (showDetails) {
                            for (const ex of a.exercises) {
                                let exSum = 0;
                                let exCount = 0;
                                for (const s of classStudents) {
                                    const studentGrades = data.grades[s.id]?.[a.id] || {};
                                    if (hasAnyGradeForExercise(studentGrades, ex)) {
                                        exSum += getStudentExerciseTotal(studentGrades, ex);
                                        exCount++;
                                    }
                                }
                                const exAvg = exCount > 0 ? (exSum / exCount) : null;
                                html += `<td class="px-2 py-1 text-center text-sm border-l border-gray-200">${exAvg === null ? '' : exAvg.toFixed(2)}</td>`;
                            }
                        }
                        let sumTot = 0;
                        let ct = 0;
                        for (const s of classStudents) {
                            if (hasAnyGradeForAssignment(s.id, a.id)) {
                                sumTot += getStudentAssignmentTotal(s.id, a.id);
                                ct++;
                            }
                        }
                        const avgTotal = ct > 0 ? (sumTot / ct) : null;
                        const max = getAssignmentMaxPoints(a);
                        const pct = avgTotal !== null && max > 0 ? (avgTotal / max * 100) : 0;
                        const bgColor = avgTotal === null ? 'bg-gray-100' : (pct >= 70 ? 'bg-green-200' : pct >= 50 ? 'bg-orange-200' : 'bg-red-200');
                        html += `<td class="p-3 text-center font-bold ${bgColor} border-l border-gray-300">${avgTotal === null ? '' : avgTotal.toFixed(2)}</td>`;
                    }
                    html += `</tr>`;

                    html += `</tbody></table>`;
                    html += `</div></div>`;
                }

                container.innerHTML = html;
                translatePage();
            }

            function setGlobalAssignmentGrade(studentId, assignmentId, value) {
                if (!data.grades[studentId]) data.grades[studentId] = {};
                if (!data.grades[studentId][assignmentId]) data.grades[studentId][assignmentId] = {};
                data.grades[studentId][assignmentId].global = value === '' ? '' : (parseFloat(value) || 0);
                saveData();
                renderSummary();
            }
            function setExerciseFinalGrade(studentId, assignmentId, exId, max, value) {
                applyExerciseFinalGrade(studentId, assignmentId, exId, max, value, true);
            }

            function applyExerciseFinalGrade(studentId, assignmentId, exId, max, value, rerender) {
                if (!data.grades[studentId]) data.grades[studentId] = {};
                if (!data.grades[studentId][assignmentId]) data.grades[studentId][assignmentId] = {};
                if (!data.grades[studentId][assignmentId][exId]) data.grades[studentId][assignmentId][exId] = {};
                if (!data.grades[studentId][assignmentId][exId]['final']) data.grades[studentId][assignmentId][exId]['final'] = {};
                if (!data.grades[studentId][assignmentId][exId]['final']['final']) data.grades[studentId][assignmentId][exId]['final']['final'] = {};
                let v = value === '' ? '' : (parseFloat(value) || 0);
                if (v !== '' && v > max) v = max;
                if (v !== '' && v < 0) v = 0;
                data.grades[studentId][assignmentId][exId]['final']['final']['final'] = v;
                saveData();
                if (rerender) {
                    renderSummary();
                } else {
                    updateSummaryTotalsInline(studentId, assignmentId);
                }
            }

            function clampExerciseInput(el, max) {
                if (el.value === '') return;
                const str = el.value.toString();
                if (str.endsWith('.')) return;
                let v = parseFloat(str);
                if (isNaN(v)) return;
                if (v < 0) v = 0;
                if (v > max) v = max;
                el.value = v;
            }

            function sanitizeAndClamp(el, max) {
                let val = (el.value || '').toString();
                val = val.replace(',', '.');
                val = val.replace(/[Ÿ´Ÿ¨]/g, '.');
                val = val.replace(/[^0-9.]/g, '');
                const parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                el.value = val;
                if (!val.endsWith('.')) clampExerciseInput(el, max);
            }

            function commitSummaryInput(studentId, assignmentId, exId, max, value) {
                applyExerciseFinalGrade(studentId, assignmentId, exId, max, value, false);
            }

            function handleSummaryInputKey(e, studentId, assignmentId, exId, max) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    commitSummaryInput(studentId, assignmentId, exId, max, e.target.value);
                    const inputs = Array.from(document.querySelectorAll('.summary-grade-input'));
                    const idx = inputs.indexOf(e.target);
                    const nextIdx = idx + 1;
                    if (nextIdx >= 0 && nextIdx < inputs.length) {
                        inputs[nextIdx].focus();
                        inputs[nextIdx].select?.();
                    }
                    return;
                }
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    let v = parseFloat((e.target.value || '0').toString().replace(',', '.'));
                    if (isNaN(v)) v = 0;
                    const step = 0.25;
                    v = e.key === 'ArrowUp' ? v + step : v - step;
                    if (v < 0) v = 0;
                    if (v > max) v = max;
                    e.target.value = v.toFixed(2).replace(/\.00$/, '.0');
                    commitSummaryInput(studentId, assignmentId, exId, max, e.target.value);
                }
            }

            function updateSummaryTotalsInline(studentId, assignmentId) {
                const totalCell = document.getElementById(`sum-total-${studentId}-${assignmentId}`);
                if (!totalCell) return;
                const has = hasAnyGradeForAssignment(studentId, assignmentId);
                if (!has) {
                    totalCell.textContent = '';
                    totalCell.className = 'p-3 text-center text-gray-300';
                    return;
                }
                const total = getStudentAssignmentTotal(studentId, assignmentId);
                const assignment = data.assignments.find(a => a.id === assignmentId);
                const max = assignment ? getAssignmentMaxPoints(assignment) : 0;
                const pct = max > 0 ? (total / max * 100) : 0;
                let bgColor = 'bg-red-100';
                if (pct >= 70) bgColor = 'bg-green-100'; else if (pct >= 50) bgColor = 'bg-orange-100';
                totalCell.textContent = total.toFixed(2);
                totalCell.className = `p-3 text-center font-bold ${bgColor}`;
            }

            function toggleSummarySort(key) {
                if (summarySort.key === key) {
                    // Inverser le sens
                    summarySort.direction = summarySort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    summarySort.key = key;
                    // √âl√®ve : A‚ÜíZ par d√©faut, Devoir : max‚Üí0 par d√©faut
                    summarySort.direction = key === 'name' ? 'asc' : 'desc';
                }
                renderSummary();
            }

            function toggleSummaryAssignmentTag(assignmentId) {
                if (summaryAssignmentFilter.has(assignmentId)) {
                    summaryAssignmentFilter.delete(assignmentId);
                } else {
                    summaryAssignmentFilter.add(assignmentId);
                }
                renderSummary();
            }

            function moveSummaryAssignmentLeft(id) {
                try {
                    const arr = window.summaryAssignmentOrder || [];
                    const i = arr.indexOf(id);
                    if (i > 0) {
                        [arr[i - 1], arr[i]] = [arr[i], arr[i - 1]];
                        localStorage.setItem('summary-assignment-order', JSON.stringify(arr));
                        renderSummary();
                    }
                } catch (e) { }
            }

            function moveSummaryAssignmentRight(id) {
                try {
                    const arr = window.summaryAssignmentOrder || [];
                    const i = arr.indexOf(id);
                    if (i >= 0 && i < arr.length - 1) {
                        [arr[i + 1], arr[i]] = [arr[i], arr[i + 1]];
                        localStorage.setItem('summary-assignment-order', JSON.stringify(arr));
                        renderSummary();
                    }
                } catch (e) { }
            }

            function handleStudentImport(event) {
                const t = translations[currentLanguage];
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    const dataBinary = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(dataBinary, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (json.length < 2) {
                        alert(t.emptyFile);
                        return;
                    }

                    const headers = json[1];
                    const rows = json.slice(2); // √† partir de la 3√®me ligne

                    // Fonction utilitaire pour nettoyer les chaines (enlever les espaces inutiles)
                    const cleanStr = (val) => (val || '').toString().trim();

                    const getIndex = (label) => headers.findIndex(h => cleanStr(h) === label);

                    // Index des colonnes d'identification
                    const idxNIN = getIndex('ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ');
                    const idxNom = getIndex('ÿßŸÑŸÑŸÇÿ®');
                    const idxPrenom = getIndex('ÿßŸÑÿßÿ≥ŸÖ');
                    const idxClasse = getIndex('ÿßŸÑŸÅŸàÿ¨ ÿßŸÑÿ™ÿ±ÿ®ŸàŸä');
                    const idxSexe = getIndex('ÿßŸÑÿ¨ŸÜÿ≥');
                    const idxBirth = getIndex('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ');
                    const idxReg = getIndex('ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ');

                    // Liste des index connus (infos √©l√®ves) pour identifier les colonnes de NOTES
                    const knownIndices = [idxNIN, idxNom, idxPrenom, idxClasse, idxSexe, idxBirth, idxReg];

                    let added = 0;
                    let updated = 0;

                    rows.forEach(row => {
                        if (!row || row.length === 0) return;

                        // Extraction des donn√©es de base
                        const nin = idxNIN >= 0 ? cleanStr(row[idxNIN]) : '';
                        const lastName = idxNom >= 0 ? cleanStr(row[idxNom]) : '';
                        const firstName = idxPrenom >= 0 ? cleanStr(row[idxPrenom]) : '';
                        const className = idxClasse >= 0 ? cleanStr(row[idxClasse]) : '';
                        const sex = idxSexe >= 0 ? cleanStr(row[idxSexe]) : '';
                        const birthDate = idxBirth >= 0 ? cleanStr(row[idxBirth]) : '';
                        const regNumber = idxReg >= 0 ? cleanStr(row[idxReg]) : '';

                        if (!lastName && !firstName) return;
                        const name = (lastName + ' ' + firstName).trim();

                        // --- CORRECTION 1 : LOGIQUE DE RECHERCHE AM√âLIOR√âE ---
                        let existing = null;

                        // A. Essayer par Num√©ro d'Inscription (le plus fiable)
                        if (regNumber) {
                            existing = data.students.find(s => s.regNumber == regNumber);
                        }
                        // B. Si pas trouv√©, essayer par NIN
                        if (!existing && nin) {
                            existing = data.students.find(s => s.nin == nin);
                        }
                        // C. Si pas trouv√©, essayer Nom + Pr√©nom + Classe (Comparaison stricte sans espaces)
                        if (!existing) {
                            existing = data.students.find(s =>
                                s.name.trim() === name &&
                                s.className.trim() === className
                            );
                        }

                        // Objet contenant les donn√©es √† sauvegarder
                        const studentData = {
                            name,
                            className,
                            nin,
                            firstName,
                            lastName,
                            sex,
                            birthDate,
                            regNumber
                        };

                        // --- CORRECTION 2 : IMPORTATION DES NOTES (Colonnes suppl√©mentaires) ---
                        // On initialise un objet 'grades' s'il n'existe pas
                        const importedGrades = {};
                        headers.forEach((header, index) => {
                            // Si la colonne n'est pas une info √©l√®ve et qu'elle a un titre
                            if (!knownIndices.includes(index) && header && row[index] !== undefined) {
                                // On enregistre la note associ√©e au nom de la colonne (ex: "Devoir 1")
                                importedGrades[cleanStr(header)] = row[index];
                            }
                        });

                        if (existing) {
                            // MISE A JOUR de l'√©l√®ve existant
                            Object.assign(existing, studentData); // Met √† jour infos perso

                            // Fusionner les notes
                            if (!existing.grades) existing.grades = {};
                            Object.assign(existing.grades, importedGrades); // Ajoute/Met √† jour les notes

                            updated++;
                        } else {
                            // CR√âATION d'un nouvel √©l√®ve
                            data.students.push({
                                id: genId(), // Assurez-vous que genId() existe
                                ...studentData,
                                grades: importedGrades // On ajoute les notes d√®s la cr√©ation
                            });
                            added++;
                        }
                    });

                    saveData();
                    renderStudents();

                    // Si vous avez une fonction sp√©cifique pour rafraichir les tableaux de notes :
                    if (typeof renderSummary === 'function') renderSummary();
                    if (typeof loadGradeSelectors === 'function') loadGradeSelectors();

                    alert(`${t.importSuccess}\nAjout√©s: ${added}\nMis √† jour: ${updated}`);
                    event.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            }
            function handleJsonExportData() {
                const t = translations[currentLanguage];
                const now = new Date();
                const pad = n => String(n).padStart(2, '0');
                const fname = `simpleNotes-${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.json`;

                // === SAUVEGARDE DES MESSAGES PERSO ===
                const teacherMessages = {};
                try {
                    // R√©cup√®re TOUS les messages Perso par scope/band
                    const scopes = ["obs"]; // obs g√©n√©raux
                    for (let band = 0; band <= 8; band++) {
                        scopes.push(`cons@${band}`);
                    }

                    scopes.forEach(scope => {
                        const msgs = getTeacherMessages(scope) || [];
                        if (msgs.length > 0) {
                            teacherMessages[scope] = msgs;
                        }
                    });
                    console.log("Messages Perso export√©s:", teacherMessages);
                } catch (e) {
                    console.warn("Erreur export messages Perso:", e);
                }

                const payload = {
                    data,              // tes donn√©es existantes
                    exportPrepConfig,  // config export existante
                    teacherMessages    // ‚≠ê NOUVEAU : messages Perso !
                };

                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fname;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }


            function handleJsonImportData(event) {
                const t = translations[currentLanguage];
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedRaw = JSON.parse(e.target.result);
                        const importedData = importedRaw.data || importedRaw;

                        console.log("üì¶ importedRaw:", importedRaw);
                        console.log("üì¶ importedData:", importedData);

                        // Fonction pour nettoyer
                        const clean = (val) => String(val || '').trim();

                        let added = 0;
                        let updated = 0;

                        // ========== FUSION DES √âL√àVES ==========
                        if (importedData.students && Array.isArray(importedData.students)) {
                            importedData.students.forEach(importedStudent => {
                                const nin = clean(importedStudent.nin);

                                // Recherche par NIN
                                let existing = null;
                                if (nin) {
                                    existing = data.students.find(s => clean(s.nin) === nin);
                                }

                                if (existing) {
                                    // Garder l'ancien ID, mettre √† jour le reste
                                    const oldId = existing.id;
                                    Object.assign(existing, importedStudent);
                                    existing.id = oldId; // Conserver l'ID original !
                                    updated++;

                                    // Si l'ID import√© est diff√©rent, transf√©rer les notes
                                    if (importedStudent.id !== oldId && importedData.grades && importedData.grades[importedStudent.id]) {
                                        if (!data.grades[oldId]) {
                                            data.grades[oldId] = {};
                                        }
                                        // Fusionner les notes
                                        Object.assign(data.grades[oldId], importedData.grades[importedStudent.id]);
                                    }
                                } else {
                                    // Nouvel √©l√®ve
                                    data.students.push(importedStudent);
                                    added++;

                                    // Copier ses notes aussi
                                    if (importedData.grades && importedData.grades[importedStudent.id]) {
                                        data.grades[importedStudent.id] = importedData.grades[importedStudent.id];
                                    }
                                }
                            });
                        }

                        // ‚≠ê IMPORT MESSAGES PERSO (vraies cl√©s)
                        const teacherData = importedData.teacherMessages || importedRaw.teacherMessages;
                        if (teacherData) {
                            console.log("‚úÖ teacherMessages TROUV√â:", teacherData);

                            Object.entries(teacherData).forEach(([scope, msgs]) => {
                                if (Array.isArray(msgs) && msgs.length > 0) {
                                    // 1) window.REMARKS_MESSAGES
                                    window.REMARKS_MESSAGES = window.REMARKS_MESSAGES || {};
                                    window.REMARKS_MESSAGES.teacherMessages = window.REMARKS_MESSAGES.teacherMessages || {};
                                    window.REMARKS_MESSAGES.teacherMessages[scope] = msgs;

                                    // 2) LES VRAIES CL√âS localStorage
                                    const v1Key = `corrections-teacher-remarks-library-v1`;
                                    const v2Key = `corrections-teacher-remarks-library-v2`;

                                    // v1 format: {"FR":{"obs":[...],"cons@0":[...]}}
                                    let v1Data = JSON.parse(localStorage.getItem(v1Key) || '{}');
                                    v1Data.FR = v1Data.FR || {};
                                    v1Data.FR[scope] = msgs;
                                    localStorage.setItem(v1Key, JSON.stringify(v1Data));

                                    // v2 format: {"FR":{"obs":{"0":["FaibleObs"]}}}
                                    let v2Data = JSON.parse(localStorage.getItem(v2Key) || '{}');
                                    v2Data.FR = v2Data.FR || {};
                                    if (!v2Data.FR[scope]) v2Data.FR[scope] = {};
                                    v2Data.FR[scope]["0"] = msgs; // simplifi√©
                                    localStorage.setItem(v2Key, JSON.stringify(v2Data));

                                    console.log(`‚úÖ ${scope} ‚Üí v1/v2 localStorage`);
                                }
                            });

                            renderExportPrep();
                        }
                        else {
                            console.warn("‚ùå Pas de teacherMessages");
                        }

                        // ========== FUSION DES DEVOIRS ==========
                        if (importedData.assignments && Array.isArray(importedData.assignments)) {
                            importedData.assignments.forEach(importedAssignment => {
                                const existingAssignment = data.assignments.find(a => a.id === importedAssignment.id);
                                if (!existingAssignment) {
                                    data.assignments.push(importedAssignment);
                                }
                            });
                        }

                        // ========== FUSION CONFIG EXPORT ==========
                        const importedCfg = importedRaw.exportPrepConfig;
                        if (importedCfg) {
                            if (!exportPrepConfig || !exportPrepConfig.byClass) exportPrepConfig = { byClass: {} };
                            if (importedCfg.byClass) {
                                for (const cls of Object.keys(importedCfg.byClass)) {
                                    exportPrepConfig.byClass[cls] = importedCfg.byClass[cls];
                                }
                            }
                            if (importedCfg.globalRemarks) {
                                exportPrepConfig.globalRemarks = importedCfg.globalRemarks;
                            }
                            saveExportPrepConfig();
                        }

                        saveData();
                        renderStudents();
                        if (typeof loadGradeSelectors === 'function') loadGradeSelectors();
                        if (typeof renderSummary === 'function') renderSummary();

                        alert(`Importation r√©ussie !\n√âl√®ves mis √† jour: ${updated}\n√âl√®ves ajout√©s: ${added}`);
                        event.target.value = '';

                    } catch (error) {
                        console.error('Erreur importation JSON:', error);
                        alert('Erreur lors de l\'importation du fichier JSON');
                    }
                };
                reader.readAsText(file);
            }

            async function exportSummaryToExcel() {
                const t = translations[currentLanguage];
                const selectedClass = document.getElementById('select-class-summary')?.value || '';
                const searchTerm = (document.getElementById('summary-search')?.value || '').toLowerCase().trim();

                const matchingClasses = new Set();
                for (const s of data.students) {
                    const n = (s.name || '').toLowerCase();
                    const cn = (s.className || '').toLowerCase();
                    if (!searchTerm || n.includes(searchTerm) || cn.includes(searchTerm)) {
                        matchingClasses.add(s.className);
                    }
                }

                let filteredStudents = data.students.filter(s => {
                    const n = (s.name || '').toLowerCase();
                    const cn = (s.className || '').toLowerCase();
                    if (searchTerm && !(n.includes(searchTerm) || cn.includes(searchTerm))) return false;
                    if (selectedClass && s.className !== selectedClass) return false;
                    if (!selectedClass && searchTerm && !matchingClasses.has(s.className)) return false;
                    return true;
                });

                // TRI PAR CLASSE PUIS PAR NOM
                filteredStudents.sort((a, b) => {
                    const classA = (a.className || '').toLowerCase();
                    const classB = (b.className || '').toLowerCase();

                    if (classA !== classB) {
                        return classA.localeCompare(classB, 'fr', { sensitivity: 'base' });
                    }

                    const nameA = `${a.lastName || ''} ${a.firstName || ''}`.toLowerCase();
                    const nameB = `${b.lastName || ''} ${b.firstName || ''}`.toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                let filteredAssignments = data.assignments.slice();
                if (selectedClass) {
                    filteredAssignments = filteredAssignments.filter(a => a.className === selectedClass);
                } else {
                    const classFilterSet = new Set(matchingClasses);
                    filteredAssignments = filteredAssignments.filter(a => classFilterSet.has(a.className));
                }
                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0) {
                    filteredAssignments = filteredAssignments.filter(a => summaryAssignmentFilter.has(a.id));
                }
                if (summaryAssignmentFilter && summaryAssignmentFilter.size > 0 && !selectedClass) {
                    const allowedClasses = new Set(filteredAssignments.map(a => (a.className || '').trim()).filter(c => c.length > 0));
                    filteredStudents = filteredStudents.filter(s => allowedClasses.has((s.className || '').trim()));
                }

                if (filteredStudents.length === 0 || filteredAssignments.length === 0) {
                    alert(t.noResultForSearch || 'Aucun r√©sultat');
                    return;
                }

                if (!window.summaryAssignmentOrder) {
                    try {
                        window.summaryAssignmentOrder = JSON.parse(localStorage.getItem('summary-assignment-order') || '[]');
                    } catch (e) { window.summaryAssignmentOrder = []; }
                }
                const ids = filteredAssignments.map(a => a.id);
                const set = new Set(window.summaryAssignmentOrder);
                ids.forEach(id => { if (!set.has(id)) window.summaryAssignmentOrder.push(id); });
                filteredAssignments = filteredAssignments.slice().sort((a, b) => {
                    const oa = window.summaryAssignmentOrder.indexOf(a.id);
                    const ob = window.summaryAssignmentOrder.indexOf(b.id);
                    if (oa === -1 && ob === -1) return 0;
                    if (oa === -1) return 1;
                    if (ob === -1) return -1;
                    return oa - ob;
                });

                const wb = XLSX.utils.book_new();

                // Fonction pour cr√©er un nom de feuille valide et unique
                const usedSheetNames = new Set();
                const sanitizeSheetName = (name) => {
                    let sanitized = (name || '').toString().trim();

                    // Remplacements des niveaux arabes par des chiffres
                    const replacements = {
                        'ÿ£ŸàŸÑŸâ ÿ´ÿßŸÜŸàŸä': '1',
                        'ÿßŸàŸÑŸâ ÿ´ÿßŸÜŸàŸä': '1',
                        'ÿ´ÿßŸÜŸäÿ©  ÿ´ÿßŸÜŸàŸä': '2',
                        'ÿ´ÿßŸÑÿ´ÿ©  ÿ´ÿßŸÜŸàŸä': '3',
                    };

                    // Appliquer les remplacements
                    for (const [key, value] of Object.entries(replacements)) {
                        // Cr√©er une regex insensible √† la casse pour les variantes
                        const regex = new RegExp(key, 'gi');
                        sanitized = sanitized.replace(regex, value);
                    }

                    // Remplacer les caract√®res interdits : \ / ? * [ ] :
                    sanitized = sanitized.replace(/[\\\/\?\*\[\]:]/g, '');

                    // Nettoyer les espaces multiples
                    sanitized = sanitized.replace(/\s+/g, ' ').trim();

                    // Limiter √† 31 caract√®res (limite Excel)
                    if (sanitized.length > 31) {
                        sanitized = sanitized.substring(0, 31).trim();
                    }

                    // Si vide, utiliser un nom par d√©faut
                    if (!sanitized) {
                        sanitized = 'Feuille';
                    }

                    // G√©rer les doublons en ajoutant un num√©ro
                    let finalName = sanitized;
                    let counter = 1;
                    while (usedSheetNames.has(finalName)) {
                        const suffix = `_${counter}`;
                        const maxLength = 31 - suffix.length;
                        finalName = sanitized.substring(0, maxLength).trim() + suffix;
                        counter++;
                    }

                    usedSheetNames.add(finalName);
                    return finalName;
                };

                // Grouper les √©tudiants par classe
                const studentsByClass = new Map();
                for (const s of filteredStudents) {
                    const className = (s.className || '').trim() || '(Sans classe)';
                    if (!studentsByClass.has(className)) {
                        studentsByClass.set(className, []);
                    }
                    studentsByClass.get(className).push(s);
                }

                // Trier les classes par ordre alphab√©tique
                const sortedClasses = Array.from(studentsByClass.keys()).sort((a, b) =>
                    a.localeCompare(b, 'fr', { sensitivity: 'base' })
                );

                const headerBase = ['ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿπÿ±ŸäŸÅ', 'ÿßŸÑŸÑŸÇÿ®', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ'];

                // Cr√©er une feuille par classe
                for (const cls of sortedClasses) {
                    const stu = studentsByClass.get(cls) || [];

                    // Filtrer les devoirs pour cette classe uniquement
                    const assigns = filteredAssignments.filter(a =>
                        (a.className || '').trim() === cls.trim() ||
                        (cls === '(Sans classe)' && !(a.className || '').trim())
                    );

                    if (stu.length === 0) continue;

                    // Cr√©er l'en-t√™te avec les devoirs de cette classe
                    const header = [...headerBase];
                    if (assigns.length > 0) {
                        header.push(...assigns.map(a => a.name));
                    }

                    const rows = [header];

                    // Ajouter les lignes d'√©tudiants
                    for (const s of stu) {
                        const birthDate = formatDate(parseDateMaybeExcel(s.birthDate || ''));
                        const rowData = [
                            s.nin || '',
                            s.lastName || '',
                            s.firstName || '',
                            birthDate
                        ];

                        // Ajouter les notes pour chaque devoir de cette classe
                        for (const a of assigns) {
                            const v = getStudentAssignmentTotal(s.id, a.id);
                            rowData.push(typeof v === 'number' ? v : '');
                        }

                        rows.push(rowData);
                    }

                    // Cr√©er la feuille
                    const ws = XLSX.utils.aoa_to_sheet(rows);

                    // Ajouter la feuille avec un nom s√©curis√©
                    const sheetName = sanitizeSheetName(cls);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }

                // G√©n√©rer le nom du fichier avec timestamp
                const now = new Date();
                const pad = n => String(n).padStart(2, '0');
                const fname = `recap-${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.xlsx`;

                // T√©l√©charger le fichier
                XLSX.writeFile(wb, fname);
            }

            // ===== EXPORT PREP (CC / Devoir / Composition) =====
            // === OVERRIDES OBS/CONS (par classe; trimestre plus tard) ===
            const REMARKS_OVERRIDE_KEY = "corrections-remarks-overrides-v1";

            function getRemarksScopeKey(className) {
                // TODO plus tard: return `${className}::T${currentTrimester}`
                return String(className || "");
            }

            function loadRemarksOverrides() {
                try { return JSON.parse(localStorage.getItem(REMARKS_OVERRIDE_KEY)) || {}; }
                catch { return {}; }
            }
            function saveRemarksOverrides(obj) {
                localStorage.setItem(REMARKS_OVERRIDE_KEY, JSON.stringify(obj));
            }

            let remarksOverrides = loadRemarksOverrides();

            // overrides[scopeKey][studentId] = { obs, cons, updatedAt }
            function ensureScope(scopeKey) {
                if (!remarksOverrides[scopeKey]) remarksOverrides[scopeKey] = {};
                return remarksOverrides[scopeKey];
            }
            function getOverride(scopeKey, studentId) {
                return remarksOverrides?.[scopeKey]?.[String(studentId)] || null;
            }
            function setOverride(scopeKey, studentId, patch) {
                const scope = ensureScope(scopeKey);
                const id = String(studentId);
                scope[id] = { ...(scope[id] || {}), ...patch, updatedAt: Date.now() };
                saveRemarksOverrides(remarksOverrides);
            }
            function clearOverrideField(scopeKey, studentId, field) {
                const scope = ensureScope(scopeKey);
                const id = String(studentId);
                if (!scope[id]) return;
                delete scope[id][field];

                const hasObs = !!(scope[id].obs && scope[id].obs.trim());
                const hasCons = !!(scope[id].cons && scope[id].cons.trim());
                if (!hasObs && !hasCons) delete scope[id];

                saveRemarksOverrides(remarksOverrides);
            }
            // === LIBRAIRIE PROF (messages perso r√©utilisables) ===
            const TEACHER_REMARKS_LIBRARY_KEY = "corrections-teacher-remarks-library-v1";

            function loadTeacherLibrary() {
                try { return JSON.parse(localStorage.getItem(TEACHER_REMARKS_LIBRARY_KEY)) || {}; }
                catch { return {}; }
            }
            function saveTeacherLibrary(lib) {
                localStorage.setItem(TEACHER_REMARKS_LIBRARY_KEY, JSON.stringify(lib));
            }

            let teacherRemarksLibrary = loadTeacherLibrary();
            // Structure: library[langKey()][kind] = [ "msg1", "msg2", ... ] ; kind in ("obs","cons")
            function ensureTeacherList(lang, kind) {
                if (!teacherRemarksLibrary[lang]) teacherRemarksLibrary[lang] = {};
                if (!teacherRemarksLibrary[lang][kind]) teacherRemarksLibrary[lang][kind] = [];
                return teacherRemarksLibrary[lang][kind];
            }


            function addTeacherMessage(kind, message) {
                const msg = String(message || "").trim().replace(/\s+/g, " ");
                if (!msg) return false;
                const lang = langKey();
                const list = ensureTeacherList(lang, kind);
                const exists = list.some(x => x.trim().toLowerCase() === msg.toLowerCase());
                if (!exists) list.unshift(msg); // ajouter en haut
                saveTeacherLibrary(teacherRemarksLibrary);
                return true;
            }

            function getTeacherMessages(kind) {
                const lang = langKey();
                return (teacherRemarksLibrary?.[lang]?.[kind] || []).slice(0, 80); // limite raisonnable
            }

            // Config persist√©e (par classe)
            const EXPORT_CONFIG_KEY = 'corrections-export-config-v1';

            // structure:
            // exportPrepConfig = {
            //   byClass: {
            //     [className]: {
            //        ccAssignmentId, compAssignmentId,
            //        devoir1: { assignmentIds:[], combine:'sum'|'avg', normalize:true, targetMax:20 },
            //        devoir2: { assignmentIds:[], combine:'sum'|'avg', normalize:true, targetMax:20 },
            //        outMax: 20
            //     }
            //   }
            // }
            let exportPrepConfig = { byClass: {} };

            function loadExportPrepConfig() {
                try {
                    exportPrepConfig = JSON.parse(localStorage.getItem(EXPORT_CONFIG_KEY) || '{"byClass":{}}');
                    if (!exportPrepConfig.byClass) exportPrepConfig.byClass = {};
                } catch (e) {
                    exportPrepConfig = { byClass: {} };
                }
            }

            function saveExportPrepConfig() {
                localStorage.setItem(EXPORT_CONFIG_KEY, JSON.stringify(exportPrepConfig));
            }

            function getDefaultGlobalRemarks() {
                return {
                    bands: [{ min: 0, max: 6 }, { min: 6.01, max: 9.99 }, { min: 10, max: 13.99 }, { min: 14, max: 15.99 }, { min: 16, max: 17.99 }, { min: 18, max: 20 }],
                    FR: [
                        [
                            { obs: 'R√©sultats tr√®s insuffisants.', cons: "Renforcer les bases et demander de l‚Äôaide." },
                            { obs: 'Bases non ma√Ætris√©es.', cons: 'Reprendre les fondamentaux quotidiennement.' },
                            { obs: 'Manque d‚Äôassiduit√©.', cons: 'Planifier un travail r√©gulier.' },
                            { obs: 'Attention aux lacunes.', cons: 'Faire des exercices cibl√©s.' },
                            { obs: 'Suivi n√©cessaire.', cons: 'Solliciter un accompagnement.' }
                        ],
                        [
                            { obs: 'Progr√®s limit√©s.', cons: 'Revoir les notions cl√©s et s‚Äôentra√Æner.' },
                            { obs: 'Participation √† renforcer.', cons: 'Multiplier les exercices.' },
                            { obs: 'R√©sultats fragiles.', cons: 'Consolider avec des r√©visions.' },
                            { obs: 'In√©galit√©s dans le travail.', cons: 'Adopter une routine.' },
                            { obs: 'Peut mieux faire.', cons: 'Fixer des objectifs simples.' }
                        ],
                        [
                            { obs: 'Ensemble correct.', cons: 'Poursuivre les efforts avec r√©gularit√©.' },
                            { obs: 'Bilan satisfaisant.', cons: 'Maintenir l‚Äôinvestissement.' },
                            { obs: 'R√©sultats stables.', cons: 'Renforcer l‚Äôautonomie.' },
                            { obs: 'Progression notable.', cons: 'Continuer √† ce rythme.' },
                            { obs: 'Attitude s√©rieuse.', cons: 'Varier les m√©thodes.' }
                        ],
                        [
                            { obs: 'Bon niveau.', cons: 'Maintenir le rythme et consolider.' },
                            { obs: 'Travail s√©rieux.', cons: 'Approfondir pour viser plus haut.' },
                            { obs: 'Bonne progression.', cons: 'Continuer avec rigueur.' },
                            { obs: 'R√©sultats encourageants.', cons: 'S‚Äôentra√Æner sur les d√©tails.' },
                            { obs: 'Application r√©guli√®re.', cons: 'D√©velopper la confiance.' }
                        ],
                        [
                            { obs: 'Tr√®s bon travail.', cons: 'Approfondir les points forts.' },
                            { obs: 'Exigence appr√©ciable.', cons: 'Varier les m√©thodes pour exceller.' },
                            { obs: 'Tr√®s r√©gulier.', cons: 'Entretenir ce rythme.' },
                            { obs: 'Belle ma√Ætrise.', cons: 'Se fixer des d√©fis.' },
                            { obs: 'Comportement exemplaire.', cons: 'Continuer ainsi.' }
                        ],
                        [
                            { obs: 'Excellent.', cons: 'Continuer sur cette lanc√©e.' },
                            { obs: 'R√©sultats remarquables.', cons: 'Objectifs avanc√©s recommand√©s.' },
                            { obs: 'Exemplarit√©.', cons: 'Partager les bonnes pratiques.' },
                            { obs: 'Performance √©lev√©e.', cons: 'Viser l‚Äôexcellence durable.' },
                            { obs: 'Tr√®s grande ma√Ætrise.', cons: 'Soutenir les camarades.' }
                        ]
                    ],
                    EN: [
                        [
                            { obs: 'Very insufficient results.', cons: 'Strengthen basics and seek help.' },
                            { obs: 'Weak fundamentals.', cons: 'Revise core topics daily.' },
                            { obs: 'Irregular work.', cons: 'Plan study and follow homework.' },
                            { obs: 'Gaps observed.', cons: 'Do targeted exercises.' },
                            { obs: 'Follow-up needed.', cons: 'Ask for guidance.' }
                        ],
                        [
                            { obs: 'Limited progress.', cons: 'Review key concepts and practice.' },
                            { obs: 'Low participation.', cons: 'Increase targeted exercises.' },
                            { obs: 'Fragile results.', cons: 'Consolidate through revision.' },
                            { obs: 'Uneven work.', cons: 'Adopt a routine.' },
                            { obs: 'Can do better.', cons: 'Set simple goals.' }
                        ],
                        [
                            { obs: 'Solid overall.', cons: 'Keep working and aim for consistency.' },
                            { obs: 'Satisfactory.', cons: 'Maintain effort.' },
                            { obs: 'Stable results.', cons: 'Strengthen autonomy.' },
                            { obs: 'Notable progress.', cons: 'Continue at this pace.' },
                            { obs: 'Serious attitude.', cons: 'Vary methods.' }
                        ],
                        [
                            { obs: 'Good level.', cons: 'Maintain pace and consolidate.' },
                            { obs: 'Serious work.', cons: 'Deepen to aim higher.' },
                            { obs: 'Good progress.', cons: 'Continue with rigor.' },
                            { obs: 'Encouraging results.', cons: 'Practice details.' },
                            { obs: 'Regular application.', cons: 'Build confidence.' }
                        ],
                        [
                            { obs: 'Very good work.', cons: 'Deepen strengths.' },
                            { obs: 'Strong commitment.', cons: 'Vary methods to excel.' },
                            { obs: 'Very consistent.', cons: 'Maintain this rhythm.' },
                            { obs: 'Great mastery.', cons: 'Set challenges.' },
                            { obs: 'Exemplary attitude.', cons: 'Keep it up.' }
                        ],
                        [
                            { obs: 'Excellent.', cons: 'Continue this excellent momentum.' },
                            { obs: 'Outstanding results.', cons: 'Set advanced goals.' },
                            { obs: 'Exemplary.', cons: 'Share best practices.' },
                            { obs: 'High performance.', cons: 'Aim for lasting excellence.' },
                            { obs: 'Very strong mastery.', cons: 'Support classmates.' }
                        ]
                    ],
                    AR: [
                        [
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ ÿ∂ÿπŸäŸÅÿ© ÿ¨ÿØŸãÿß.', cons: 'ÿ™ÿπÿ≤Ÿäÿ≤ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™ Ÿàÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©.' },
                            { obs: 'ÿ£ÿ≥ÿßÿ≥Ÿäÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ™ŸÇŸÜÿ©.', cons: 'ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿØÿ±Ÿàÿ≥ ŸäŸàŸÖŸäŸãÿß.' },
                            { obs: 'ÿπŸÖŸÑ ÿ∫Ÿäÿ± ŸÖŸÜÿ™ÿ∏ŸÖ.', cons: 'ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ŸàŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™.' },
                            { obs: 'ÿ´ÿ∫ÿ±ÿßÿ™ Ÿàÿßÿ∂ÿ≠ÿ©.', cons: 'ÿ™ŸÖÿßÿ±ŸäŸÜ ŸÖÿ±ŸÉÿ≤ÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©.' },
                            { obs: 'ÿ≠ÿßÿ¨ÿ© ÿ•ŸÑŸâ ŸÖÿ™ÿßÿ®ÿπÿ©.', cons: 'ÿ∑ŸÑÿ® ÿßŸÑÿ™Ÿàÿ¨ŸäŸá.' }
                        ],
                        [
                            { obs: 'ÿ™ŸÇÿØŸÖ ŸÖÿ≠ÿØŸàÿØ.', cons: 'ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖŸÅÿßŸáŸäŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸàÿßŸÑÿ™ÿØÿ±Ÿäÿ®.' },
                            { obs: 'ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ∂ÿπŸäŸÅÿ©.', cons: 'ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ™ŸÖÿßÿ±ŸäŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ÿ©.' },
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ Ÿáÿ¥ÿ©.', cons: 'ÿ™ÿ´ÿ®Ÿäÿ™ ÿπÿ®ÿ± ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©.' },
                            { obs: 'ÿπŸÖŸÑ ÿ∫Ÿäÿ± ŸÖŸÜÿ™ÿ∏ŸÖ.', cons: 'ÿßÿπÿ™ŸÖÿßÿØ ÿ±Ÿàÿ™ŸäŸÜ ŸäŸàŸÖŸä.' },
                            { obs: 'ŸäŸÖŸÉŸÜ ÿ£ŸÅÿ∂ŸÑ.', cons: 'ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸáÿØÿßŸÅ ÿ®ÿ≥Ÿäÿ∑ÿ©.' }
                        ],
                        [
                            { obs: 'ŸÖÿ≥ÿ™ŸàŸâ ŸÖŸÇÿ®ŸàŸÑ.', cons: 'ŸÖŸàÿßÿµŸÑÿ© ÿßŸÑÿ¨ŸáÿØ ŸàÿßŸÑÿ≥ÿπŸä ÿ•ŸÑŸâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßŸÖ.' },
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ±ÿ∂Ÿäÿ©.', cons: 'ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ¨ŸáÿØ.' },
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ≥ÿ™ŸÇÿ±ÿ©.', cons: 'ÿ™ÿπÿ≤Ÿäÿ≤ ÿßŸÑÿßÿ≥ÿ™ŸÇŸÑÿßŸÑŸäÿ©.' },
                            { obs: 'ÿ™ÿ≠ÿ≥ŸÜ ŸÖŸÑÿ≠Ÿàÿ∏.', cons: 'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸàÿ™Ÿäÿ±ÿ©.' },
                            { obs: 'ÿ¨ÿØŸäÿ© ŸÅŸä ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©.', cons: 'ÿ™ŸÜŸàŸäÿπ ÿßŸÑÿ£ÿ≥ÿßŸÑŸäÿ®.' }
                        ],
                        [
                            { obs: 'ŸÖÿ≥ÿ™ŸàŸâ ÿ¨ŸäÿØ.', cons: 'ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸàÿ™Ÿäÿ±ÿ© Ÿàÿ™ÿ±ÿ≥ŸäÿÆ ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ®ÿßÿ™.' },
                            { obs: 'ÿπŸÖŸÑ ÿ¨ÿßÿØ.', cons: 'ÿ™ÿπŸÖŸäŸÇ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ŸÑŸÑŸàÿµŸàŸÑ ŸÑŸÑÿ£ŸÅÿ∂ŸÑ.' },
                            { obs: 'ÿ™ÿ≠ÿ≥ŸÜ ÿ¨ŸäÿØ.', cons: 'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®ÿßŸÜÿ∂ÿ®ÿßÿ∑.' },
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ¥ÿ¨ÿπÿ©.', cons: 'ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ.' },
                            { obs: 'ÿßŸÜÿ™ÿ∏ÿßŸÖ Ÿàÿßÿ∂ÿ≠.', cons: 'ÿ™ÿπÿ≤Ÿäÿ≤ ÿßŸÑÿ´ŸÇÿ©.' }
                        ],
                        [
                            { obs: 'ÿπŸÖŸÑ ŸÖŸÖÿ™ÿßÿ≤ ÿ¨ÿØŸãÿß.', cons: 'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± Ÿàÿ™ÿπŸÖŸäŸÇ ŸÜŸÇÿßÿ∑ ÿßŸÑŸÇŸàÿ©.' },
                            { obs: 'ÿßŸÑÿ™ÿ≤ÿßŸÖ ŸÇŸàŸä.', cons: 'ÿ™ŸÜŸàŸäÿπ ÿßŸÑÿ£ÿ≥ÿßŸÑŸäÿ® ŸÑŸÑÿ™ŸÖŸäÿ≤.' },
                            { obs: 'ÿßŸÜÿ™ÿ∏ÿßŸÖ ŸÉÿ®Ÿäÿ±.', cons: 'ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ•ŸäŸÇÿßÿπ.' },
                            { obs: 'ÿ•ÿ™ŸÇÿßŸÜ Ÿàÿßÿ∂ÿ≠.', cons: 'ÿ™ÿ≠ÿØŸäÿßÿ™ ÿ¥ÿÆÿµŸäÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©.' },
                            { obs: 'ÿ≥ŸÑŸàŸÉ ŸÜŸÖŸàÿ∞ÿ¨Ÿä.', cons: 'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ.' }
                        ],
                        [
                            { obs: 'ŸÖŸÖÿ™ÿßÿ≤.', cons: 'ŸÖŸàÿßÿµŸÑÿ© Ÿáÿ∞ÿß ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑŸÖÿ™ŸÖŸäÿ≤.' },
                            { obs: 'ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ®Ÿáÿ±ÿ©.', cons: 'ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸáÿØÿßŸÅ ŸÖÿ™ŸÇÿØŸÖÿ©.' },
                            { obs: 'ŸÇÿØŸàÿ©.', cons: 'ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖŸÖÿßÿ±ÿ≥ÿßÿ™ ÿßŸÑÿ¨ŸäÿØÿ©.' },
                            { obs: 'ÿ£ÿØÿßÿ° ÿπÿßŸÑŸç.', cons: 'ÿßŸÑÿ≥ÿπŸä ŸÑŸÑÿ™ŸÖŸäÿ≤ ÿßŸÑŸÖÿ≥ÿ™ÿØÿßŸÖ.' },
                            { obs: 'ÿ•ÿ™ŸÇÿßŸÜ ŸÇŸàŸä ÿ¨ÿØŸãÿß.', cons: 'ÿØÿπŸÖ ÿßŸÑÿ≤ŸÖŸÑÿßÿ°.' }
                        ]
                    ]
                };
            }
            function ensureGlobalRemarks() {
                if (!exportPrepConfig) exportPrepConfig = { byClass: {} };
                // migration: si des remarques existaient par classe auparavant, prendre la premi√®re
                if (!exportPrepConfig.globalRemarks) {
                    try {
                        const classes = Object.keys(exportPrepConfig.byClass || {});
                        for (const cls of classes) {
                            const rc = exportPrepConfig.byClass[cls]?.remarks;
                            if (rc && rc.bands && (rc.FR || rc.EN || rc.AR)) {
                                exportPrepConfig.globalRemarks = rc;
                                break;
                            }
                        }
                    } catch (e) { }
                }
                const defs = getDefaultGlobalRemarks();
                if (!exportPrepConfig.globalRemarks) exportPrepConfig.globalRemarks = defs;
                const gr = exportPrepConfig.globalRemarks;
                if (!Array.isArray(gr.bands) || gr.bands.length === 0) gr.bands = defs.bands;
                const langs = ['FR', 'EN', 'AR'];
                for (const L of langs) {
                    if (!Array.isArray(gr[L]) || gr[L].length === 0) gr[L] = defs[L];
                    while (gr[L].length < gr.bands.length) gr[L].push([]);
                    for (let i = 0; i < gr[L].length; i++) {
                        if (!Array.isArray(gr[L][i])) gr[L][i] = [];
                    }
                }
                saveExportPrepConfig();
                return gr;
            }
            function resetRemarksCurrentLanguage() {
                const gr = ensureGlobalRemarks();
                const defs = getDefaultGlobalRemarks();
                const lang = currentLanguage === 'fr' ? 'FR' : (currentLanguage === 'en' ? 'EN' : 'AR');
                gr.bands = defs.bands.map(b => ({ min: b.min, max: b.max }));
                gr[lang] = defs[lang].map(arr => arr.map(m => ({ obs: m.obs, cons: m.cons })));
                saveExportPrepConfig();
                closeRemarksModal();
                openRemarksModal();
            }

            function getExportClassConfig(className) {
                if (!className) return null;
                if (!exportPrepConfig.byClass[className]) {
                    exportPrepConfig.byClass[className] = {
                        ccAssignmentId: '',
                        compAssignmentId: '',
                        tpAssignmentId: '',
                        devoir1: { assignmentIds: [], combine: 'sum', normalize: true, targetMax: 20 },
                        devoir2: { assignmentIds: [], combine: 'sum', normalize: true, targetMax: 20 },
                        outMax: 20
                    };
                }
                return exportPrepConfig.byClass[className];
            }

            function getAssignmentsForClass(className) {
                return data.assignments.filter(a => (a.className || '').trim() === (className || '').trim());
            }

            function hasAnyGradeForExercise(studentGrades, ex) {
                const exGrades = studentGrades?.[ex.id] || {};
                const final = exGrades?.final?.final?.final;
                if (final !== undefined && final !== '') return true;
                const directQuestions = ex.questions || [];
                const parts = ex.parts || [];
                if (directQuestions.length === 0 && parts.length === 0) {
                    const d = exGrades?.direct?.direct?.direct;
                    return d !== undefined && d !== '';
                }
                for (const q of directQuestions) {
                    const qg = exGrades?.direct?.[q.id] || {};
                    if (!q.subQuestions || q.subQuestions.length === 0) {
                        const v = qg?.direct;
                        if (v !== undefined && v !== '') return true;
                    } else {
                        for (const sq of q.subQuestions) {
                            const v = qg?.[sq.id];
                            if (v !== undefined && v !== '') return true;
                        }
                    }
                }
                for (const part of parts) {
                    for (const q of (part.questions || [])) {
                        const qg = exGrades?.[part.id]?.[q.id] || {};
                        if (!q.subQuestions || q.subQuestions.length === 0) {
                            const v = qg?.direct;
                            if (v !== undefined && v !== '') return true;
                        } else {
                            for (const sq of q.subQuestions) {
                                const v = qg?.[sq.id];
                                if (v !== undefined && v !== '') return true;
                            }
                        }
                    }
                }
                return false;
            }
            function hasAnyGradeForAssignment(studentId, assignmentId) {
                const sg = data.grades?.[studentId]?.[assignmentId];
                if (!sg) return false;
                const g = sg.global;
                if (g !== undefined && g !== '') return true;
                const a = data.assignments.find(x => x.id === assignmentId);
                if (!a) return false;
                for (const ex of (a.exercises || [])) {
                    if (hasAnyGradeForExercise(sg, ex)) return true;
                }
                return false;
            }

            function toNumberOrNull(v) {
                if (v === '' || v === null || v === undefined) return null;
                const n = Number(v);
                return Number.isFinite(n) ? n : null;
            }

            function round2(n) {
                return Math.round((n + Number.EPSILON) * 100) / 100;
            }

            function getGroupRawMaxForDisplay(className, groupCfg) {
                const ids = (groupCfg.assignmentIds || []).filter(Boolean);
                const assigns = ids
                    .map(id => data.assignments.find(a => a.id === id))
                    .filter(a => a && (a.className || '').trim() === (className || '').trim());

                if (assigns.length === 0) return 0;

                const maxes = assigns.map(a => getAssignmentMaxPoints(a) || 0).filter(x => x > 0);
                if (maxes.length === 0) return 0;

                if (groupCfg.combine === 'avg') {
                    // max "moyen" (info), arrondi 2 d√©cimales
                    return maxes.reduce((s, x) => s + x, 0) / maxes.length;
                }
                if (groupCfg.combine === 'max') {
                    // max des max (info), le plus √©lev√©
                    return Math.max(...maxes);
                }
                // sum
                return maxes.reduce((s, x) => s + x, 0);
            }

            function getGroupDisplayedMax(className, cfg, groupKey) {
                const g = cfg[groupKey];
                const outMax = cfg.outMax ?? 20;

                // Si normalis√© => la note est cens√©e sortir sur targetMax (souvent 20)
                if (g.normalize) return (toNumberOrNull(g.targetMax) ?? outMax);

                // Non normalis√© => affichage du max brut (ex: /10, /22, etc.)
                return getGroupRawMaxForDisplay(className, g);
            }

            function groupHasExportScaleIssue(className, cfg, groupKey) {
                const outMax = cfg.outMax ?? 20;
                const g = cfg[groupKey];
                const ids = (g.assignmentIds || []).filter(Boolean);
                if (ids.length === 0) return false;

                // r√©cup√©rer max des devoirs s√©lectionn√©s
                const assigns = ids
                    .map(id => data.assignments.find(a => a.id === id))
                    .filter(a => a && (a.className || '').trim() === (className || '').trim());

                if (assigns.length === 0) return true;

                const maxes = assigns.map(a => getAssignmentMaxPoints(a) || 0).filter(x => x > 0);
                if (maxes.length === 0) return true;

                if (g.normalize) {
                    // Normalis√© => OK uniquement si la cible == outMax (souvent 20)
                    const target = (toNumberOrNull(g.targetMax) ?? outMax);
                    return target !== outMax;
                }

                // Pas normalis√© => OK si le max "brut" correspond d√©j√† √† outMax
                if (g.combine === 'sum') {
                    const rawMax = maxes.reduce((s, x) => s + x, 0);
                    return rawMax !== outMax;
                }

                // combine === 'avg' sans normaliser :
                // OK seulement si toutes les √©valuations sont d√©j√† sur outMax (ex: toutes /20)
                const allSameAsOut = maxes.every(m => m === outMax);
                return !allSameAsOut;
            }
            function cellClassForValue(v, expected) {
                // expected: boolean => cette colonne est attendue (un devoir est s√©lectionn√©)
                if (!expected) return 'text-gray-300';

                if (v === null || v === undefined || v === '') {
                    // Vide => warning
                    return 'bg-amber-50 text-amber-800 border border-amber-200';
                }
                const n = Number(v);
                if (!Number.isFinite(n)) {
                    return 'bg-amber-50 text-amber-800 border border-amber-200';
                }
                if (n === 0) {
                    return 'bg-red-100 text-red-700 border border-red-200 font-semibold';
                }
                return 'bg-white';
            }
            function collectUsedAssignmentIds(cfg) {
                const used = new Set();
                if (cfg.ccAssignmentId) used.add(cfg.ccAssignmentId);
                if (cfg.tpAssignmentId) used.add(cfg.tpAssignmentId);
                if (cfg.compAssignmentId) used.add(cfg.compAssignmentId);
                (cfg.devoir1?.assignmentIds || []).forEach(id => id && used.add(id));
                (cfg.devoir2?.assignmentIds || []).forEach(id => id && used.add(id));
                return used;
            }

            // retire assignmentId de toutes les zones SAUF la source
            // source = { type: 'single'|'group', key: 'ccAssignmentId'|'tpAssignmentId'|'compAssignmentId'|'devoir1'|'devoir2' }
            function enforceUniqueAssignment(cfg, assignmentId, source) {
                if (!assignmentId) return;

                // Singles
                const singleKeys = ['ccAssignmentId', 'tpAssignmentId', 'compAssignmentId'];
                for (const k of singleKeys) {
                    if (source.type === 'single' && source.key === k) continue;
                    if (cfg[k] === assignmentId) cfg[k] = '';
                }

                // Groups
                const groupKeys = ['devoir1', 'devoir2'];
                for (const gk of groupKeys) {
                    if (source.type === 'group' && source.key === gk) continue;
                    const arr = cfg[gk]?.assignmentIds || [];
                    cfg[gk].assignmentIds = arr.filter(id => id !== assignmentId);
                }
            }

            function computeGroupScore(studentId, className, groupCfg) {
                const outMax = (getExportClassConfig(className)?.outMax ?? 20);

                const ids = (groupCfg.assignmentIds || []).filter(Boolean);
                if (ids.length === 0) return null;

                const assigns = ids
                    .map(id => data.assignments.find(a => a.id === id))
                    .filter(a => a && (a.className || '').trim() === (className || '').trim());

                if (assigns.length === 0) return null;

                // Collecter scores & max
                const entries = assigns.map(a => {
                    const has = hasAnyGradeForAssignment(studentId, a.id);
                    const max = getAssignmentMaxPoints(a);
                    const total = has ? getStudentAssignmentTotal(studentId, a.id) : null;
                    return { a, has, total, max };
                });

                // Si aucune note saisie parmi les devoirs du groupe => null (cellule vide)
                if (!entries.some(e => e.has)) return null;

                const normalize = !!groupCfg.normalize;
                const targetMax = toNumberOrNull(groupCfg.targetMax) ?? outMax;

                if (groupCfg.combine === 'avg') {
                    const valid = entries.filter(e => e.has && e.max > 0);

                    if (valid.length === 0) return null;

                    if (groupCfg.normalize) {
                        // moyenne des pourcentages puis mise √† l‚Äô√©chelle (targetMax)
                        const percents = valid.map(e => (e.total / e.max));
                        const avgP = percents.reduce((s, p) => s + p, 0) / percents.length;
                        return avgP * targetMax;
                    } else {
                        // moyenne brute des notes (pas d‚Äô√©chelle)
                        const avgRaw = valid.reduce((s, e) => s + (e.total || 0), 0) / valid.length;
                        return avgRaw;
                    }
                }

                if (groupCfg.combine === 'max') {
                    const valid = entries.filter(e => e.has && e.max > 0);

                    if (valid.length === 0) return null;

                    if (groupCfg.normalize) {
                        // maximum des pourcentages puis mise √† l‚Äô√©chelle (targetMax)
                        const percents = valid.map(e => (e.total / e.max));
                        const maxP = Math.max(...percents);
                        return maxP * targetMax;
                    } else {
                        // maximum brute des notes
                        const notes = valid.map(e => e.total || 0);
                        return Math.max(...notes);
                    }
                }

                // combine === 'sum'
                const sumTotal = entries.reduce((s, e) => s + (e.has ? (e.total || 0) : 0), 0);
                const sumMax = entries.reduce((s, e) => s + (e.max > 0 ? e.max : 0), 0);

                if (!normalize) {
                    // Somme brute (utile si l‚Äôensemble est d√©j√† naturellement /20)
                    return sumTotal;
                }

                // Somme normalis√©e sur targetMax
                if (!sumMax || sumMax <= 0) return null;
                return (sumTotal / sumMax) * targetMax;
            }

            function computeDevoirFinal(studentId, className, cfg) {
                const d1 = computeGroupScore(studentId, className, cfg.devoir1);
                const d2 = computeGroupScore(studentId, className, cfg.devoir2);

                // R√®gle : Devoir = moyenne(D1, D2) si les deux existent,
                // sinon Devoir = celui qui existe, sinon vide.
                if (d1 === null && d2 === null) return null;
                if (d1 !== null && d2 !== null) return (d1 + d2) / 2;
                return (d1 !== null) ? d1 : d2;
            }
            function calcScaledScore(studentId, assignment) {
                // Retourne note sur /outMax (configurable)
                if (!assignment) return null;
                const cfg = getExportClassConfig(assignment.className);
                const outMax = cfg?.outMax ?? 20;

                if (!hasAnyGradeForAssignment(studentId, assignment.id)) return null;

                const total = getStudentAssignmentTotal(studentId, assignment.id);
                const max = getAssignmentMaxPoints(assignment);
                if (!max || max <= 0) return null;

                return (total / max) * outMax;
            }

            function loadClassSelectorsForExport() {
                const classes = getClasses();
                const select = document.getElementById('select-class-export');
                const t = translations[currentLanguage];

                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = `<option value="">-- ${t.selectClass} --</option>` +
                    classes.map(c => `<option value="${c}" ${c === currentValue ? 'selected' : ''}>${c}</option>`).join('');
            }

            function onExportClassChange() {
                const className = document.getElementById('select-class-export')?.value || '';
                if (!className) {
                    document.getElementById('export-config').innerHTML = '';
                    document.getElementById('export-preview-table').innerHTML = '';
                    document.getElementById('export-preview-meta').textContent = '';
                    return;
                }

                // init config
                getExportClassConfig(className);
                saveExportPrepConfig();
                renderExportPrep();
                installRakmanaColorAutoUpdate();
                updateExportClassCardColor();
            }

            function resetExportConfig() {
                const className = document.getElementById('select-class-export')?.value || '';
                if (!className) return;
                delete exportPrepConfig.byClass[className];
                saveExportPrepConfig();
                renderExportPrep();
            }

            function renderExportPrep() {
                const t = translations[currentLanguage];
                const className = document.getElementById('select-class-export')?.value || '';
                const container = document.getElementById('export-config');
                const preview = document.getElementById('export-preview-table');
                const meta = document.getElementById('export-preview-meta');

                if (!container || !preview || !meta) return;

                if (!className) {
                    container.innerHTML = '';
                    preview.innerHTML = '';
                    meta.textContent = '';
                    return;
                }

                const cfg = getExportClassConfig(className);
                const assigns = getAssignmentsForClass(className);
                const d1MaxShown = getGroupDisplayedMax(className, cfg, 'devoir1');
                const d2MaxShown = getGroupDisplayedMax(className, cfg, 'devoir2');
                const d1Issue = groupHasExportScaleIssue(className, cfg, 'devoir1');
                const d2Issue = groupHasExportScaleIssue(className, cfg, 'devoir2');
                // UI ‚Äúselect‚Äù pour CC et Composition
                const buildSingleOptions = (currentValue) => {
                    // d√©sactiver les devoirs d√©j√† utilis√©s ailleurs (sauf la valeur actuelle du select)
                    const used = collectUsedAssignmentIds(cfg);
                    return [`<option value="">-- ${t.selectAssignment} --</option>`].concat(
                        assigns.map(a => {
                            const isUsedElsewhere = used.has(a.id) && a.id !== currentValue;
                            return `<option value="${a.id}" ${isUsedElsewhere ? 'disabled' : ''}>
                        ${a.name} (${getAssignmentMaxPoints(a)} ${t.points})
                    </option>`;
                        })
                    ).join('');
                };

                // Helper: liste multi-select ‚Äúmoderne‚Äù via checkboxes + chips
                const renderMultiPick = (groupKey) => {
                    const g = cfg[groupKey];
                    const selected = new Set(g.assignmentIds || []);
                    const rows = assigns.map(a => {
                        const checked = selected.has(a.id) ? 'checked' : '';
                        // utilis√© ailleurs ? => disabled (sauf si d√©j√† coch√© dans CE groupe)
                        const used = collectUsedAssignmentIds(cfg);
                        const usedElsewhere = used.has(a.id) && !checked; // si d√©j√† coch√© ici, on autorise l‚Äôuncheck
                        const disabled = usedElsewhere ? 'disabled' : '';
                        const opacity = usedElsewhere ? 'opacity-50 cursor-not-allowed' : '';
                        return `
                    <label class="flex items-center gap-2 p-2 border rounded-lg bg-white hover:bg-gray-50 ${opacity}">
                        <input type="checkbox" ${checked} ${disabled}
                        onchange="toggleExportGroupAssignment('${groupKey}','${a.id}',this.checked)" class="w-4 h-4">
                            <span class="flex-1 min-w-0 truncate font-medium">${a.name}</span>
                            <span class="text-xs text-gray-500">/${getAssignmentMaxPoints(a)} ${t.points}</span>
                            </label>
                        `;
                    }).join('');

                    const chips = (g.assignmentIds || [])
                        .map(id => assigns.find(a => a.id === id))
                        .filter(Boolean)
                        .map(a => `<span class="px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold border border-blue-200">${a.name}</span>`)
                        .join('') || `<span class="text-xs text-gray-400">${t.noneSelected}</span>`;

                    return `
      <div class="space-y-2">
        <div class="flex flex-wrap gap-2 items-center">${chips}</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">${rows}</div>
      </div>
    `;
                };

                container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- CC -->
      <div class="p-4 border rounded-xl bg-gray-50">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold text-gray-800" data-translate="ccLabel">Contr√¥le Continu (CC)</h3>
          <span class="text-xs text-gray-500">${t.outputOn} / ${cfg.outMax}</span>
        </div>
        <select class="w-full p-3 border rounded-lg bg-white"
          onchange="setExportSingle('ccAssignmentId', this.value)"
          id="export-cc-select">
          ${buildSingleOptions(cfg.ccAssignmentId || '')}
        </select>
        <p class="text-xs text-gray-500 mt-2" data-translate="singleSelectHint">
          S√©lectionnez un devoir existant pour alimenter cette note (conversion sur /20).
        </p>
      </div>
        <!-- TP (optionnel) -->
        <div class="p-4 border rounded-xl bg-gray-50">
            <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-gray-800" data-translate="tpLabel">${t.tpLabel || 'TP'}</h3>
            <span class="text-xs text-gray-500">${t.outputOn} / ${cfg.outMax}</span>
            </div>
            <select class="w-full p-3 border rounded-lg bg-white"
            onchange="setExportSingle('tpAssignmentId', this.value)"
            id="export-tp-select">
            ${buildSingleOptions(cfg.tpAssignmentId || '')}
            </select>
            <p class="text-xs text-gray-500 mt-2" data-translate="singleSelectHint">
            ${t.singleSelectHint}
            </p>
        </div>
      <!-- Composition -->
      <div class="p-4 border rounded-xl bg-gray-50">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-bold text-gray-800" data-translate="compLabel">Composition</h3>
          <span class="text-xs text-gray-500">${t.outputOn} / ${cfg.outMax}</span>
        </div>
        <select class="w-full p-3 border rounded-lg bg-white"
          onchange="setExportSingle('compAssignmentId', this.value)"
          id="export-comp-select">
          ${buildSingleOptions(cfg.compAssignmentId || '')}
        </select>
        <p class="text-xs text-gray-500 mt-2" data-translate="singleSelectHint">
          S√©lectionnez un devoir existant pour alimenter cette note (conversion sur /20).
        </p>
      </div>

    </div>

    <!-- Devoir -->
      <div class="mt-4 p-4 border rounded-xl bg-blue-50">
        <div class="flex items-center justify-between flex-wrap gap-2 mb-3">
          <h3 class="font-bold text-gray-800" data-translate="devoirLabel">Devoir (moyenne Devoir 1 & Devoir 2)</h3>
          <div class="flex items-center gap-3 flex-wrap">
            <label class="text-sm font-semibold text-gray-700">
              ${t.outputOn}
              <input type="number" min="1" step="1" value="${cfg.outMax}"
                class="w-20 p-2 border rounded bg-white ml-2"
                onchange="setExportOutMax(this.value)">
            </label>
            
          </div>
        </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

        <!-- Devoir 1 -->
        <div class="border rounded-xl p-4 ${d1Issue ? 'bg-amber-50 border-amber-300' : 'bg-white'}">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="flex items-center gap-2">
                <h4 class="font-bold text-blue-800" data-translate="devoir1Label">Devoir 1</h4>
                <span class="text-xs font-bold px-2 py-1 rounded-full ${d1Issue ? 'bg-amber-200 text-amber-900' : 'bg-blue-100 text-blue-800'}">
                    / ${round2(d1MaxShown || 0)}
                </span>
                ${d1Issue ? `<span class="text-xs font-semibold text-amber-800" title="${t.exportNotOn20 || ''}"></span>` : ``}
            </div>
            <div class="flex items-center gap-2">
              <select class="p-2 border rounded bg-white text-sm"
                onchange="setExportGroupField('devoir1','combine',this.value)">
                <option value="sum" ${cfg.devoir1.combine === 'sum' ? 'selected' : ''}>${t.sum}</option>
                <option value="avg" ${cfg.devoir1.combine === 'avg' ? 'selected' : ''}>${t.average}</option>
                <option value="max" ${cfg.devoir1.combine === 'max' ? 'selected' : ''}>${t.max}</option>
              </select>
              <label class="text-sm flex items-center gap-2">
                <input type="checkbox" class="w-4 h-4" ${cfg.devoir1.normalize ? 'checked' : ''}
                  onchange="setExportGroupField('devoir1','normalize',this.checked)">
                <span data-translate="normalize">${t.normalize}</span>
              </label>
              <input type="number" min="1" step="1" value="${cfg.devoir1.targetMax ?? 20}"
                class="w-20 p-2 border rounded bg-white text-sm"
                title="${t.targetMax}"
                onchange="setExportGroupField('devoir1','targetMax',this.value)">
            </div>
          </div>
          <div class="text-xs text-gray-500 mb-2" data-translate="groupHint">
            S√©lectionnez un ou plusieurs devoirs de la classe, puis choisissez Somme ou Moyenne.
          </div>
          ${renderMultiPick('devoir1')}
        </div>

        <!-- Devoir 2 -->
        <div class="bg-white border rounded-xl p-4">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="flex items-center gap-2">
            <h4 class="font-bold text-blue-800" data-translate="devoir2Label">Devoir 2</h4>
            <span class="text-xs font-bold px-2 py-1 rounded-full ${d2Issue ? 'bg-amber-200 text-amber-900' : 'bg-blue-100 text-blue-800'}">
                / ${round2(d2MaxShown || 0)}
            </span>
            ${d2Issue ? `<span class="text-xs font-semibold text-amber-800" title="${t.exportNotOn20 || ''}">‚ö†Ô∏è</span>` : ``}
            </div>
            <div class="flex items-center gap-2">
              <select class="p-2 border rounded bg-white text-sm"
                onchange="setExportGroupField('devoir2','combine',this.value)">
                <option value="sum" ${cfg.devoir2.combine === 'sum' ? 'selected' : ''}>${t.sum}</option>
                <option value="avg" ${cfg.devoir2.combine === 'avg' ? 'selected' : ''}>${t.average}</option>
                <option value="max" ${cfg.devoir2.combine === 'max' ? 'selected' : ''}>${t.max}</option>
              </select>
              <label class="text-sm flex items-center gap-2">
                <input type="checkbox" class="w-4 h-4" ${cfg.devoir2.normalize ? 'checked' : ''}
                  onchange="setExportGroupField('devoir2','normalize',this.checked)">
                <span data-translate="normalize">${t.normalize}</span>
              </label>
              <input type="number" min="1" step="1" value="${cfg.devoir2.targetMax ?? 20}"
                class="w-20 p-2 border rounded bg-white text-sm"
                title="${t.targetMax}"
                onchange="setExportGroupField('devoir2','targetMax',this.value)">
            </div>
          </div>
          <div class="text-xs text-gray-500 mb-2" data-translate="groupHint">
            S√©lectionnez un ou plusieurs devoirs de la classe, puis choisissez Somme ou Moyenne.
          </div>
          ${renderMultiPick('devoir2')}
        </div>

      </div>

      <div class="mt-3 text-sm text-gray-700" data-translate="devoirRule">
        R√®gle: Devoir = moyenne(Devoir 1, Devoir 2). Si l‚Äôun manque, on prend l‚Äôautre.
      </div>
    </div>
  `;

                // Appliquer les valeurs selected sur CC/Comp
                const ccSelect = document.getElementById('export-cc-select');
                const compSelect = document.getElementById('export-comp-select');
                const tpSelect = document.getElementById('export-tp-select');
                if (tpSelect) tpSelect.value = cfg.tpAssignmentId || '';
                if (ccSelect) ccSelect.value = cfg.ccAssignmentId || '';
                if (compSelect) compSelect.value = cfg.compAssignmentId || '';

                // Preview
                const students = data.students.filter(s => (s.className || '').trim() === (className || '').trim());
                meta.textContent = `${students.length} ${t.students}`;

                renderExportPreviewTable(className, cfg);

                // retraduire le contenu dynamique
                translatePage();
            }

            function openRemarksModal() {
                const t = translations[currentLanguage];
                const overlay = document.createElement('div');
                overlay.id = 'remarks-modal';
                overlay.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                const gr = ensureGlobalRemarks();
                const bands = gr.bands || [];
                const lang = currentLanguage === 'fr' ? 'FR' : (currentLanguage === 'en' ? 'EN' : 'AR');
                const msgs = gr[lang] || [];
                const rows = bands.map((b, i) => {
                    let items = '';
                    for (let j = 0; j < 5; j++) {
                        const m = (msgs[i] && msgs[i][j]) ? msgs[i][j] : { obs: '', cons: '' };
                        items += `
                          <tr>
                            <td class="p-1 text-xs">${j + 1}</td>
                            <td class="p-1"><textarea class="w-64 p-2 border rounded" data-band="${i}" data-msg="${j}" data-field="obs">${m.obs || ''}</textarea></td>
                            <td class="p-1"><textarea class="w-64 p-2 border rounded" data-band="${i}" data-msg="${j}" data-field="cons">${m.cons || ''}</textarea></td>
                          </tr>`;
                    }
                    return `
                      <tr class="bg-gray-50">
                        <td class="p-2"><input type="number" step="0.01" class="w-24 p-2 border rounded" value="${b.min}" data-band="${i}" data-field="min"></td>
                        <td class="p-2"><input type="number" step="0.01" class="w-24 p-2 border rounded" value="${b.max}" data-band="${i}" data-field="max"></td>
                        <td colspan="2" class="p-2">
                          <table class="w-full text-sm"><thead><tr><th class="p-1">#</th><th class="p-1">${t.observationShort || 'Observation'}</th><th class="p-1">${t.adviceShort || 'Conseil'}</th></tr></thead><tbody>${items}</tbody></table>
                        </td>
                      </tr>`;
                }).join('');
                overlay.innerHTML = `
                  <div class="bg-white rounded-xl shadow-xl w-[90%] max-w-5xl" style="max-height:85vh; overflow-y:auto;">
                    <div class="p-4 border-b flex items-center justify-between">
                      <div class="font-bold">${t.remarksTitle || 'Messages'}</div>
                      <div class="flex items-center gap-2">
                        <button class="px-3 py-1 rounded bg-amber-200" onclick="resetRemarksCurrentLanguage()">${t.reset || 'R√©initialiser'}</button>
                        <button class="px-3 py-1 rounded bg-gray-200" onclick="closeRemarksModal()">${t.cancel || 'Annuler'}</button>
                      </div>
                    </div>
                    <div class="p-4">
                      <div class="mb-3 font-semibold">${t.gradeBands || ''} ‚Äî ${lang}</div>
                      <table class="w-full text-sm">
                        <thead><tr><th class="p-2">${t.min || 'Min'}</th><th class="p-2">${t.max || 'Max'}</th><th class="p-2" colspan="2">${t.editRemarks || 'Messages'}</th></tr></thead>
                        <tbody>${rows}</tbody>
                      </table>
                    </div>
                    <div class="p-4 border-t flex justify-end gap-2">
                      <button class="px-4 py-2 rounded bg-indigo-600 text-white" onclick="saveRemarksModal()">${t.save || 'Enregistrer'}</button>
                    </div>
                  </div>
                `;
                document.body.appendChild(overlay);
            }

            function closeRemarksModal() {
                const el = document.getElementById('remarks-modal');
                if (el) el.remove();
            }

            function saveRemarksModal() {
                const gr = ensureGlobalRemarks();
                const lang = currentLanguage === 'fr' ? 'FR' : (currentLanguage === 'en' ? 'EN' : 'AR');
                const overlay = document.getElementById('remarks-modal');
                if (!overlay) return;
                const rangeInputs = overlay.querySelectorAll('input[data-field]');
                rangeInputs.forEach(inp => {
                    const i = parseInt(inp.getAttribute('data-band'), 10);
                    const field = inp.getAttribute('data-field');
                    const n = parseFloat(inp.value);
                    gr.bands[i][field] = Number.isFinite(n) ? n : gr.bands[i][field];
                });
                const msgTextareas = overlay.querySelectorAll('textarea[data-field]');
                const perBand = {};
                msgTextareas.forEach(ta => {
                    const i = parseInt(ta.getAttribute('data-band'), 10);
                    const j = parseInt(ta.getAttribute('data-msg'), 10);
                    const field = ta.getAttribute('data-field');
                    const key = `${i}`;
                    if (!perBand[key]) perBand[key] = {};
                    if (!perBand[key][j]) perBand[key][j] = { obs: '', cons: '' };
                    perBand[key][j][field] = ta.value || '';
                });
                const arr = [];
                const bands = gr.bands || [];
                for (let i = 0; i < bands.length; i++) {
                    const list = [];
                    const bandMsgs = perBand[`${i}`] || {};
                    const keys = Object.keys(bandMsgs).map(k => parseInt(k, 10)).sort((a, b) => a - b);
                    for (const k of keys) {
                        const m = bandMsgs[k];
                        if ((m.obs || '').trim() || (m.cons || '').trim()) list.push({ obs: m.obs || '', cons: m.cons || '' });
                        if (list.length >= 5) break;
                    }
                    arr.push(list);
                }
                gr[lang] = arr;
                saveExportPrepConfig();
                closeRemarksModal();
                renderExportPrep();
            }

            // remarks globales assur√©es par ensureGlobalRemarks()
            function computeRemarksForAverage(className, avg) {
                if (avg === null || avg === undefined) return { obs: '', cons: '' };
                const gr = ensureGlobalRemarks();
                const bands = gr.bands || [];
                const lang = currentLanguage === 'fr' ? 'FR' : (currentLanguage === 'en' ? 'EN' : 'AR');
                let idx = -1;
                for (let i = 0; i < bands.length; i++) {
                    const b = bands[i];
                    if (avg >= b.min && avg <= b.max) { idx = i; break; }
                }
                if (idx === -1) return { obs: '', cons: '' };
                const list = gr[lang][idx] || [];
                if (!list.length) return { obs: '', cons: '' };
                const k = Math.floor(Math.random() * list.length);
                return list[k];
            }

            function setExportSingle(field, assignmentId) {
                const className = document.getElementById('select-class-export')?.value || '';
                const cfg = getExportClassConfig(className);

                // si vide => simple reset du champ
                if (!assignmentId) {
                    cfg[field] = '';
                    saveExportPrepConfig();
                    renderExportPrep();
                    return;
                }

                // imposer unicit√© : on garde ce choix et on le retire d'ailleurs
                cfg[field] = assignmentId;
                enforceUniqueAssignment(cfg, assignmentId, { type: 'single', key: field });

                saveExportPrepConfig();
                renderExportPrep(); // rerender complet (d√©sactive ailleurs + refresh preview)
            }

            function setExportOutMax(val) {
                const className = document.getElementById('select-class-export')?.value || '';
                const cfg = getExportClassConfig(className);
                const n = parseInt(val, 10);
                cfg.outMax = Number.isFinite(n) && n > 0 ? n : 20;
                // mettre √† jour aussi targetMax par d√©faut si vides
                if (!cfg.devoir1.targetMax) cfg.devoir1.targetMax = cfg.outMax;
                if (!cfg.devoir2.targetMax) cfg.devoir2.targetMax = cfg.outMax;

                saveExportPrepConfig();
                renderExportPrep(); // rerender car affichage outMax + calculs
            }

            function setExportGroupField(groupKey, field, value) {
                const className = document.getElementById('select-class-export')?.value || '';
                const cfg = getExportClassConfig(className);

                cfg[groupKey][field] = value;
                saveExportPrepConfig();

                // IMPORTANT : re-render complet pour rafra√Æchir la couleur des cartes + badge /n
                renderExportPrep();
                updateExportClassCardColor();
            }

            function toggleExportGroupAssignment(groupKey, assignmentId, checked) {
                const className = document.getElementById('select-class-export')?.value || '';
                const cfg = getExportClassConfig(className);
                const arr = cfg[groupKey].assignmentIds || [];
                const set = new Set(arr);

                if (checked) {
                    // retirer d'ailleurs, puis ajouter ici
                    enforceUniqueAssignment(cfg, assignmentId, { type: 'group', key: groupKey });
                    set.add(assignmentId);
                } else {
                    set.delete(assignmentId);
                }

                cfg[groupKey].assignmentIds = Array.from(set);
                saveExportPrepConfig();
                renderExportPrep();
            }
            function escapeHtml(str) {
                return String(str ?? "").replace(/[&<>"']/g, m => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
                }[m]));
            }

            function langKey() {
                return currentLanguage === "fr" ? "FR" : (currentLanguage === "en" ? "EN" : "AR");
            }
            function findBandIndexLocal(bands, value) {
                const v = Number(value);
                if (!Number.isFinite(v)) return -1;
                const vv = Math.round(v * 100) / 100;
                for (let i = 0; i < bands.length; i++) {
                    const b = bands[i];
                    if (vv >= b.min && vv <= b.max) return i;
                }
                return -1;
            }
            function getObsCandidatesForRow(devoir, comp) {
                const R = window.REMARKS_MESSAGES;
                if (!R) return [];
                const d = Number(devoir), c = Number(comp);
                if (!Number.isFinite(d) || !Number.isFinite(c)) return [];
                const diff = d - c;
                const idx = findBandIndexLocal(R.diffBands, diff);
                if (idx < 0) return [];
                return (R.observations?.[langKey()]?.[idx]) || [];
            }
            function getConsCandidatesForRow(avg) {
                const R = window.REMARKS_MESSAGES;
                if (!R) return [];
                const idx = findBandIndexLocal(R.avgBands, avg);
                if (idx < 0) return [];
                return (R.advice?.[langKey()]?.[idx]) || [];
            }

            function renderExportPreviewTable(className, cfg) {
                const t = translations[currentLanguage];
                const preview = document.getElementById('export-preview-table');
                if (!preview) return;

                const students = data.students
                    .filter(s => (s.className || '').trim() === (className || '').trim())
                    .slice()
                    .sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'fr', { sensitivity: 'base' }));

                const ccA = cfg.ccAssignmentId ? data.assignments.find(a => a.id === cfg.ccAssignmentId) : null;
                const tpA = cfg.tpAssignmentId ? data.assignments.find(a => a.id === cfg.tpAssignmentId) : null;
                const compA = cfg.compAssignmentId ? data.assignments.find(a => a.id === cfg.compAssignmentId) : null;

                const hasTP = !!tpA;

                const d1Issue = groupHasExportScaleIssue(className, cfg, 'devoir1');
                const d2Issue = groupHasExportScaleIssue(className, cfg, 'devoir2');
                const devoirScaleIssue = d1Issue || d2Issue;

                const fmt = (v) => (v === null ? '' : round2(v).toFixed(2));

                const rows = students.map(s => {
                    const cc = ccA ? calcScaledScore(s.id, ccA) : null;
                    const tp = tpA ? calcScaledScore(s.id, tpA) : null;
                    const comp = compA ? calcScaledScore(s.id, compA) : null;
                    const devoir = computeDevoirFinal(s.id, className, cfg);

                    // Moyenne:
                    // sans TP: (devoir + CC + 2*Compo) / 4
                    // avec TP: (devoir + CC + TP + 2*Compo) / 5
                    let moyenne = null;
                    const requiredOk = (devoir !== null && cc !== null && comp !== null && (!hasTP || tp !== null));
                    if (requiredOk) {
                        moyenne = hasTP
                            ? (devoir + cc + tp + 2 * comp) / 5
                            : (devoir + cc + 2 * comp) / 4;
                    }


                    //console.log(s.name, { devoir, comp, moyenne })
                    const ccExpected = !!ccA;
                    const tpExpected = !!tpA;
                    const compExpected = !!compA;
                    const devoirExpected = true; // Devoir est attendu (m√™me si config vide => valeurs vides seront signal√©es via cellule)

                    const ccClass = cellClassForValue(cc, ccExpected);
                    const tpClass = cellClassForValue(tp, tpExpected);
                    const compClass = cellClassForValue(comp, compExpected);
                    const devoirClass = cellClassForValue(devoir, devoirExpected);
                    const avgClass = cellClassForValue(moyenne, (ccExpected && compExpected && (!hasTP || tpExpected)));


                    const rm = (window.computeExportRemarks)
                        ? window.computeExportRemarks({
                            devoir,
                            comp,
                            avg: moyenne,
                            currentLanguage,
                            seed: s.id || 0
                        })
                        : { obs: "", cons: "" };

                    const scopeKey = getRemarksScopeKey(className);
                    const ov = getOverride(scopeKey, s.id) || {};
                    const R = window.REMARKS_MESSAGES;
                    const consBandIdx = R ? findBandIndexLocal(R.avgBands, moyenne) : -1;
                    const teacherObsAll = getTeacherMessages("obs"); // toute la biblioth√®que prof (langue courante)

                    const autoObs = teacherObsAll.length
                        ? pickDeterministic(teacherObsAll, `${className}|${s.id}|obs|${moyenne}`)
                        : rm.obs; // fallback moteur si biblioth√®que vide


                    const obsCandidates = getObsCandidatesForRow(devoir, comp);
                    const consCandidates = getConsCandidatesForRow(moyenne);
                    const teacherConsBand = getTeacherMessages(`cons@${consBandIdx}`);
                    const optionsCons = [...teacherConsBand, ...consCandidates];

                    const consPool = [...teacherConsBand, ...consCandidates];
                    const autoCons = pickDeterministic(consPool, `${className}|${s.id}|cons|${moyenne}|band:${consBandIdx}`);


                    const teacherObs = getTeacherMessages("obs");
                    const teacherCons = getTeacherMessages("cons");
                    const finalObs = (ov.obs && ov.obs.trim()) ? ov.obs : rm.obs;
                    const finalCons = (ov.cons && ov.cons.trim()) ? ov.cons : (autoCons || rm.cons);
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 bg-gray-50 sticky left-0 z-10 font-medium">${s.name}</td>

                            <td class="p-3 text-center ${ccClass}" title="${cc === null && ccExpected ? (t.missingGrade || '') : (cc === 0 ? (t.zeroGrade || '') : '')}">
                            ${fmt(cc)}
                            </td>

                            <td class="p-3 text-center font-bold ${devoirClass}" title="${devoir === null ? (t.missingGrade || '') : (devoir === 0 ? (t.zeroGrade || '') : '')}">
                            ${fmt(devoir)}
                            </td>

                            ${hasTP ? `
                            <td class="p-3 text-center ${tpClass}" title="${tp === null && tpExpected ? (t.missingGrade || '') : (tp === 0 ? (t.zeroGrade || '') : '')}">
                                ${fmt(tp)}
                            </td>` : ``}

                            <td class="p-3 text-center ${compClass}" title="${comp === null && compExpected ? (t.missingGrade || '') : (comp === 0 ? (t.zeroGrade || '') : '')}">
                            ${fmt(comp)}
                            </td>

                            <td class="p-3 text-center font-bold ${avgClass}">
                            ${fmt(moyenne)}
                            </td>
                            <td class="p-3 text-left">
                            <div class="remark-cell" data-scope="${escapeHtml(scopeKey)}" data-student-id="${escapeHtml(s.id)}" data-kind="obs" data-avg="${escapeHtml(moyenne)}">
                                <div class="remark-text text-sm leading-snug">${escapeHtml(finalObs)}</div>
                                <div class="mt-1 flex gap-2">
                                <button type="button" class="remark-edit-btn text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Modifier</button>
                                    <button type="button" class="remark-auto-btn text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">Auto</button>
                                    <button type="button" class="remark-custom-btn text-xs px-2 py-1 bg-indigo-100 hover:bg-indigo-200 rounded">+ Perso</button>
                                </div>
                                <div class="remark-editor mt-2 hidden">
                                <select class="remark-select w-full p-2 border rounded bg-white text-sm">
                                    <option value="">(Auto)</option>                                    
                                    ${teacherObs.map(msg => `<option value="${escapeHtml(msg)}">${escapeHtml(msg.slice(0, 120))}${msg.length > 120 ? "‚Ä¶" : ""}</option>`).join("")}
                                    ${obsCandidates.map(msg => `<option value="${escapeHtml(msg)}">${escapeHtml(msg.slice(0, 120))}${msg.length > 120 ? "‚Ä¶" : ""}</option>`).join("")}
                                </select>
                                </div>
                            </div>
                            </td>

                            <td class="p-3 text-left">
                            <div class="remark-cell" data-scope="${escapeHtml(scopeKey)}" data-student-id="${escapeHtml(s.id)}" data-kind="cons" data-avg="${escapeHtml(moyenne)}" data-cons-band="${consBandIdx}">
                                <div class="remark-text text-sm leading-snug">${escapeHtml(finalCons)}</div>
                                <div class="mt-1 flex gap-2">
                                    <button type="button" class="remark-edit-btn text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded">Modifier</button>
                                    <button type="button" class="remark-auto-btn text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">Auto</button>
                                    <button type="button" class="remark-custom-btn text-xs px-2 py-1 bg-indigo-100 hover:bg-indigo-200 rounded">+ Perso</button>
                                </div>
                                <div class="remark-editor mt-2 hidden">
                                <select class="remark-select w-full p-2 border rounded bg-white text-sm">
                                    <option value="">(Auto)</option>
                                    ${optionsCons.map(msg => `<option value="${escapeHtml(msg)}">${escapeHtml(msg)}</option>`).join("")}
                                </select>
                                </div>
                            </div>
                            </td>

                        </tr>
                        `;
                }).join('');

                const cols = [
                    '<col style="width:240px">',
                    '<col style="width:110px">', // CC
                    '<col style="width:120px">'  // Devoir (un peu plus large pour ‚ö†Ô∏è)
                ];
                if (hasTP) cols.push('<col style="width:110px">');
                cols.push('<col style="width:130px">'); // Composition
                cols.push('<col style="width:130px">');
                cols.push('<col style="width:220px">');
                cols.push('<col style="width:220px">');
                const classHeader = `
                <div class="mb-2 font-bold text-lg text-gray-700">
                    ${t.class || ' '}  ${className}
                </div>
                `;
                // Nombre total de colonnes (pour le colspan)
                // Nom + CC + Devoir + (TP?) + Compo + Moyenne
                let colCount = 1 + 1 + 1 + 1 + 1;
                if (hasTP) colCount += 1;
                colCount += 2;

                preview.innerHTML = `
                        <table class="w-full table-fixed border-collapse">
                        <colgroup>${cols.join('')}</colgroup>
                        <thead>
                            <!-- ‚úÖ NOUVELLE LIGNE : NOM DE LA CLASSE -->
                            <tr class="bg-gray-200 border-b-2 border-gray-300">
                            <th colspan="${colCount}" class="p-4 text-center text-xl font-bold uppercase tracking-wide text-gray-800">
                                ${className}
                            </th>
                            </tr>

                            <!-- Ligne des titres colonnes (inchang√©e) -->
                            <tr class="border-b-2">
                            <th class="p-3 text-left bg-gray-100 sticky left-0 z-10">${t.student}</th>
                            <th class="p-3 text-center bg-gray-100" data-translate="ccShort">${t.ccShort || 'CC'}</th>

                            <th class="p-3 text-center ${devoirScaleIssue ? 'bg-amber-200 text-amber-900' : 'bg-blue-100 text-blue-900'}"
                                title="${devoirScaleIssue ? (t.exportDevoirWarning || '') : (t.exportDevoirOk || '')}">
                                <span data-translate="devoirShort">${t.devoirShort || 'Devoir'}</span>
                                <span class="ml-1">${devoirScaleIssue ? '‚ö†Ô∏è' : '‚ö†Ô∏è'}</span>
                            </th>

                            ${hasTP ? `<th class="p-3 text-center bg-gray-100" data-translate="tpShort">${t.tpShort || 'TP'}</th>` : ``}

                            <th class="p-3 text-center bg-gray-100" data-translate="compositionShort">${t.compositionShort || 'Composition'}</th>
                            <th class="p-3 text-center bg-green-100" data-translate="avgShort">${t.avgShort || 'Moyenne'}</th>
                            <th class="p-3 text-center bg-gray-100" data-translate="observationShort">${t.observationShort || 'Observation'}</th>
                            <th class="p-3 text-center bg-gray-100" data-translate="adviceShort">${t.adviceShort || 'Conseil'}</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        </table>
                    `;



                preview.querySelectorAll(".remark-cell").forEach(cell => {
                    const scopeKey = cell.dataset.scope;
                    const studentId = cell.dataset.studentId;
                    const kind = cell.dataset.kind;
                    const avg = parseFloat(cell.dataset.avg || "NaN");

                    const btnEdit = cell.querySelector(".remark-edit-btn");
                    const btnAuto = cell.querySelector(".remark-auto-btn");
                    const btnCustom = cell.querySelector(".remark-custom-btn");

                    const editor = cell.querySelector(".remark-editor");
                    const select = cell.querySelector(".remark-select");

                    // init select (si override existe)
                    const ov = getOverride(scopeKey, studentId);
                    select.value = (ov && ov[kind]) ? ov[kind] : "";

                    btnEdit.addEventListener("click", () => {
                        editor.classList.toggle("hidden");
                    });

                    btnAuto.addEventListener("click", () => {
                        clearOverrideField(scopeKey, studentId, kind);
                        renderExportPrep(); // rerender complet
                    });

                    btnCustom.addEventListener("click", () => {
                        const label = kind === "obs" ? "Observation" : "Conseil";
                        const msg = prompt(`Ajouter un message perso (${label}) :`);
                        if (!msg) return;

                        if (kind === "cons") {
                            const R = window.REMARKS_MESSAGES;
                            const bandIdx = parseInt(cell.dataset.consBand || "-1", 10);
                            addTeacherMessage(`cons@${bandIdx}`, msg);

                        } else {
                            addTeacherMessage("obs", msg);
                        }

                        //if (!ok) return;

                        // Mettre ce message directement pour l'√©l√®ve
                        setOverride(scopeKey, studentId, { [kind]: msg.trim() });

                        renderExportPrep(); // rerender pour voir le message + qu'il apparaisse dans la liste
                    });
                    select.addEventListener("change", () => {
                        const chosen = select.value;
                        if (!chosen) clearOverrideField(scopeKey, studentId, kind);
                        else setOverride(scopeKey, studentId, { [kind]: chosen });

                        renderExportPrep(); // rerender complet
                    });
                });

                translatePage();
            }
            // Convertit un √©ventuel num√©ro de s√©rie Excel en Date
            function parseDateMaybeExcel(value) {
                if (value === undefined || value === null) return null;
                // Si d√©j√† objet Date
                if (value instanceof Date && !isNaN(value)) return value;

                // Si cha√Æne vide
                const v = String(value).trim();
                if (!v) return null;

                // Si nombre (ex: 38962)
                const num = Number(v);
                if (!isNaN(num) && num > 10000) { // seuil pour distinguer des ann√©es simples
                    // Origine Excel : 1899-12-30
                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                    return new Date(excelEpoch.getTime() + num * 86400 * 1000);
                }

                // Sinon, tenter un parse normal
                const d = new Date(v);
                return isNaN(d) ? null : d;
            }

            // Formate en jj/mm/aaaa
            function formatDate(d) {
                if (!d) return '';
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }

            function printExportTable() {
                const wrap = document.getElementById("export-preview-table");
                const table = document.querySelector("#export-preview-table table");
                if (!wrap || !table) { alert("Tableau introuvable !"); return; }

                const className = document.getElementById("select-class-export")?.value || "";

                // Clone propre
                const clone = table.cloneNode(true);

                // Nettoyer les cellules obs/cons: garder uniquement le texte visible
                clone.querySelectorAll(".remark-cell").forEach(cell => {
                    const txt = cell.querySelector(".remark-text")?.textContent || "";
                    cell.innerHTML = escapeHtml(txt);
                });

                // (S√©curit√©) supprimer boutons/inputs qui peuvent trainer
                clone.querySelectorAll("button, select, input, textarea").forEach(el => el.remove());

                const win = window.open("", "_blank");
                win.document.write(`
                    <html>
                    <head>
                        <title>Impression</title>
                        <style>
                        body { font-family: sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 14px; }
                        th, td { border: 1px solid #444; padding: 6px 8px; text-align: center; vertical-align: top; }
                        th { background: #eee; }
                        </style>
                    </head>
                    <body>
                        <h3 style="margin-bottom:20px;">${escapeHtml(className)}</h3>
                    </body>
                    </html>
                `);

                win.document.body.appendChild(clone);
                win.document.close();
                win.focus();
                setTimeout(() => win.print(), 250);
            }

            function exportExportTableXLSX() {
                const table = document.querySelector("#export-preview-table table");
                if (!table) { alert("Tableau introuvable !"); return; }

                const clone = table.cloneNode(true);

                // Remplacer les cellules remark par juste le texte final visible
                clone.querySelectorAll(".remark-cell").forEach(cell => {
                    const txt = cell.querySelector(".remark-text")?.textContent || "";
                    cell.innerHTML = escapeHtml(txt);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(clone, { raw: true });
                XLSX.utils.book_append_sheet(wb, ws, "Export");
                XLSX.writeFile(wb, "export-classe.xlsx");
            }

            function doRakamna() {
                // 1) Contr√¥le AVANT de proposer le choix du fichier
                if (typeof precheckRakmanaAllClassesConfig === 'function') {
                    const ok = precheckRakmanaAllClassesConfig();
                    if (!ok) return; // on stoppe ici
                } else {
                    console.warn("[Rakmana] precheckRakmanaAllClassesConfig() n'est pas d√©fini.");
                }

                // 2) Seulement si tout est OK -> ouvrir le fichier
                const fileInput = document.getElementById('rakmana-file-input');
                if (!fileInput) {
                    alert("Impossible de trouver l'input fichier (#rakmana-file-input).");
                    return;
                }

                fileInput.value = ''; // Reset pour permettre de re-s√©lectionner le m√™me fichier
                fileInput.click();
            }

            function onRakmanaFileSelected(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        processRakmanaWorkbookExcelJS_AllClasses(e.target.result, file.name);
                    } catch (err) {
                        alert("Erreur lors de la lecture du fichier Excel : " + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            async function handleRakamnaFile(event) {
                const file = event.target.files[0];
                if (!file) {
                    event.target.value = '';
                    return;
                }

                const t = translations[currentLanguage];
                const classNameToMatch = document.getElementById('select-class-export')?.value || '';

                if (!classNameToMatch) {
                    alert(t.rakamnaSelectClassWarning || "Veuillez s√©lectionner une classe d'abord.");
                    event.target.value = ''; // Reset file input
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await processRakmanaWorkbookExcelJS_AllClasses(e.target.result, file.name);
                    } catch (error) {
                        alert(t.rakamnaProcessingError || "Une erreur est survenue lors du traitement du fichier XLSX.");
                    } finally {
                        event.target.value = '';
                    }
                };

                reader.onerror = (error) => {
                    alert(t.rakamnaFileReadError || "Erreur lors de la lecture du fichier.");
                };
                reader.readAsArrayBuffer(file);
            }
            // Ta fonction processRakmanaWorkbook (avec la correction `s.id`)
            async function processRakmanaWorkbookExcelJS(arrayBuffer, originalFileName) {
                const t = translations[currentLanguage];
                const className = document.getElementById('select-class-export')?.value || '';
                if (!className) {
                    alert(t.selectClass || "Veuillez s√©lectionner une classe d'abord.");
                    return;
                }

                console.log("[Rakmana] üöÄ D√©marrage de la strat√©gie hybride (ExcelJS + JSZip)");

                // ===== √âTAPE 1 : G√©n√©rer le fichier modifi√© avec ExcelJS =====
                console.log("[Rakmana] üìù Chargement et modification avec ExcelJS...");
                const excelWb = new ExcelJS.Workbook();
                await excelWb.xlsx.load(arrayBuffer);
                const cleanClassName = className.replace(/\s/g, '').toUpperCase();
                let targetWorksheet = null;
                let targetSheetName = null;

                for (const ws of excelWb.worksheets) {
                    const r5 = ws.getRow(5);
                    let txt = '';
                    for (let c = 1; c <= Math.max(ws.columnCount, 20); c++) {
                        const v = r5.getCell(c).value;
                        if (v !== undefined && v !== null) txt += String(v);
                    }
                    const clean = txt.replace(/\s/g, '').toUpperCase();
                    if (clean.includes(cleanClassName)) {
                        targetWorksheet = ws;
                        targetSheetName = ws.name;
                        break;
                    }
                }
                if (!targetWorksheet) {
                    alert(t.rakamnaClassSheetNotFound || `Classe "${className}" non trouv√©e.`);
                    return;
                }

                console.log(`[Rakmana] ‚úÖ Feuille trouv√©e: "${targetSheetName}"`);

                const headerRow = targetWorksheet.getRow(8);
                const HEADERS = {
                    cc: 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±',
                    devoir: 'ŸÖÿπÿØŸÑ ÿßŸÑŸÅÿ±Ÿàÿ∂',
                    tp: 'ÿßŸÑŸÖÿ∑ÿßŸÑÿπÿ©',
                    comp: 'ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
                    obs: 'ÿßŸÑÿ™ŸÇÿØŸäÿ±ÿßÿ™',   // Observation / appr√©ciation
                    cons: 'ÿßŸÑÿßÿ±ÿ¥ÿßÿØÿßÿ™'   // Conseil / guidance
                };
                const findColumnIndex = (needle) => {
                    const norm = needle.replace(/\s/g, '');
                    for (let i = 1; i <= Math.max(targetWorksheet.columnCount, 40); i++) {
                        const v = headerRow.getCell(i).value;
                        const s = String(v || '').replace(/\s/g, '');
                        if (s.includes(norm)) return i;
                    }
                    return -1;
                };
                const colIndices = {
                    cc: findColumnIndex(HEADERS.cc),
                    devoir: findColumnIndex(HEADERS.devoir),
                    tp: findColumnIndex(HEADERS.tp),
                    comp: findColumnIndex(HEADERS.comp),
                    obs: findColumnIndex(HEADERS.obs),
                    cons: findColumnIndex(HEADERS.cons)
                };
                if (colIndices.cc === -1 && colIndices.devoir === -1 && colIndices.comp === -1) {
                    alert(t.rakamnaHeadersNotFound || "Impossible de trouver les en-t√™tes de colonnes (CC, Devoir, Composition) dans la ligne 8.");
                    return;
                }
                const cfg = getExportClassConfig(className);
                const ccA = cfg.ccAssignmentId ? data.assignments.find(a => a.id === cfg.ccAssignmentId) : null;
                const compA = cfg.compAssignmentId ? data.assignments.find(a => a.id === cfg.compAssignmentId) : null;
                const tpA = cfg.tpAssignmentId ? data.assignments.find(a => a.id === cfg.tpAssignmentId) : null;
                const hasTP = cfg.hasTp && tpA;
                const gradesByNIN = {};
                const averagesDebug = [];   // toutes les moyennes calcul√©es (par √©l√®ve de la classe)
                const matchedDebug = [];    // uniquement ceux r√©ellement match√©s dans le fichier Excel

                console.log("[Rakmana] Poids utilis√©s pour la moyenne :", {
                    cc: cfg?.weightCc ?? 1,
                    devoir: cfg?.weightDevoir ?? 1,
                    tp: cfg?.weightTp ?? 1,
                    comp: cfg?.weightComp ?? 1
                });
                data.students.forEach(s => {
                    if ((s.className || '').trim() !== className) return;

                    const cc = ccA ? calcScaledScore(s.id, ccA) : null;
                    const comp = compA ? calcScaledScore(s.id, compA) : null;
                    const devoir = computeDevoirFinal(s.id, className, cfg);
                    const tp = hasTP ? calcScaledScore(s.id, tpA) : null;

                    const nin = String(s.nin || '').replace(/\s/g, '').trim();
                    if (!nin) return;

                    const g = { cc, devoir, tp, comp };
                    const avg = computeAverageFromGrades(g, cfg, hasTP);

                    // Stocke aussi avg (pratique pour r√©utiliser dans la boucle Excel)
                    gradesByNIN[nin] = { ...g, avg, _studentId: s.id };

                    // Nom lisible (selon tes champs existants)
                    const name =
                        s.fullName ||
                        s.name ||
                        s.nomComplet ||
                        `${s.lastName || s.nom || ''} ${s.firstName || s.prenom || ''}`.trim();

                    averagesDebug.push({
                        nin,
                        name,
                        cc: cc == null ? null : round2(cc),
                        devoir: devoir == null ? null : round2(devoir),
                        tp: tp == null ? null : round2(tp),
                        comp: comp == null ? null : round2(comp),
                        moyenne: avg == null ? null : round2(avg)
                    });
                });
                console.group(`[Rakmana] Moyennes calcul√©es (${className})`);
                console.table(
                    averagesDebug
                        .slice()
                        .sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')))
                );
                console.groupEnd();

                let matchCount = 0;
                let lastRow = 8;
                const lastCol = Math.max(targetWorksheet.columnCount, 10);
                for (let r = 9; r <= targetWorksheet.rowCount; r++) {
                    const v = targetWorksheet.getRow(r).getCell(1).value;
                    const ninTxtRaw = v === undefined || v === null ? '' : String(v);
                    const ninTxtTrim = ninTxtRaw.replace(/\s/g, '').trim();
                    if (!ninTxtTrim) break;
                    lastRow = r;
                    let ninInExcel = ninTxtTrim;
                    if (ninInExcel.endsWith('.0') && /^\d+\.0$/.test(ninInExcel)) ninInExcel = ninInExcel.substring(0, ninInExcel.length - 2);
                    const g = gradesByNIN[ninInExcel];
                    if (g) {
                        matchCount++;
                        const writeGrade = (colIndex, val) => {
                            if (colIndex === -1) return;
                            if (val === null || val === undefined) { targetWorksheet.getRow(r).getCell(colIndex).value = null; return; }
                            const numVal = Math.round((val + Number.EPSILON) * 100) / 100;
                            targetWorksheet.getRow(r).getCell(colIndex).value = numVal;
                        };
                        writeGrade(colIndices.cc, g.cc);
                        writeGrade(colIndices.devoir, g.devoir);
                        if (hasTP && colIndices.tp !== -1) writeGrade(colIndices.tp, g.tp);
                        writeGrade(colIndices.comp, g.comp);
                        // --- NOUVEAU : Observation + Conseil selon la moyenne ---
                        const avg = computeAverageFromGrades(g, cfg, hasTP);
                        const { obs, cons } = observationAndAdviceFromAverage(avg);

                        if (colIndices.obs !== -1) targetWorksheet.getRow(r).getCell(colIndices.obs).value = obs;
                        if (colIndices.cons !== -1) targetWorksheet.getRow(r).getCell(colIndices.cons).value = cons;
                    }
                }
                if (matchCount === 0) {
                    alert(t.rakamnaNoStudentsMatched || "Attention : Aucun √©l√®ve n'a √©t√© trouv√© dans le fichier Excel avec un NIN correspondant.");
                    return;
                }

                console.log(`[Rakmana] ‚úçÔ∏è ${matchCount} √©l√®ve(s) mis √† jour avec ExcelJS`);

                // G√©n√©rer le buffer modifi√©
                const correctedBuffer = await excelWb.xlsx.writeBuffer();
                console.log("[Rakmana] ‚úÖ Fichier modifi√© g√©n√©r√© (SANS protection)");

                // ===== √âTAPE 2 : Extraire la protection du fichier original avec JSZip =====
                console.log("[Rakmana] üîê Extraction de la protection du fichier original...");

                // V√©rifier que JSZip est disponible
                if (typeof JSZip === 'undefined') {
                    console.warn("[Rakmana] ‚ö†Ô∏è JSZip non disponible, t√©l√©chargement sans protection...");
                    // Fallback : t√©l√©charger sans protection
                    const blob = new Blob([correctedBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = originalFileName;
                    document.body.appendChild(link);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    document.body.removeChild(link);
                    alert(`‚úÖ ${matchCount} √©l√®ve(s) mis √† jour.\n‚ö†Ô∏è La protection n'a pas pu √™tre pr√©serv√©e (JSZip manquant).`);
                    return;
                }

                const originalZip = await JSZip.loadAsync(arrayBuffer);
                const correctedZip = await JSZip.loadAsync(correctedBuffer);

                // Lire workbook.xml pour trouver les feuilles
                const workbookXml = await originalZip.file("xl/workbook.xml")?.async("string");
                const workbookRelsXml = await originalZip.file("xl/_rels/workbook.xml.rels")?.async("string");

                if (!workbookXml || !workbookRelsXml) {
                    console.warn("[Rakmana] ‚ö†Ô∏è Structure Excel invalide, t√©l√©chargement sans protection...");
                    const blob = new Blob([correctedBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = originalFileName;
                    document.body.appendChild(link);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    document.body.removeChild(link);
                    alert(`‚úÖ ${matchCount} √©l√®ve(s) mis √† jour.\n‚ö†Ô∏è La protection n'a pas pu √™tre pr√©serv√©e.`);
                    return;
                }

                const parser = new DOMParser();
                const wbDoc = parser.parseFromString(workbookXml, "text/xml");
                const relsDoc = parser.parseFromString(workbookRelsXml, "text/xml");

                // ===== √âTAPE 3 : Parcourir chaque feuille et transplanter la protection =====
                const sheets = Array.from(wbDoc.getElementsByTagName("sheet"));
                let protectionTransplanted = false;

                for (const sheetNode of sheets) {
                    const sheetName = sheetNode.getAttribute("name");
                    const rId = sheetNode.getAttribute("r:id");

                    // Trouver le fichier XML de la feuille
                    const relNode = Array.from(relsDoc.getElementsByTagName("Relationship"))
                        .find(n => n.getAttribute("Id") === rId);
                    const target = relNode?.getAttribute("Target");
                    if (!target) continue;

                    const fullPath = target.startsWith("/") ? target.substring(1) : `xl/${target}`;

                    // Extraire le tag de protection du fichier original
                    const originalSheetXml = await originalZip.file(fullPath)?.async("string");
                    if (!originalSheetXml) continue;

                    const protectionMatch = originalSheetXml.match(/<sheetProtection[^>]*\/>/);
                    if (!protectionMatch) {
                        console.log(`[Rakmana] ‚ÑπÔ∏è Pas de protection dans la feuille "${sheetName}"`);
                        continue;
                    }

                    const protectionTag = protectionMatch[0];
                    console.log(`[Rakmana] üîç Protection trouv√©e dans "${sheetName}": ${protectionTag}`);

                    // Charger le XML de la feuille modifi√©e
                    let correctedSheetXml = await correctedZip.file(fullPath)?.async("string");
                    if (!correctedSheetXml) continue;

                    // CRITIQUE : Supprimer toute protection existante
                    correctedSheetXml = correctedSheetXml.replace(/<sheetProtection[^>]*\/>/g, '');
                    console.log(`[Rakmana] üóëÔ∏è Protection existante supprim√©e dans "${sheetName}"`);

                    // Trouver le point d'insertion (apr√®s </sheetData>)
                    const sheetDataEndIndex = correctedSheetXml.indexOf("</sheetData>");
                    if (sheetDataEndIndex === -1) {
                        console.warn(`[Rakmana] ‚ö†Ô∏è Balise </sheetData> non trouv√©e dans "${sheetName}"`);
                        continue;
                    }

                    const insertionPoint = sheetDataEndIndex + "</sheetData>".length;

                    // Ins√©rer le tag de protection ORIGINAL
                    correctedSheetXml =
                        correctedSheetXml.substring(0, insertionPoint) +
                        protectionTag +
                        correctedSheetXml.substring(insertionPoint);

                    // √âcrire le XML modifi√© dans le zip
                    correctedZip.file(fullPath, correctedSheetXml);
                    console.log(`[Rakmana] ‚úÖ Protection transplant√©e dans "${sheetName}"`);
                    protectionTransplanted = true;
                }

                // ===== √âTAPE 4 : G√©n√©rer le fichier final =====
                console.log("[Rakmana] üì¶ G√©n√©ration du fichier final...");
                const finalBlob = await correctedZip.generateAsync({ type: "blob" });

                // T√©l√©charger le fichier
                const link = document.createElement('a');
                link.href = URL.createObjectURL(finalBlob);
                link.download = originalFileName;
                document.body.appendChild(link);
                link.click();
                URL.revokeObjectURL(link.href);
                document.body.removeChild(link);

                console.log("[Rakmana] üéâ Fichier t√©l√©charg√© avec succ√®s!");

                const msg = protectionTransplanted
                    ? `‚úÖ ${matchCount} √©l√®ve(s) mis √† jour\nüîê Protection par mot de passe pr√©serv√©e`
                    : `‚úÖ ${matchCount} √©l√®ve(s) mis √† jour\n‚ÑπÔ∏è Aucune protection n'a √©t√© d√©tect√©e dans le fichier original`;

                alert(msg);
            }

            //const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
            async function processRakmanaWorkbookExcelJS_AllClasses(arrayBuffer, originalFileName) {
                const t = translations[currentLanguage] || {};

                // 1) R√©cup√©rer toutes les classes "enseignant"
                const select = document.getElementById('select-class-export');
                const classNames = select
                    ? Array.from(select.options).map(o => (o.value || '').trim()).filter(Boolean)
                    : [...new Set((data.students || []).map(s => (s.className || '').trim()).filter(Boolean))];

                if (!classNames.length) {
                    alert(t.selectClass || "Aucune classe trouv√©e.");
                    return;
                }

                console.log("[Rakmana] Export multi-classes - classes d√©tect√©es :", classNames);

                // 2) Charger workbook
                const excelWb = new ExcelJS.Workbook();
                await excelWb.xlsx.load(arrayBuffer);

                // Helpers
                const normalize = (s) => String(s || '').replace(/\s/g, '').toUpperCase();

                const extractNIN = (cellValue) => {
                    if (cellValue === undefined || cellValue === null) return '';
                    let s = String(cellValue).replace(/\s/g, '').trim();
                    if (!s) return '';
                    if (s.endsWith('.0') && /^\d+\.0$/.test(s)) s = s.slice(0, -2);
                    return s;
                };

                const findWorksheetForClass = (className) => {
                    const cleanClass = normalize(className);
                    for (const ws of excelWb.worksheets) {
                        const r5 = ws.getRow(5);
                        let txt = '';
                        for (let c = 1; c <= Math.max(ws.columnCount, 20); c++) {
                            const v = r5.getCell(c).value;
                            if (v !== undefined && v !== null) txt += String(v);
                        }
                        if (normalize(txt).includes(cleanClass)) return ws;
                    }
                    return null;
                };

                // En-t√™tes (ligne 8)
                const HEADERS = {
                    cc: 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±',
                    devoir: 'ŸÖÿπÿØŸÑ ÿßŸÑŸÅÿ±Ÿàÿ∂',
                    tp: 'ÿßŸÑŸÖÿ∑ÿßŸÑÿπÿ©',
                    comp: 'ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
                    obs: 'ÿßŸÑÿ™ŸÇÿØŸäÿ±ÿßÿ™',
                    cons: 'ÿßŸÑÿßÿ±ÿ¥ÿßÿØÿßÿ™'
                };

                const findColumnIndex = (ws, headerRow, needle) => {
                    const norm = needle.replace(/\s/g, '');
                    for (let i = 1; i <= Math.max(ws.columnCount, 40); i++) {
                        const v = headerRow.getCell(i).value;
                        const s = String(v || '').replace(/\s/g, '');
                        if (s.includes(norm)) return i;
                    }
                    return -1;
                };

                // Lookup assignments rapide (optionnel mais propre)
                const assignmentsById = new Map((data.assignments || []).map(a => [a.id, a]));

                // 3) PRE-FLIGHT (on pr√©pare un "plan" pour garantir un export atomique)
                const plan = [];
                const issues = [];

                for (const className of classNames) {
                    const cfg = getExportClassConfig(className);

                    if (!cfg) {
                        issues.push(`- ${className}: configuration d'export absente.`);
                        continue;
                    }

                    const ccA = cfg.ccAssignmentId ? assignmentsById.get(cfg.ccAssignmentId) : null;
                    const compA = cfg.compAssignmentId ? assignmentsById.get(cfg.compAssignmentId) : null;
                    const tpA = cfg.tpAssignmentId ? assignmentsById.get(cfg.tpAssignmentId) : null;
                    const hasTP = !!(cfg.hasTp && tpA);

                    // Tu peux √™tre plus/moins strict ici. Je mets strict sur CC+Compo (souvent indispensables).
                    if (!ccA) issues.push(`- ${className}: CC non configur√© (ccAssignmentId manquant ou introuvable).`);
                    if (!compA) issues.push(`- ${className}: Composition non configur√©e (compAssignmentId manquant ou introuvable).`);
                    if (cfg.hasTp && !tpA) issues.push(`- ${className}: TP activ√© mais tpAssignmentId manquant ou introuvable.`);

                    const ws = findWorksheetForClass(className);
                    if (!ws) {
                        issues.push(`- ${className}: feuille non trouv√©e dans le classeur officiel (ligne 5).`);
                        continue;
                    }

                    const headerRow = ws.getRow(8);
                    const colIndices = {
                        cc: findColumnIndex(ws, headerRow, HEADERS.cc),
                        devoir: findColumnIndex(ws, headerRow, HEADERS.devoir),
                        tp: findColumnIndex(ws, headerRow, HEADERS.tp),
                        comp: findColumnIndex(ws, headerRow, HEADERS.comp),
                        obs: findColumnIndex(ws, headerRow, HEADERS.obs),
                        cons: findColumnIndex(ws, headerRow, HEADERS.cons)
                    };

                    const missingHeaders = [];
                    if (colIndices.cc === -1) missingHeaders.push(HEADERS.cc);
                    if (colIndices.devoir === -1) missingHeaders.push(HEADERS.devoir);
                    if (colIndices.comp === -1) missingHeaders.push(HEADERS.comp);
                    if (hasTP && colIndices.tp === -1) missingHeaders.push(HEADERS.tp);
                    if (colIndices.obs === -1) missingHeaders.push(HEADERS.obs);
                    if (colIndices.cons === -1) missingHeaders.push(HEADERS.cons);

                    if (missingHeaders.length) {
                        issues.push(`- ${className}: en-t√™tes manquants (ligne 8): ${missingHeaders.join(' | ')}`);
                        continue;
                    }

                    // Construire gradesByNIN pour cette classe
                    const gradesByNIN = {};
                    let studentsWithNIN = 0;

                    (data.students || []).forEach(s => {
                        if ((s.className || '').trim() !== className) return;

                        const nin = String(s.nin || '').replace(/\s/g, '').trim();
                        if (!nin) return;

                        studentsWithNIN++;

                        const cc = ccA ? calcScaledScore(s.id, ccA) : null;
                        const comp = compA ? calcScaledScore(s.id, compA) : null;
                        const devoir = computeDevoirFinal(s.id, className, cfg);
                        const tp = hasTP ? calcScaledScore(s.id, tpA) : null;

                        gradesByNIN[nin] = { cc, devoir, tp, comp, studentId: s.id };
                    });

                    if (studentsWithNIN === 0) {
                        issues.push(`- ${className}: aucun √©l√®ve avec NIN c√¥t√© application.`);
                        continue;
                    }

                    // Dry-run matching dans Excel
                    let totalMatches = 0;
                    for (let r = 9; r <= ws.rowCount; r++) {
                        const nin = extractNIN(ws.getRow(r).getCell(1).value);
                        if (!nin) break;
                        if (gradesByNIN[nin]) totalMatches++;
                    }

                    if (totalMatches === 0) {
                        issues.push(`- ${className}: aucun NIN match√© dans la feuille Excel (colonne A).`);
                        continue;
                    }

                    // OK -> on ajoute au plan
                    plan.push({ className, cfg, ws, colIndices, gradesByNIN, hasTP, expectedMatches: totalMatches });
                }

                // S'il y a des probl√®mes (config/headers/sheets/matching), on annule tout
                if (issues.length) {
                    console.warn("[Rakmana] Export annul√© (preflight KO):\n" + issues.join("\n"));
                    alert(
                        "Export Rakmana annul√© : certaines classes ne sont pas pr√™tes.\n\n" +
                        issues.join("\n")
                    );
                    return;
                }

                // 4) APPLICATION : √©crire toutes les classes
                const perClassStats = [];
                let totalMatches = 0;

                for (const item of plan) {
                    const { className, cfg, ws, colIndices, gradesByNIN, hasTP } = item;

                    let classtotalMatches = 0;

                    const writeGrade = (r, colIndex, val) => {
                        if (colIndex === -1) return;
                        if (val === null || val === undefined) { ws.getRow(r).getCell(colIndex).value = null; return; }
                        ws.getRow(r).getCell(colIndex).value = round2(Number(val));
                    };

                    for (let r = 9; r <= ws.rowCount; r++) {
                        const nin = extractNIN(ws.getRow(r).getCell(1).value);
                        if (!nin) break;

                        const g = gradesByNIN[nin];
                        if (!g) continue;

                        classtotalMatches++;

                        // ... tes writeGrade existants ...
                        writeGrade(r, colIndices.cc, g.cc);
                        writeGrade(r, colIndices.devoir, g.devoir);
                        if (hasTP) writeGrade(r, colIndices.tp, g.tp);
                        writeGrade(r, colIndices.comp, g.comp);

                        const avg = computeAverageFromGrades(g, cfg, hasTP);
                        const scopeKey = getRemarksScopeKey(className);

                        // 1) Moteur principal, comme preview
                        const rm = window.computeExportRemarks
                            ? window.computeExportRemarks({
                                devoir: g.devoir,
                                comp: g.comp,
                                avg,
                                currentLanguage,
                                seed: g.studentId || 0
                            })
                            : { obs: "", cons: "" };

                        // 2) Overrides, comme preview
                        const ov = getOverride(scopeKey, g.studentId) || {};
                        const R = window.REMARKS_MESSAGES;
                        const consBandIdx = R ? findBandIndexLocal(R.avgBands, avg) : -1;

                        // 3) Pools et auto, comme preview
                        const teacherObsAll = getTeacherMessages("obs") || [];
                        const autoObs = teacherObsAll.length
                            ? pickDeterministic(teacherObsAll, `${className}|${g.studentId}|obs|${avg}`)
                            : rm.obs;

                        const obsCandidates = getObsCandidatesForRow(g.devoir, g.comp) || [];
                        const consCandidates = getConsCandidatesForRow(avg) || [];
                        const teacherConsBand = getTeacherMessages(`cons@${consBandIdx}`) || [];
                        const consPool = [...teacherConsBand, ...consCandidates];

                        const autoCons = consPool.length
                            ? pickDeterministic(consPool, `${className}|${g.studentId}|cons|${avg}|band:${consBandIdx}`)
                            : rm.cons;

                        // 4) Final, EXACTEMENT comme preview
                        let obs = (ov.obs && ov.obs.trim()) ? ov.obs : rm.obs;
                        let cons = (ov.cons && ov.cons.trim()) ? ov.cons : (autoCons || rm.cons);

                        // 5) Debug pour comparer avec preview
                        /*console.log("=== DEBUG", g.studentId);
                        console.log("devoir/comp/avg:", g.devoir, g.comp, avg);
                        console.log("rm:", rm);
                        console.log("ov:", ov);
                        console.log("consBandIdx:", consBandIdx);
                        console.log("teacherObsAll.length:", teacherObsAll.length);
                        console.log("obsCandidates[0]:", obsCandidates[0]);
                        console.log("consCandidates[0]:", consCandidates[0]);
                        console.log("teacherConsBand[0]:", teacherConsBand[0]);
                        console.log("autoObs:", autoObs);
                        console.log("autoCons:", autoCons);
                        console.log("FINAL Excel:", obs, "|", cons);
                        */
                        // 6) √âcriture
                        ws.getRow(r).getCell(colIndices.obs).value = obs;
                        ws.getRow(r).getCell(colIndices.cons).value = cons;


                    }

                    perClassStats.push({ classe: className, elevesMisAJour: classtotalMatches });
                    totalMatches += classtotalMatches;
                }

                console.table(perClassStats);
                console.log(`[Rakmana] Export multi-classes OK: ${plan.length} classe(s), ${totalMatches} √©l√®ve(s) mis √† jour.`);

                // 5) G√©n√©rer le buffer modifi√©
                const correctedBuffer = await excelWb.xlsx.writeBuffer();

                // 6) IMPORTANT : ici tu reprends EXACTEMENT ton bloc JSZip actuel
                console.log("[Rakmana] ‚úÖ Fichier modifi√© g√©n√©r√© (SANS protection)");

                // ===== √âTAPE 2 : Extraire la protection du fichier original avec JSZip =====
                console.log("[Rakmana] üîê Extraction de la protection du fichier original...");

                // V√©rifier que JSZip est disponible
                if (typeof JSZip === 'undefined') {
                    console.warn("[Rakmana] ‚ö†Ô∏è JSZip non disponible, t√©l√©chargement sans protection...");
                    // Fallback : t√©l√©charger sans protection
                    const blob = new Blob([correctedBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = originalFileName;
                    document.body.appendChild(link);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    document.body.removeChild(link);
                    alert(`‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour.\n‚ö†Ô∏è La protection n'a pas pu √™tre pr√©serv√©e (JSZip manquant).`);
                    return;
                }

                const originalZip = await JSZip.loadAsync(arrayBuffer);
                const correctedZip = await JSZip.loadAsync(correctedBuffer);

                // Lire workbook.xml pour trouver les feuilles
                const workbookXml = await originalZip.file("xl/workbook.xml")?.async("string");
                const workbookRelsXml = await originalZip.file("xl/_rels/workbook.xml.rels")?.async("string");

                if (!workbookXml || !workbookRelsXml) {
                    console.warn("[Rakmana] ‚ö†Ô∏è Structure Excel invalide, t√©l√©chargement sans protection...");
                    const blob = new Blob([correctedBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = originalFileName;
                    document.body.appendChild(link);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    document.body.removeChild(link);
                    alert(`‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour.\n‚ö†Ô∏è La protection n'a pas pu √™tre pr√©serv√©e.`);
                    return;
                }

                const parser = new DOMParser();
                const wbDoc = parser.parseFromString(workbookXml, "text/xml");
                const relsDoc = parser.parseFromString(workbookRelsXml, "text/xml");

                // ===== √âTAPE 3 : Parcourir chaque feuille et transplanter la protection =====
                const sheets = Array.from(wbDoc.getElementsByTagName("sheet"));
                let protectionTransplanted = false;

                for (const sheetNode of sheets) {
                    const sheetName = sheetNode.getAttribute("name");
                    const rId = sheetNode.getAttribute("r:id");

                    // Trouver le fichier XML de la feuille
                    const relNode = Array.from(relsDoc.getElementsByTagName("Relationship"))
                        .find(n => n.getAttribute("Id") === rId);
                    const target = relNode?.getAttribute("Target");
                    if (!target) continue;

                    const fullPath = target.startsWith("/") ? target.substring(1) : `xl/${target}`;

                    // Extraire le tag de protection du fichier original
                    const originalSheetXml = await originalZip.file(fullPath)?.async("string");
                    if (!originalSheetXml) continue;

                    const protectionMatch = originalSheetXml.match(/<sheetProtection[^>]*\/>/);
                    if (!protectionMatch) {
                        console.log(`[Rakmana] ‚ÑπÔ∏è Pas de protection dans la feuille "${sheetName}"`);
                        continue;
                    }

                    const protectionTag = protectionMatch[0];
                    console.log(`[Rakmana] üîç Protection trouv√©e dans "${sheetName}": ${protectionTag}`);

                    // Charger le XML de la feuille modifi√©e
                    let correctedSheetXml = await correctedZip.file(fullPath)?.async("string");
                    if (!correctedSheetXml) continue;

                    // CRITIQUE : Supprimer toute protection existante
                    correctedSheetXml = correctedSheetXml.replace(/<sheetProtection[^>]*\/>/g, '');
                    console.log(`[Rakmana] üóëÔ∏è Protection existante supprim√©e dans "${sheetName}"`);

                    // Trouver le point d'insertion (apr√®s </sheetData>)
                    const sheetDataEndIndex = correctedSheetXml.indexOf("</sheetData>");
                    if (sheetDataEndIndex === -1) {
                        console.warn(`[Rakmana] ‚ö†Ô∏è Balise </sheetData> non trouv√©e dans "${sheetName}"`);
                        continue;
                    }

                    const insertionPoint = sheetDataEndIndex + "</sheetData>".length;

                    // Ins√©rer le tag de protection ORIGINAL
                    correctedSheetXml =
                        correctedSheetXml.substring(0, insertionPoint) +
                        protectionTag +
                        correctedSheetXml.substring(insertionPoint);

                    // √âcrire le XML modifi√© dans le zip
                    correctedZip.file(fullPath, correctedSheetXml);
                    console.log(`[Rakmana] ‚úÖ Protection transplant√©e dans "${sheetName}"`);
                    protectionTransplanted = true;
                }

                // ===== √âTAPE 4 : G√©n√©rer le fichier final =====
                console.log("[Rakmana] üì¶ G√©n√©ration du fichier final...");
                const finalBlob = await correctedZip.generateAsync({ type: "blob" });

                // T√©l√©charger le fichier
                const link = document.createElement('a');
                link.href = URL.createObjectURL(finalBlob);
                link.download = originalFileName;
                document.body.appendChild(link);
                link.click();
                URL.revokeObjectURL(link.href);
                document.body.removeChild(link);

                console.log("[Rakmana] üéâ Fichier t√©l√©charg√© avec succ√®s!");

                const msg = protectionTransplanted
                    ? `‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour\nüîê Protection par mot de passe pr√©serv√©e`
                    : `‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour\n‚ÑπÔ∏è Aucune protection n'a √©t√© d√©tect√©e dans le fichier original`;

                //alert(msg);
                //alert(`‚úÖ ${plan.length} classe(s) mises √† jour\n‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour\nüîê Protection pr√©serv√©e si d√©tect√©e`);
                alert(`‚úÖ ${plan.length} classe(s) mises √† jour\n‚úÖ ${totalMatches} √©l√®ve(s) mis √† jour`);
                return { correctedBuffer, totalMatches, perClassStats }; // optionnel si tu veux utiliser ces infos ensuite
            }

            function getObsConsFromLocalStorageOnly(scopeKey, studentId) {
                const REMARKSOVERRIDEKEY = "corrections-remarks-overrides-v1";

                let overrides = {};
                try {
                    overrides = JSON.parse(localStorage.getItem(REMARKSOVERRIDEKEY)) || {};
                } catch (e) {
                    overrides = {};
                }

                const sid = String(studentId);
                const entry = overrides?.[String(scopeKey)]?.[sid] || null;

                return {
                    obs: entry?.obs != null ? String(entry.obs) : "",
                    cons: entry?.cons != null ? String(entry.cons) : ""
                };
            }

            // R√©cup√©rer obs/cons UNIQUEMENT depuis localStorage (overrides)
            // - Pas de calcul
            // - Pas de fallback auto
            // - Si pas trouv√© => "" (vide)
            function getObsConsFromLocalStorageOnly(className, studentId) {
                // M√™me cl√© que ton syst√®me actuel
                const REMARKSOVERRIDEKEY = "corrections-remarks-overrides-v1";

                // M√™me logique de scope que ton app (actuellement: scope = className)
                const scopeKey = String(className ?? "").trim();

                let overrides = {};
                try {
                    overrides = JSON.parse(localStorage.getItem(REMARKSOVERRIDEKEY)) || {};
                } catch (e) {
                    overrides = {};
                }

                const sid = String(studentId);
                const entry = overrides?.[scopeKey]?.[sid] || null;

                // IMPORTANT: pas de fallback, donc vide si absent
                const obs = entry?.obs != null ? String(entry.obs) : "";
                const cons = entry?.cons != null ? String(entry.cons) : "";

                return {
                    obs,
                    cons,
                    // optionnel: pour debug
                    found: !!entry,
                    updatedAt: entry?.updatedAt ?? null,
                };
            }

            function computeAverageFromGrades(g, cfg, hasTP) {
                const toNum = (x) => {
                    const n = Number(x);
                    return Number.isFinite(n) ? n : null;
                };

                const cc = toNum(g.cc);
                const dev = toNum(g.devoir);
                const compo = toNum(g.comp);
                const tp = toNum(g.tp);

                // On exige les 3 notes de base
                if (cc == null || dev == null || compo == null) return null;

                if (hasTP) {
                    // Si TP est cens√© compter, on exige TP
                    if (tp == null) return null;
                    return (cc + dev + tp + 2 * compo) / 5;
                }

                return (cc + dev + 2 * compo) / 4;
            }
            function observationAndAdviceFromAverage(avg) {
                // Exemple de bar√®me (√† adapter √† tes r√®gles)
                if (avg == null) return { obs: '', cons: '' };

                if (avg >= 18) return { obs: 'ŸÖŸÖÿ™ÿßÿ≤', cons: 'ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ.' };
                if (avg >= 16) return { obs: 'ÿ¨ŸäÿØ ÿ¨ÿØÿß', cons: 'ŸàÿßÿµŸÑ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ¨ŸäÿØ.' };
                if (avg >= 14) return { obs: 'ÿ¨ŸäÿØ', cons: 'ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ° ÿ®ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©.' };
                if (avg >= 12) return { obs: 'ŸÖÿ™Ÿàÿ≥ÿ∑', cons: 'ŸÜÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ™ÿ±ŸÉŸäÿ≤ ÿ£ŸÉÿ®ÿ± Ÿàÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸàŸÇÿ™.' };
                if (avg >= 10) return { obs: 'ŸÖŸÇÿ®ŸàŸÑ', cons: 'ÿ±ÿßÿ¨ÿπ ÿßŸÑÿØÿ±Ÿàÿ≥ ÿ®ÿßŸÜÿ™ÿ∏ÿßŸÖ Ÿàÿßÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©.' };
                return { obs: 'ÿ∂ÿπŸäŸÅ', cons: 'ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ®ÿ∞ŸÑ ŸÖÿ¨ŸáŸàÿØ ÿ£ŸÉÿ®ÿ± ŸàÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±ÿ©.' };
            }

            function collectSelectedAssignmentIdsFromGroup(groupCfg, assignmentsById) {
                const out = new Set();

                // Champs "techniques" qu'on ignore pour √©viter de prendre targetMax=20 comme un id, etc.
                const SKIP_KEYS = new Set(['combine', 'normalize', 'targetMax']);

                const walk = (node) => {
                    if (node == null) return;

                    if (Array.isArray(node)) {
                        node.forEach(walk);
                        return;
                    }

                    const t = typeof node;

                    // Si on tombe sur une valeur primitive qui correspond √† un assignmentId -> on prend
                    if (t === 'string' || t === 'number') {
                        const id = String(node);
                        if (assignmentsById.has(id)) out.add(id);
                        return;
                    }

                    if (t === 'object') {
                        for (const [k, v] of Object.entries(node)) {
                            if (SKIP_KEYS.has(k)) continue;

                            // Cas fr√©quent: map { "assignmentId": true/false }
                            const keyAsId = String(k);
                            if (assignmentsById.has(keyAsId) && !!v) out.add(keyAsId);

                            // On continue de descendre (au cas o√π la s√©lection est dans node.picks, node.selectedIds, etc.)
                            walk(v);
                        }
                    }
                };

                walk(groupCfg);
                return [...out];
            }

            function getSelectedDevoirIds(cfg, assignmentsById) {
                const ids = new Set();

                for (const id of collectSelectedAssignmentIdsFromGroup(cfg?.devoir1, assignmentsById)) ids.add(id);
                for (const id of collectSelectedAssignmentIdsFromGroup(cfg?.devoir2, assignmentsById)) ids.add(id);

                return [...ids];
            }
            function precheckRakmanaAllClassesConfig() {
                const t = translations[currentLanguage] || {};

                const select = document.getElementById('select-class-export');
                const classNames = select
                    ? Array.from(select.options).map(o => (o.value || '').trim()).filter(Boolean)
                    : [...new Set((data.students || []).map(s => (s.className || '').trim()).filter(Boolean))];

                if (!classNames.length) {
                    alert(t.selectClass || "Aucune classe trouv√©e.");
                    return false;
                }

                const assignmentsById = new Map((data.assignments || []).map(a => [a.id, a]));
                const issues = [];

                for (const className of classNames) {
                    const cfg = getExportClassConfig(className);
                    if (!cfg) {
                        issues.push(`- ${className}: configuration d'export absente.`);
                        continue;
                    }

                    // CC obligatoire
                    if (!cfg.ccAssignmentId || !assignmentsById.has(cfg.ccAssignmentId)) {
                        issues.push(`- ${className}: CC non s√©lectionn√© (ou activit√© introuvable).`);
                    }

                    // Compo obligatoire
                    if (!cfg.compAssignmentId || !assignmentsById.has(cfg.compAssignmentId)) {
                        issues.push(`- ${className}: Composition non s√©lectionn√©e (ou activit√© introuvable).`);
                    }

                    // Devoir : au moins 1 devoir s√©lectionn√©
                    const devoirIds = getSelectedDevoirIds(cfg, assignmentsById);

                    if (devoirIds.length === 0) {
                        issues.push(`- ${className}: aucun devoir s√©lectionn√© (Devoir 1 ou Devoir 2 requis).`);
                    }

                    // TP si activ√©
                    if (cfg.hasTp) {
                        if (!cfg.tpAssignmentId || !assignmentsById.has(cfg.tpAssignmentId)) {
                            issues.push(`- ${className}: TP activ√© mais activit√© TP non s√©lectionn√©e (ou introuvable).`);
                        }
                    }
                }

                if (issues.length) {
                    alert(
                        "Export Rakmana annul√© : certaines classes ne sont pas configur√©es.\n\n" +
                        issues.join("\n")
                    );
                    return false;
                }

                return true;
            }
            function isClassReadyForRakmana(className) {
                const assignmentsById = new Map((data.assignments || []).map(a => [String(a.id), a]));
                const cfg = getExportClassConfig(className);

                if (!cfg) return false;

                // CC + Compo obligatoires
                if (!cfg.ccAssignmentId || !assignmentsById.has(String(cfg.ccAssignmentId))) return false;
                if (!cfg.compAssignmentId || !assignmentsById.has(String(cfg.compAssignmentId))) return false;

                // Au moins un devoir (devoir1 ou devoir2)
                const devoirIds = getSelectedDevoirIds(cfg, assignmentsById);
                if (devoirIds.length === 0) return false;

                // TP si activ√©
                if (cfg.hasTp) {
                    if (!cfg.tpAssignmentId || !assignmentsById.has(String(cfg.tpAssignmentId))) return false;
                }

                return true;
            }
            function updateExportClassCardColor() {
                const card = document.getElementById('export-class-card');
                const select = document.getElementById('select-class-export');
                if (!card || !select) return;

                const classNames = Array.from(select.options).map(o => (o.value || '').trim()).filter(Boolean);
                const selected = (select.value || '').trim();

                // Par d√©faut : aucune coloration (gris)
                let state = 'none';

                if (selected) {
                    const st = getRakmanaStatusForClass(selected);
                    state = st.ready ? 'green' : (st.partialDevoir ? 'orange' : 'none');
                } else {
                    // Sans s√©lection : tu avais demand√© "vert si toutes pr√™tes sinon rien"
                    const allReady = classNames.length > 0 && classNames.every(c => getRakmanaStatusForClass(c).ready);
                    state = allReady ? 'green' : 'none';
                }

                // Reset
                card.classList.remove('bg-green-50', 'border-green-300', 'bg-amber-50', 'border-amber-300');
                card.classList.add('bg-gray-50', 'border-transparent');

                // Apply
                if (state === 'green') {
                    card.classList.remove('bg-gray-50', 'border-transparent');
                    card.classList.add('bg-green-50', 'border-green-300');
                } else if (state === 'orange') {
                    card.classList.remove('bg-gray-50', 'border-transparent');
                    card.classList.add('bg-amber-50', 'border-amber-300');
                }
            }
            function installRakmanaColorAutoUpdate() {
                const root = document.getElementById('export-config');
                if (!root) return;

                if (root.dataset.rakmanaAutoUpdateInstalled === '1') return;
                root.dataset.rakmanaAutoUpdateInstalled = '1';

                const refresh = () => requestAnimationFrame(updateExportClassCardColor);

                root.addEventListener('change', refresh);
                root.addEventListener('input', refresh);
                root.addEventListener('click', refresh);
            }
            function getRakmanaStatusForClass(className) {
                const assignmentsById = new Map((data.assignments || []).map(a => [String(a.id), a]));
                const cfg = getExportClassConfig(className);
                if (!cfg) return { ready: false, partialDevoir: false };

                // ‚úÖ Utilise les vrais noms de ta config existante
                const ccOk = !!cfg.ccAssignmentId && assignmentsById.has(String(cfg.ccAssignmentId));
                const tpOk = !!cfg.tpAssignmentId && assignmentsById.has(String(cfg.tpAssignmentId));
                const compoOk = !!cfg.compAssignmentId && assignmentsById.has(String(cfg.compAssignmentId));

                // ‚úÖ Devoirs : utilise la fonction existante qui g√®re les tableaux assignmentIds[]
                const devoirCount = getSelectedDevoirIds(cfg, assignmentsById).length;
                const hasAtLeastOneDevoir = devoirCount > 0;

                // Au moins 1 composant ‚Üí ORANGE
                const anyComponentSelected = ccOk || tpOk || compoOk || hasAtLeastOneDevoir;

                // CC + Compo + au moins 1 devoir ‚Üí VERT
                const ready = ccOk && compoOk && hasAtLeastOneDevoir;

                // Orange si partiel
                const partialDevoir = anyComponentSelected && !ready;

                return { ready, partialDevoir };
            }

            function pickDeterministic(list, seedStr) {
                const arr = (list || []).map(x => String(x || "").trim()).filter(Boolean);
                if (!arr.length) return "";
                let h = 2166136261;
                const s = String(seedStr || "");
                for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
                const idx = Math.abs(h) % arr.length;
                return arr[idx];
            }

            // Initialize
            loadData();
            initLanguage(); // Ajoutez cette ligne
            renderStudents();
            renderAssignments();
            loadExportPrepConfig();
            loadClassSelectorsForExport();
        </script>
        <!-- Input cach√© pour charger le fichier Rakmana -->
        <input type="file" id="rakmana-file-input" accept=".xlsx" style="display: none;"
            onchange="onRakmanaFileSelected(this)">
</body>

</html>